<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Jimmyâ€™s PokÃ©mon Stadium</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#0b1220" />
<link rel="icon" type="image/png" href="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png"/>
<!-- Tailwind for quick layout -->
<script src="https://cdn.tailwindcss.com"></script>
<script>tailwind.config={theme:{extend:{fontFamily:{ui:['ui-sans-serif','system-ui']}}}}</script>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--border:#1f2a44;--text:#e5e7eb}
body{background:linear-gradient(#020617,#0b1220 28%,#0f172a);color:var(--text)}
.card{background:rgba(15,23,42,.9);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:1rem}
.btn{display:inline-flex;align-items:center;justify-content:center;border-radius:.75rem;padding:.55rem 1rem;font-weight:700}
.btn-primary{background:linear-gradient(180deg,#10b981,#059669);color:#fff}
.btn-secondary{background:linear-gradient(180deg,#334155,#475569);color:#e5e7eb}
.btn-ghost{background:transparent;color:#cbd5e1;padding:.5rem .75rem;border:1px solid #334155}
.type-badge{font-size:10px;font-weight:900;padding:.125rem .5rem;border-radius:999px;color:#fff}
.grid-auto-fit{display:grid;grid-template-columns:repeat(auto-fit,minmax(88px,1fr));gap:.75rem}
.pixel{image-rendering:pixelated}
.gb-box{position:relative;background:#0b1220;border:2px solid #334155;border-radius:.75rem;box-shadow:inset 0 0 0 2px #1e293b,0 10px 40px rgba(0,0,0,.35)}
.gb-caret{font-weight:900;margin-left:.5rem;display:inline-block;animation:caret .95s steps(1,end) infinite}
@keyframes caret{0%,70%{opacity:1}85%{opacity:.1}100%{opacity:1}}
/* Canvas container */
.stage-wrap{position:relative;border:1px solid #1f2a44;border-radius:.75rem;overflow:hidden}
.stage{width:100%;display:block}
</style>
</head>
<body class="min-h-screen font-ui">
<header class="sticky top-0 z-10 bg-slate-900/80 backdrop-blur border-b border-slate-800">
  <div class="max-w-5xl mx-auto px-4 py-3">
    <div class="flex items-center gap-3">
      <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" alt class="w-6 h-6 pixel">
      <h1 class="text-lg font-extrabold leading-none">Jimmyâ€™s PokÃ©mon Stadium</h1>
    </div>
    <div class="pl-9 text-[12px] text-slate-400">Genâ€‘1 battle layout â€¢ Lv.50 â€¢ Status â€¢ All PokÃ©mon via PokÃ©API â€¢ Canvas renderer</div>
  </div>
</header>

<main class="max-w-5xl mx-auto px-4 py-4 space-y-6">
  <!-- Builder -->
  <section id="builder" class="space-y-4">
    <div class="flex items-center justify-between">
      <h2 class="text-base font-bold text-slate-300">Build your teams</h2>
      <div class="flex gap-2">
        <button id="btnRandomize" class="btn btn-secondary">Randomize teams</button>
        <button id="btnClear" class="btn btn-ghost">Clear</button>
      </div>
    </div>
    <div class="grid md:grid-cols-2 gap-4">
      <div class="card p-4">
        <div class="flex items-center gap-2 mb-3">
          <span class="text-xs text-slate-400">You</span>
          <div class="ml-auto"><button id="pickA" class="btn btn-primary">Pick</button></div>
        </div>
        <div id="teamA" class="grid grid-cols-3 gap-3"></div>
      </div>
      <div class="card p-4">
        <div class="flex items-center gap-2 mb-3">
          <span class="text-xs text-slate-400">Rival</span>
          <div class="ml-auto"><button id="pickB" class="btn btn-primary">Pick</button></div>
        </div>
        <div id="teamB" class="grid grid-cols-3 gap-3"></div>
      </div>
    </div>
    <div class="flex flex-wrap items-center gap-3 pt-2">
      <button id="startBattle" class="btn btn-secondary disabled:opacity-50" disabled>Start Battle</button>
      <div id="buildHint" class="text-sm text-slate-400">Pick 3 for each side to begin.</div>
    </div>
  </section>

  <!-- Arena -->
  <section id="arena" class="hidden space-y-3">
    <div class="flex items-center gap-2">
      <span id="roundTag" class="text-xs px-2 py-1 rounded-md bg-slate-800 border border-slate-700">Round 1</span>
      <div class="ml-auto"><button id="reset" class="btn btn-secondary">Back to builder</button></div>
    </div>

    <div class="card p-4">
      <div class="stage-wrap">
        <canvas id="stage" class="stage" height="380"></canvas>
      </div>

      <div id="turnBanner" class="gb-box mt-4 p-3 text-sm">Ready! <span id="gbCaret" class="gb-caret hidden">â–º</span></div>

      <!-- Moves -->
      <div class="mt-3 grid grid-cols-2 gap-2" id="moveButtons"></div>

      <div class="mt-2 flex items-center gap-2">
        <button id="btnSwitch" class="btn btn-secondary">PokÃ©mon</button>
      </div>

      <details class="card p-3 mt-3">
        <summary class="text-sm cursor-pointer text-slate-300">Show battle log (newest first)</summary>
        <ol id="log" class="space-y-2 text-sm max-h-80 overflow-auto pr-1 mt-2 text-slate-300"></ol>
      </details>
    </div>
  </section>
</main>

<!-- Team Picker -->
<div id="picker" class="fixed inset-0 hidden z-30">
  <div class="absolute inset-0 bg-black/50" data-close></div>
  <div class="absolute inset-x-0 bottom-0 max-h-[85vh] rounded-t-3xl bg-slate-900 p-4 space-y-3 border-t border-slate-800 flex flex-col">
    <div class="flex items-center gap-2">
      <div id="pickerLabel" class="text-xs px-2 py-1 rounded-md bg-slate-800 border border-slate-700">Pick â€” You</div>
      <input id="search" type="text" placeholder="Search PokÃ©monâ€¦" class="ml-auto w-full max-w-xs px-3 py-2 rounded-xl border border-slate-700 bg-slate-800 text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-400" />
      <button id="donePick" class="btn btn-secondary">Done</button>
    </div>

    <div class="flex items-center gap-2 flex-wrap text-[11px]">
      <span class="text-slate-400 uppercase tracking-wider">Gen</span>
      <button class="btn-ghost" data-gen="all">All</button>
      <button class="btn-ghost" data-gen="1">I</button><button class="btn-ghost" data-gen="2">II</button><button class="btn-ghost" data-gen="3">III</button>
      <button class="btn-ghost" data-gen="4">IV</button><button class="btn-ghost" data-gen="5">V</button><button class="btn-ghost" data-gen="6">VI</button>
      <button class="btn-ghost" data-gen="7">VII</button><button class="btn-ghost" data-gen="8">VIII</button><button class="btn-ghost" data-gen="9">IX</button>
    </div>
    <div class="flex items-center gap-2 flex-wrap text-[11px]">
      <span class="text-slate-400 uppercase tracking-wider">Type</span>
      <button class="btn-ghost" data-type="all">All</button>
      <button class="btn-ghost" data-type="normal">Normal</button><button class="btn-ghost" data-type="fire">Fire</button>
      <button class="btn-ghost" data-type="water">Water</button><button class="btn-ghost" data-type="electric">Electric</button>
      <button class="btn-ghost" data-type="grass">Grass</button><button class="btn-ghost" data-type="ice">Ice</button>
      <button class="btn-ghost" data-type="fighting">Fighting</button><button class="btn-ghost" data-type="poison">Poison</button>
      <button class="btn-ghost" data-type="ground">Ground</button><button class="btn-ghost" data-type="flying">Flying</button>
      <button class="btn-ghost" data-type="psychic">Psychic</button><button class="btn-ghost" data-type="bug">Bug</button>
      <button class="btn-ghost" data-type="rock">Rock</button><button class="btn-ghost" data-type="ghost">Ghost</button>
      <button class="btn-ghost" data-type="dragon">Dragon</button><button class="btn-ghost" data-type="dark">Dark</button>
      <button class="btn-ghost" data-type="steel">Steel</button><button class="btn-ghost" data-type="fairy">Fairy</button>
    </div>

    <div class="card p-3">
      <div class="flex items-center gap-3">
        <img id="pvSprite" class="w-10 h-10 pixel" alt>
        <div class="flex-1">
          <div id="pvName" class="font-bold">â€”</div>
          <div id="pvTypes" class="text-[12px] text-slate-400">â€”</div>
        </div>
        <div id="pvStats" class="text-[11px] text-slate-400 text-right"></div>
      </div>
    </div>

    <div id="pickedCount" class="text-xs text-slate-400">0 / 3 selected</div>
    <div class="flex-1 min-h-0 overflow-y-auto pr-1"><div id="grid" class="grid-auto-fit"></div></div>
  </div>
</div>

<!-- Move Picker -->
<div id="movePicker" class="fixed inset-0 z-40 hidden">
  <div class="absolute inset-0 bg-black/50" data-close-mv></div>
  <div class="absolute inset-x-0 bottom-0 max-h-[85vh] rounded-t-3xl bg-slate-900 p-4 space-y-3 border-t border-slate-800 flex flex-col">
    <div class="flex items-center gap-2">
      <div id="mvTitle" class="text-xs px-2 py-1 rounded-md bg-slate-800 border border-slate-700">Moves â€” ???</div>
      <div class="ml-auto flex items-center gap-2 text-xs">
        <label class="flex items-center gap-1 text-slate-300"><input id="fltLvl" type="checkbox" class="accent-emerald-500" checked><span>Levelâ€‘Up â‰¤50</span></label>
        <label class="flex items-center gap-1 text-slate-300"><input id="fltTM" type="checkbox" class="accent-emerald-500" checked><span>TM/HM</span></label>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <input id="mvSearch" type="text" placeholder="Search movesâ€¦" class="w-full px-3 py-2 rounded-xl border border-slate-700 bg-slate-800 text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-400" />
      <button id="mvRecommend" class="btn btn-secondary">Recommend 4</button>
      <button id="mvClear" class="btn btn-ghost">Clear</button>
      <button id="mvDone" class="btn btn-primary">Done</button>
    </div>
    <div id="mvPickedCount" class="text-xs text-slate-400">0 / 4 selected</div>
    <div class="flex-1 min-h-0 overflow-y-auto pr-1"><div id="mvList" class="space-y-2"></div></div>
  </div>
</div>

<!-- Switch Picker -->
<div id="switchPicker" class="fixed inset-0 z-40 hidden">
  <div class="absolute inset-0 bg-black/50" data-close-sw></div>
  <div class="absolute inset-x-0 bottom-0 max-h-[60vh] rounded-t-3xl bg-slate-900 p-4 space-y-3 border-t border-slate-800">
    <div class="flex items-center gap-2">
      <div class="text-xs px-2 py-1 rounded-md bg-slate-800 border border-slate-700">Switch PokÃ©mon</div>
      <div class="ml-auto text-xs text-slate-400">Switching uses your turn</div>
    </div>
    <div id="swList" class="grid grid-cols-3 sm:grid-cols-6 gap-2"></div>
    <div class="flex justify-end"><button id="swCancel" class="btn btn-ghost">Cancel</button></div>
  </div>
</div>

<script>
/* ===== Helpers & Constants ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const cap=s=>s? s.charAt(0).toUpperCase()+s.slice(1) : s;
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
const LV=50, MAX_ID=1010;
const TYPE_COLORS={normal:'#A8A77A',fire:'#EE8130',water:'#6390F0',electric:'#F7D02C',grass:'#7AC74C',ice:'#96D9D6',fighting:'#C22E28',poison:'#A33EA1',ground:'#E2BF65',flying:'#A98FF3',psychic:'#F95587',bug:'#A6B91A',rock:'#B6A136',ghost:'#735797',dragon:'#6F35FC',dark:'#705746',steel:'#B7B7CE',fairy:'#D685AD'};
const typeColor=t=>TYPE_COLORS[t]||'#64748b';
const GEN_RANGES={1:[1,151],2:[152,251],3:[252,386],4:[387,493],5:[494,649],6:[650,721],7:[722,809],8:[810,898],9:[899,1010]};
const spriteURL=id=>`https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`;
/* robust fetch with retries */
async function fetchJSON(url,{tries=5,baseDelay=300}={}){let e;for(let i=0;i<tries;i++){try{const r=await fetch(url);if(!r.ok)throw new Error('HTTP '+r.status);return await r.json()}catch(err){e=err;await sleep(baseDelay*Math.pow(2,i)+Math.random()*120)}}throw e}
/* concurrency limiter */
function pLimit(n){let a=0,q=[];const next=()=>{a--;if(q.length)q.shift()()};return fn=>new Promise((res,rej)=>{const run=async()=>{a++;try{res(await fn())}catch(e){rej(e)}finally{next()}};a<n?run():q.push(run)})}

/* Type chart (attack => defense multiplier) */
const chart={normal:{rock:.5,ghost:0},fire:{fire:.5,water:.5,grass:2,ice:2,bug:2,rock:.5,dragon:.5,steel:2},water:{fire:2,water:.5,grass:.5,ground:2,rock:2,dragon:.5},electric:{water:2,electric:.5,grass:.5,ground:0,flying:2,dragon:.5},grass:{fire:.5,water:2,grass:.5,poison:.5,ground:2,flying:.5,bug:.5,rock:2,dragon:.5,steel:.5},ice:{water:.5,ice:.5,grass:2,ground:2,flying:2,dragon:2},fighting:{normal:2,ice:2,rock:2,dark:2,steel:2,poison:.5,flying:.5,psychic:.5,bug:.5,fairy:.5,ghost:0},poison:{grass:2,fairy:2,poison:.5,ground:.5,rock:.5,ghost:.5,steel:0},ground:{fire:2,electric:2,poison:2,rock:2,steel:2,grass:.5,flying:0,bug:.5},flying:{grass:2,fighting:2,bug:2,electric:.5,rock:.5,steel:.5},psychic:{fighting:2,poison:2,psychic:.5,dark:0,steel:.5},bug:{grass:2,psychic:2,dark:2,fire:.5,fighting:.5,poison:.5,flying:.5,ghost:.5,steel:.5,fairy:.5},rock:{fire:2,ice:2,flying:2,bug:2,fighting:.5,ground:.5,steel:.5},ghost:{ghost:2,psychic:2,normal:0,dark:.5},dragon:{dragon:2,steel:.5,fairy:0},dark:{ghost:2,psychic:2,fighting:.5,dark:.5,fairy:.5},steel:{rock:2,ice:2,fairy:2,fire:.5,water:.5,electric:.5,steel:.5}};
const eff=(atk,defs)=>defs.reduce((m,t)=>m*(chart[atk]?.[t]??1),1);

/* Specials & priorities */
const RECHARGE=new Set(['hyper-beam','giga-impact']);
const SEMI_INV={'fly':{tag:'fly',msg:'flew up high!'},'dig':{tag:'dig',msg:'dug underground!'}};
const SEMI_HITS={fly:{hits:new Set(['gust','twister','thunder','hurricane']),bonus:2},dig:{hits:new Set(['earthquake','magnitude']),bonus:2}};
const PRI_P1=new Set(['quick-attack','aqua-jet','bullet-punch','ice-shard','shadow-sneak','sucker-punch']); const PRI_P2=new Set(['extreme-speed']);
const spec={ selfKO:new Set(['self-destruct','explosion']), drain50:new Set(['absorb','mega-drain','giga-drain','drain-punch','leech-life']), recoil33:new Set(['double-edge','flare-blitz','brave-bird','volt-tackle','wild-charge','wood-hammer']), recoil25:new Set(['take-down','submission']), fixed50:new Set(['seismic-toss','night-shade']), fixed40:new Set(['dragon-rage']), fixed20:new Set(['sonic-boom']), protect:new Set(['protect','detect']), sub:new Set(['substitute']), leech:new Set(['leech-seed']), destiny:new Set(['destiny-bond']) };
const AIL_MAP={paralysis:'par',burn:'brn',poison:'psn','bad-poison':'psn',freeze:'frz',sleep:'slp'};
const PAR_SPEED=.5, RESIDUAL_FRACTION=16;

/* ===== Global State ===== */
const S={ all:[], typesById:new Map(), moveCache:new Map(), mvPoolCache:new Map(),
  teamA:[], teamB:[], pickingFor:'A', tempPick:new Set(),
  mvContext:null, mvTemp:new Set(),
  rosterA:[], rosterB:[], aIdx:0, bIdx:0, round:1, waiting:true, queuedMove:null, queuedAction:null, lock:false,
  stats:{ rounds:0,dmgA:0,dmgB:0,koA:0,koB:0,statusCounts:{par:0,brn:0,psn:0,frz:0,slp:0} }
};

/* ===== Canvas Renderer ===== */
const IMG_CACHE=new Map();
function loadImg(url){ if(IMG_CACHE.has(url)) return IMG_CACHE.get(url); const img=new Image(); img.crossOrigin='anonymous'; const p=new Promise(res=>{img.onload=()=>res(img); img.onerror=()=>res(null)}); img.src=url; IMG_CACHE.set(url,p); return p; }
let C, CTX, DPR=1, stageRect={w:0,h:0};
function setupCanvas(){
  C=$('#stage'); CTX=C.getContext('2d');
  const wrap=C.parentElement.getBoundingClientRect();
  DPR = Math.max(1, Math.min(2, window.devicePixelRatio||1));
  stageRect.w = Math.floor(wrap.width);
  stageRect.h = Math.floor(Math.max(340, Math.min(440, wrap.width*0.6)));
  C.style.width = stageRect.w+'px'; C.style.height = stageRect.h+'px';
  C.width = Math.floor(stageRect.w * DPR); C.height = Math.floor(stageRect.h * DPR);
  CTX.setTransform(DPR,0,0,DPR,0,0);
  requestRender();
}
window.addEventListener('resize', setupCanvas);

/* One-shot render gate */
let needsRender=true;
function requestRender(){ needsRender=true; window.requestAnimationFrame(drawStage); }
function drawStage(){
  if(!needsRender) return; needsRender=false;
  const w=stageRect.w,h=stageRect.h, ctx=CTX; if(!ctx) return;
  // Background
  ctx.clearRect(0,0,w,h);
  const g1=ctx.createRadialGradient(w*0.2,h*0.85,20,w*0.2,h*0.85,300); g1.addColorStop(0,'rgba(255,255,255,.05)'); g1.addColorStop(1,'transparent');
  const g2=ctx.createRadialGradient(w*0.8,h*0.15,20,w*0.8,h*0.15,300); g2.addColorStop(0,'rgba(255,255,255,.05)'); g2.addColorStop(1,'transparent');
  ctx.fillStyle='#0f172a'; ctx.fillRect(0,0,w,h); ctx.fillStyle=g1; ctx.fillRect(0,0,w,h); ctx.fillStyle=g2; ctx.fillRect(0,0,w,h);

  if(!S.rosterA.length||!S.rosterB.length) return;

  const A=currA(), B=currB();
  // Positions
  const oppPos={x:w-170,y:80}, plyPos={x:20,y:h-190};
  // Sprites (semi-inv faded)
  drawMon(ctx,B.front, oppPos.x, oppPos.y, 150, B.volatile?.semiInv);
  drawMon(ctx,A.back,  plyPos.x, plyPos.y, 150, A.volatile?.semiInv);

  // HP boxes
  drawHP(ctx, oppPos.x-10, 10, B.name, B, 'right');
  drawHP(ctx, w-10, h-10-74, A.name, A, 'right'); // player bottom-right box to match GB style

  // Rosters
  drawRoster(ctx, 10, 18, S.rosterB, S.bIdx);  // top-left
  drawRoster(ctx, w-10-6*30, h-10-74+46, S.rosterA, S.aIdx); // near player box
}

function drawMon(ctx, url, x, y, size, semi){
  ctx.save();
  if(semi){ ctx.globalAlpha=0.35; ctx.filter='grayscale(40%)'; }
  ctx.fillStyle='rgba(0,0,0,.2)'; ctx.beginPath(); ctx.ellipse(x+size*.35, y+size*0.95, size*.45, size*.12,0,0,Math.PI*2); ctx.fill();
  loadImg(url).then(img=>{ if(!img) return; ctx.drawImage(img, x, y, size, size); }); // async draw; quick successive renders are fine
  ctx.restore();
}

function drawHP(ctx, x, y, name, mon, align='left'){
  const boxW=230, boxH=64; ctx.save();
  ctx.translate(x, y);
  // Frame
  ctx.fillStyle='#0b1220'; ctx.strokeStyle='#334155'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.roundRect(align==='right'?-boxW:0, 0, boxW, boxH, 8); ctx.fill(); ctx.stroke();
  ctx.strokeStyle='#1e293b'; ctx.lineWidth=2; ctx.strokeRect(align==='right'?-boxW+2:2,2,boxW-4,boxH-4);

  const offset= align==='right'?-boxW+10:10;
  // Title row
  ctx.fillStyle='#e5e7eb'; ctx.font='700 12px system-ui'; ctx.fillText(name, offset+18, 16);
  // status dot
  const dotColor = mon.status?.type==='par'?'#fbbf24':mon.status?.type==='brn'?'#f97316':mon.status?.type==='psn'?'#8b5cf6':mon.status?.type==='frz'?'#22d3ee':mon.status?.type==='slp'?'#94a3b8':'#10b981';
  ctx.fillStyle=dotColor; ctx.beginPath(); ctx.arc(offset+6,10,4,0,Math.PI*2); ctx.fill();
  // LV
  ctx.fillStyle='#e5e7eb'; ctx.font='900 11px system-ui'; ctx.fillText('Lv 50', offset+boxW-80, 16);
  // HP text & bar
  const hpTxt=`${mon.hp} / ${mon.stats.maxHP}`;
  ctx.fillStyle='#a1a1aa'; ctx.font='600 10px system-ui'; ctx.fillText('HP '+hpTxt, offset, 32);
  const pct=Math.max(0, mon.hp/mon.stats.maxHP);
  const barW=boxW-20, barH=8; const bx=offset, by=38;
  ctx.fillStyle='#1f2937'; ctx.fillRect(bx,by,barW,barH);
  const color = pct>0.5?'#22c55e':pct>0.2?'#f59e0b':'#ef4444';
  ctx.fillStyle=color; ctx.fillRect(bx,by,Math.round(barW*pct),barH);
  ctx.restore();
}

function drawRoster(ctx, x, y, roster, activeIdx){
  roster.forEach((m,i)=>{
    const px=x+i*30, py=y, s=24;
    ctx.save();
    ctx.globalAlpha = m.hp<=0 ? 0.45 : 1;
    ctx.fillStyle='#0b1220'; ctx.strokeStyle='#334155'; ctx.lineWidth=1.5;
    ctx.beginPath(); ctx.roundRect(px,py,s,s,6); ctx.fill(); ctx.stroke();
    if(i===activeIdx){ ctx.strokeStyle='#10b981'; ctx.lineWidth=2.5; ctx.strokeRect(px-2,py-2,s+4,s+4); }
    loadImg(spriteURL(m.id)).then(img=>{ if(!img) return; ctx.drawImage(img, px, py, s, s); });
    ctx.restore();
  });
}

/* ===== UI wiring ===== */
document.addEventListener('DOMContentLoaded', init);
async function init(){
  wireBuilder(); wirePickerChips(); wireArena();
  await loadAll();
  autoSeedRival(); renderTeams(); updateStartButton();
  setupCanvas();
}

/* Load names list */
async function loadAll(){
  const r=await fetchJSON(`https://pokeapi.co/api/v2/pokemon?limit=${MAX_ID}`);
  S.all=r.results.map(u=>({id:Number(u.url.split('/').filter(Boolean).pop()), name:cap(u.name)})).filter(p=>p.id>=1&&p.id<=MAX_ID);
  renderGrid();
}

/* PokÃ©mon detail + caching */
async function getPokemonDetail(id){
  const k='poke:'+id; const c=localStorage.getItem(k); if(c) return JSON.parse(c);
  const p=await fetchJSON(`https://pokeapi.co/api/v2/pokemon/${id}`);
  const out={ id, name:cap(p.name), types:p.types.sort((a,b)=>a.slot-b.slot).map(t=>t.type.name), sprites:p.sprites, stats:p.stats, moves:p.moves };
  localStorage.setItem(k, JSON.stringify(out));
  return out;
}

/* Move pool assembly */
async function assembleMovePool(movesArr){
  const pick=new Map();
  for(const m of movesArr){ const k=m.move.name;
    for(const v of m.version_group_details){
      const method=v.move_learn_method.name;
      if(method==='level-up' && v.level_learned_at<=50){ if(!pick.has(k)) pick.set(k,{name:k,flags:new Set(),level:0}); pick.get(k).flags.add('level-up'); pick.get(k).level=Math.max(pick.get(k).level,v.level_learned_at||1); }
      if(method==='machine'){ if(!pick.has(k)) pick.set(k,{name:k,flags:new Set(),level:null}); pick.get(k).flags.add('machine'); }
    }
  }
  const limit=pLimit(8), tasks=[], results=[];
  for(const {name} of pick.values()){
    const cached=S.moveCache.get(name) || JSON.parse(localStorage.getItem('mv:'+name)||'null');
    if(cached){ results.push({ok:true,name,data:cached}); continue; }
    tasks.push(limit(async()=>{ try{ const mv=await fetchJSON(`https://pokeapi.co/api/v2/move/${name}`,{tries:5,baseDelay:350}); S.moveCache.set(name,mv); localStorage.setItem('mv:'+name,JSON.stringify(mv)); results.push({ok:true,name,data:mv}); }catch(e){ results.push({ok:false,name}); } }));
  }
  if(tasks.length) await Promise.allSettled(tasks);
  const out=[];
  for(const base of pick.values()){
    const mv=S.moveCache.get(base.name) || results.find(r=>r.ok&&r.name===base.name)?.data; if(!mv) continue;
    const type=mv.type?.name; if(!TYPE_COLORS[type]) continue;
    const cat=mv.damage_class?.name || 'status', power=mv.power??null, acc=mv.accuracy??100, pr=mv.priority??0;
    const ailRaw=mv.meta?.ailment?.name || 'none', ail=AIL_MAP[ailRaw] || (ailRaw==='none'?null:ailRaw), ailC=mv.meta?.ailment_chance ?? mv.effect_chance ?? 0;
    const sc=mv.stat_changes||[], target=mv.target?.name||'selected-pokemon', healing=mv.meta?.healing ?? 0;
    out.push({key:base.name,display:base.name.replace(/-/g,' ').replace(/\b\w/g,c=>c.toUpperCase()),type,category:cat,power,accuracy:acc,method:[...base.flags][0],level:base.level||null,ailment_code:ail,ailment_chance:ailC,stat_changes:sc,target,healing,priority:pr});
  }
  return out.length?out:[{key:'tackle',display:'Tackle',type:'normal',category:'physical',power:40,accuracy:100,method:'level-up',level:1,priority:0}];
}

/* ===== Builder ===== */
function wireBuilder(){
  $('#pickA').addEventListener('click',()=>openPicker('A'));
  $('#pickB').addEventListener('click',()=>openPicker('B'));
  $('#btnClear').addEventListener('click',()=>{S.teamA=[];S.teamB=[];autoSeedRival();renderTeams();updateStartButton()});
  $('#btnRandomize').addEventListener('click',()=>{const ids=S.all.map(p=>p.id); shuffle(ids); S.teamA=ids.slice(0,3).map(id=>({id,name:nameFor(id)})); S.teamB=ids.slice(3,6).map(id=>({id,name:nameFor(id)})); renderTeams(); updateStartButton();});
  $('#startBattle').addEventListener('click',startBattle);
}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function nameFor(id){const p=S.all.find(x=>x.id===id);return p?p.name:`#${id}`}
function renderTeams(){
  const slot=(teamKey,p)=>`
  <div class="card p-2 flex flex-col items-center">
    <img src="${spriteURL(p.id)}" class="w-16 h-16 pixel" alt="${p.name}">
    <div class="text-xs mt-1 text-center">${p.name}</div>
    <div class="mt-2 flex items-center gap-2">
      <button class="btn-ghost text-xs" data-mv>Edit Moves</button>
      <button class="btn-ghost text-xs text-rose-400" data-remove>Remove</button>
    </div>
    <div class="mt-2 flex flex-wrap gap-1 justify-center">${(p.moves||[]).map(m=>`<span class="type-badge" style="background:${typeColor(m.type)}">${m.type.toUpperCase()}</span><span class="text-[11px]">${m.display}</span>`).join(' ')||'<span class="text-[10px] text-slate-400">No moves chosen</span>'}</div>
  </div>`;
  const filler=`<div class="rounded-2xl border border-dashed border-slate-700 h-24 flex items-center justify-center text-slate-500 text-xs">Empty</div>`;
  const mount=(el,key)=>{el.innerHTML='';const t=S[key];t.forEach((p,i)=>{const wrap=document.createElement('div');wrap.innerHTML=slot(key,p);wrap.querySelector('[data-remove]').addEventListener('click',()=>{t.splice(i,1);renderTeams();updateStartButton()});wrap.querySelector('[data-mv]').addEventListener('click',()=>openMovePicker(key==='teamA'?'A':'B',p.id,p.name));el.appendChild(wrap.firstElementChild)});for(let i=t.length;i<3;i++){const d=document.createElement('div');d.innerHTML=filler;el.appendChild(d.firstElementChild)}};
  mount($('#teamA'),'teamA'); mount($('#teamB'),'teamB'); updateStartButton();
}
function updateStartButton(){const ok=S.teamA.length===3 && S.teamB.length===3;$('#startBattle').disabled=!ok;$('#buildHint').textContent=ok?'Optionally edit moves, then Start Battle.':'Pick 3 for each side to begin.'}
function autoSeedRival(){if(!S.all.length)return;const ids=S.all.map(p=>p.id);shuffle(ids);S.teamB=ids.slice(0,3).map(id=>({id,name:nameFor(id)}))}

/* ===== Picker ===== */
function wirePickerChips(){
  $$('[data-gen]').forEach(b=>b.addEventListener('click',()=>{const val=b.getAttribute('data-gen');S.gen=S.gen||new Set(['all']); if(val==='all'){S.gen=new Set(['all'])}else{if(S.gen.has('all'))S.gen.delete('all'); S.gen.has(val)?S.gen.delete(val):S.gen.add(val); if(S.gen.size===0)S.gen.add('all')} filterGrid($('#search').value.toLowerCase())}));
  $$('[data-type]').forEach(b=>b.addEventListener('click',()=>{const val=b.getAttribute('data-type');S.ty=S.ty||new Set(['all']); if(val==='all'){S.ty=new Set(['all'])}else{if(S.ty.has('all'))S.ty.delete('all'); S.ty.has(val)?S.ty.delete(val):S.ty.add(val); if(S.ty.size===0)S.ty.add('all')} filterGrid($('#search').value.toLowerCase())}));
}
function openPicker(side){ S.pickingFor=side; S.tempPick=new Set((side==='A'?S.teamA:S.teamB).map(p=>p.id)); $('#pickerLabel').textContent=`Pick â€” ${side==='A'?'You':'Rival'}`; $('#pickedCount').textContent=`${S.tempPick.size} / 3 selected`; $('#picker').classList.remove('hidden'); $('#search').value=''; if(!$('#grid').children.length) renderGrid(); }
function closePicker(commit=false){ if(commit){ const list=Array.from(S.tempPick).slice(0,3).map(id=>{const exist=(S.pickingFor==='A'?S.teamA:S.teamB).find(x=>x.id===id); return exist?exist:({id,name:nameFor(id)});}); if(S.pickingFor==='A')S.teamA=list; else S.teamB=list; renderTeams(); updateStartButton(); } $('#picker').classList.add('hidden'); }
$('#donePick').addEventListener('click',()=>closePicker(true));
$('#picker').addEventListener('click',e=>{if(e.target.hasAttribute('data-close')) closePicker(false)});
$('#search').addEventListener('input',e=>filterGrid(e.target.value.toLowerCase()));

function renderGrid(){
  const grid=$('#grid'); grid.innerHTML='';
  S.all.forEach(p=>{
    const card=document.createElement('button');
    card.className='rounded-2xl border border-slate-700 bg-slate-800 p-2 flex flex-col items-center hover:border-emerald-400 focus:outline-none';
    card.setAttribute('data-id',p.id);
    card.innerHTML=`<img src="${spriteURL(p.id)}" class="w-14 h-14 pixel" alt="${p.name}"><div class="text-[11px] mt-1">${String(p.id).padStart(3,'0')} â€¢ ${p.name}</div>`;
    const id=p.id;
    card.addEventListener('click',()=>{toggleTempPick(id,card); showPreview(id);});
    card.addEventListener('mouseover',()=>showPreview(id));
    grid.appendChild(card);
  });
}
function toggleTempPick(id,el){ if(S.tempPick.has(id)) S.tempPick.delete(id); else { if(S.tempPick.size>=3) return; S.tempPick.add(id); } $('#pickedCount').textContent=`${S.tempPick.size} / 3 selected`; el.style.borderColor=S.tempPick.has(id)?'#10b981':'#334155' }
function filterGrid(q){
  $$('#grid [data-id]').forEach(el=>{
    const id=Number(el.getAttribute('data-id')); const name=nameFor(id).toLowerCase();
    let match=!q||name.includes(q)||String(id).padStart(3,'0').includes(q);
    if(match && S.gen && !S.gen.has('all')) match=[...S.gen].some(g=>{const [lo,hi]=GEN_RANGES[g];return id>=lo&&id<=hi});
    if(match && S.ty && !S.ty.has('all')){ const ty=S.typesById.get(id); match=Array.isArray(ty) ? [...S.ty].some(t=>ty.includes(t)) : match; if(!ty && match) preloadType(id); }
    el.classList.toggle('hidden',!match);
  });
}
async function preloadType(id){ try{ const d=await getPokemonDetail(id); S.typesById.set(id,d.types);}catch{} }
async function showPreview(id){
  const nameEl=$('#pvName'), typesEl=$('#pvTypes'), imgEl=$('#pvSprite'), statsEl=$('#pvStats');
  nameEl.textContent='Loadingâ€¦'; typesEl.textContent='Fetchingâ€¦'; imgEl.src=spriteURL(id); statsEl.textContent='';
  try{
    const p=await getPokemonDetail(id);
    nameEl.textContent=cap(p.name); imgEl.src=spriteURL(id);
    const types=p.types||[]; S.typesById.set(id,types);
    typesEl.innerHTML=types.map(t=>`<span class="type-badge" style="background:${typeColor(t)}">${t.toUpperCase()}</span>`).join(' ');
    const get=k=>p.stats?.find(s=>s.stat?.name===k)?.base_stat??50;
    const base={hp:get('hp'),atk:get('attack'),def:get('defense'),spa:get('special-attack'),spd:get('special-defense'),spe:get('speed')};
    const lv50=deriveLv50(base); statsEl.textContent=`HP ${lv50.maxHP} â€¢ Atk ${lv50.atk} â€¢ Def ${lv50.def} â€¢ SpA ${lv50.spa} â€¢ SpD ${lv50.spd} â€¢ Spe ${lv50.spe}`;
  }catch(e){ nameEl.textContent=`#${String(id).padStart(3,'0')}`; typesEl.textContent='Failed to load'; }
}

/* ===== Move Picker ===== */
async function openMovePicker(team,id,name){
  $('#mvTitle').textContent=`Moves â€” ${name} (${team==='A'?'You':'Rival'})`;
  $('#mvPickedCount').textContent='0 / 4 selected';
  $('#mvSearch').value=''; $('#fltLvl').checked=true; $('#fltTM').checked=true;
  S.mvContext={team,id,name,types:null}; $('#movePicker').classList.remove('hidden');
  $('#mvList').innerHTML='<div class="text-sm text-slate-400">Loading movesâ€¦</div>';
  const detail=await getPokemonDetail(id); S.mvContext.types=detail.types;
  let pool=S.mvPoolCache.get(id)||await assembleMovePool(detail.moves); if(pool.length>200) pool=pool.slice(0,200); S.mvPoolCache.set(id,pool);
  const entry=(team==='A'?S.teamA:S.teamB).find(x=>x.id===id); S.mvTemp=new Set((entry?.moves||[]).map(m=>m.key));
  renderMoveList();
}
function closeMovePicker(commit=false){
  if(commit){ const t=S.mvContext.team==='A'?S.teamA:S.teamB; const e=t.find(x=>x.id===S.mvContext.id); if(e){ const pool=S.mvPoolCache.get(S.mvContext.id)||[]; const byKey=new Map(pool.map(x=>[x.key,x])); e.moves=Array.from(S.mvTemp).slice(0,4).map(k=>byKey.get(k)).filter(Boolean); renderTeams(); } }
  $('#movePicker').classList.add('hidden'); S.mvContext=null; S.mvTemp=new Set();
}
document.addEventListener('click',e=>{ if(e.target.hasAttribute?.('data-close-mv')) closeMovePicker(false); });
$('#mvDone').addEventListener('click',()=>closeMovePicker(true));
$('#mvClear').addEventListener('click',()=>{S.mvTemp.clear();renderMoveList()});
$('#mvRecommend').addEventListener('click',()=>{ const pool=getFilteredPool(); const picks=recommend(pool,S.mvContext.types).slice(0,4).map(m=>m.key); S.mvTemp=new Set(picks); renderMoveList();});
$('#mvSearch').addEventListener('input',renderMoveList); $('#fltLvl').addEventListener('change',renderMoveList); $('#fltTM').addEventListener('change',renderMoveList);

function getFilteredPool(){ const pool=S.mvPoolCache.get(S.mvContext.id)||[]; const L=$('#fltLvl').checked, M=$('#fltTM').checked; return pool.filter(m=>(m.method==='level-up'&&L)||(m.method==='machine'&&M)) }
function renderMoveList(){
  const list=$('#mvList'); list.innerHTML=''; const q=$('#mvSearch').value.trim().toLowerCase(); const types=S.mvContext.types||[];
  const filtered=getFilteredPool().filter(m=>!q||m.display.toLowerCase().includes(q)||m.type.includes(q));
  filtered.sort((a,b)=>{const stabA=types.includes(a.type)?1:0, stabB=types.includes(b.type)?1:0; const catA=a.category==='status'?-1:1, catB=b.category==='status'?-1:1; return (stabB-stabA)||(catB-catA)||((b.power||0)-(a.power||0))||((b.level||0)-(a.level||0))});
  for(const m of filtered){
    const picked=S.mvTemp.has(m.key);
    const row=document.createElement('button');
    row.className='w-full border border-slate-700 rounded-xl p-2 flex items-center gap-3 bg-slate-800';
    row.style.boxShadow=picked?'0 0 0 3px rgba(16,185,129,.20)':'none';
    const ail=m.ailment_code?` â€¢ ${m.ailment_code.toUpperCase()}${m.ailment_chance?(' '+m.ailment_chance+'%'):''}`:'';
    const extra=(m.stat_changes?.length?' â€¢ Stat':'')+(m.healing?' â€¢ Heal':'')+(m.priority?` â€¢ Prio ${m.priority}`:'');
    row.innerHTML=`<span class="type-badge" style="background:${typeColor(m.type)}">${m.type.toUpperCase()}</span>
    <div class="flex-1 text-left"><div class="font-bold">${m.display}</div>
    <div class="text-[11px] text-slate-400">${m.category==='status'?'Status':('Pow '+(m.power??'â€”'))} â€¢ Acc ${m.accuracy??'â€”'}% â€¢ ${cap(m.category)}${ail}${extra}</div></div>
    <div class="text-[11px] px-2 py-1 rounded-md ${picked?'bg-emerald-100 text-emerald-700':'bg-slate-700 text-slate-200'}">${picked?'Selected':'Select'}</div>`;
    row.addEventListener('click',()=>{ if(picked){S.mvTemp.delete(m.key)}else{ if(S.mvTemp.size>=4){toast('Max 4 moves');return} S.mvTemp.add(m.key);} $('#mvPickedCount').textContent=`${S.mvTemp.size} / 4 selected`; renderMoveList(); });
    list.appendChild(row);
  }
  $('#mvPickedCount').textContent=`${S.mvTemp.size} / 4 selected`;
}
function recommend(pool,types=[]){ const scored=pool.map(m=>{const stab=types.includes(m.type)?1.5:1, base=m.category==='status'?(40+(m.ailment_code?20:0)+(m.stat_changes?.length?25:0)+(m.healing?30:0)):(m.power||0)*stab; return {s:base+((m.level||0)/5)+(m.method==='level-up'?1:0),m}}); scored.sort((a,b)=>b.s-a.s); const seen=new Set(),p=[]; for(const s of scored){ if(!seen.has(s.m.key)){seen.add(s.m.key); p.push(s.m);} if(p.length>=4)break; } return p.length?p:[{key:'tackle',display:'Tackle',type:'normal',category:'physical',power:40,accuracy:100}]}

/* ===== Arena & Engine ===== */
function wireArena(){
  $('#reset').addEventListener('click',()=>{$('#arena').classList.add('hidden');$('#builder').classList.remove('hidden');clearLog()});
  $('#btnSwitch').addEventListener('click',()=>{ if(S.lock || !S.waiting) return; openSwitchPicker(); });
  $('#switchPicker').addEventListener('click',e=>{ if(e.target.hasAttribute('data-close-sw')) closeSwitchPicker(); });
  $('#swCancel').addEventListener('click',closeSwitchPicker);
}
function clearLog(){ $('#log').innerHTML=''; }
function log(t){ const li=document.createElement('li'); li.textContent=t; const list=$('#log'); if(list.firstChild) list.insertBefore(li,list.firstChild); else list.appendChild(li); }
function setBanner(text,mode='info'){ const b=$('#turnBanner'), c=$('#gbCaret'); b.textContent=text+' '; b.appendChild(c); if(mode==='your') c.classList.remove('hidden'); else c.classList.add('hidden'); }

async function startBattle(){
  $('#builder').classList.add('hidden'); $('#arena').classList.remove('hidden'); clearLog();
  S.stats={rounds:0,dmgA:0,dmgB:0,koA:0,koB:0,statusCounts:{par:0,brn:0,psn:0,frz:0,slp:0}};
  S.rosterA=[]; S.rosterB=[]; S.aIdx=0; S.bIdx=0; S.round=1; S.waiting=true; S.queuedMove=null; S.queuedAction=null; S.lock=false;

  const all=[...S.teamA,...S.teamB];
  const details=await Promise.all(all.map(async p=>{
    const d=await getPokemonDetail(p.id);
    const gs=k=>d.stats.find(s=>s.stat.name===k).base_stat;
    const base={hp:gs('hp'),atk:gs('attack'),def:gs('defense'),spa:gs('special-attack'),spd:gs('special-defense'),spe:gs('speed')};
    const derived=deriveLv50(base);
    const types=d.types; S.typesById.set(p.id,types);
    const pool=S.mvPoolCache.get(p.id)||await assembleMovePool(d.moves); S.mvPoolCache.set(p.id,pool);
    const moves=(p.moves&&p.moves.length?p.moves:recommend(pool,types).slice(0,4));
    return { id:p.id, name:cap(d.name), types, front:d.sprites.front_default||spriteURL(p.id), back:d.sprites.back_default||d.sprites.front_default||spriteURL(p.id), base, stats:{...derived}, stages:{atk:0,def:0,spa:0,spd:0,spe:0}, hp:derived.maxHP, moves, status:null, volatile:{} };
  }));
  S.rosterA=details.slice(0,3); S.rosterB=details.slice(3,6);

  setActiveDisplays();
  renderMoveButtons();
  setBanner(`Your turn â€” choose a move for ${currA().name}.`,'your');
}

const currA=()=>S.rosterA[S.aIdx], currB=()=>S.rosterB[S.bIdx];

function setActiveDisplays(){ S.waiting=true; $('#roundTag').textContent=`Round ${S.round}`; renderMoveButtons(); requestRender(); }
function renderMoveButtons(){
  const A=currA(); const box=$('#moveButtons'); box.innerHTML='';
  A.moves.forEach(m=>{
    const btn=document.createElement('button');
    btn.className='btn w-full'; btn.style.background=`linear-gradient(180deg, ${typeColor(m.type)}, #1f2937)`; btn.style.color='#fff';
    const ail=m.ailment_code?` â€¢ ${m.ailment_code.toUpperCase()}${m.ailment_chance?(' '+m.ailment_chance+'%'):''}`:'';
    const extra=(m.stat_changes?.length?' â€¢ Stat':'')+(m.healing?' â€¢ Heal':'')+(m.priority?` â€¢ Prio ${m.priority}`:'');
    btn.innerHTML=`<div class="flex-1 text-left">
      <div class="font-extrabold">${m.display}</div>
      <div class="text-[10px] opacity-90">${m.category==='status'?'Status':('Pow '+(m.power??'â€”'))} â€¢ Acc ${m.accuracy??'â€”'}% â€¢ ${cap(m.category)}${ail}${extra}</div>
    </div><span class="type-badge" style="background:${typeColor(m.type)}">${m.type.toUpperCase()}</span>`;
    btn.addEventListener('click',()=>{ if(S.lock || !S.waiting) return; S.queuedMove=m; takeTurn(); });
    box.appendChild(btn);
  });
}

/* Core math */
function deriveLv50(base){ const hp=Math.floor(((2*base.hp)*LV)/100)+LV+10; const atk=Math.floor(((2*base.atk)*LV)/100)+5; const def=Math.floor(((2*base.def)*LV)/100)+5; const spa=Math.floor(((2*base.spa)*LV)/100)+5; const spd=Math.floor(((2*base.spd)*LV)/100)+5; const spe=Math.floor(((2*base.spe)*LV)/100)+5; return {maxHP:hp,atk,def,spa,spd,spe}; }
function stage(val,st){ if(st===0) return val; if(st>0) return Math.floor(val*(2+st)/2); return Math.floor(val*2/(2-st)); }
function priority(m){ if(typeof m.priority==='number') return m.priority; const k=(m.key||'').toLowerCase(); return PRI_P2.has(k)?2:PRI_P1.has(k)?1:0; }
function estimateDamage(a,d,m){
  const k=(m.key||'').toLowerCase();
  if(spec.fixed50.has(k)) return LV; if(spec.fixed40.has(k)) return 40; if(spec.fixed20.has(k)) return 20;
  let A=m.category==='physical'? a.stats.atk : a.stats.spa;
  let D=m.category==='physical'? d.stats.def : d.stats.spd;
  A=stage(A, m.category==='physical'? a.stages.atk : a.stages.spa);
  D=stage(D, m.category==='physical'? d.stages.def : d.stages.spd);
  if(m.category==='physical' && a.status?.type==='brn') A=Math.floor(A*.5);
  const base=(((2*LV/5+2)*(m.power||0)*(A/Math.max(1,D)))/50)+2;
  const stab=a.types.includes(m.type)?1.5:1, e=eff(m.type,d.types); const roll=(Math.random()*.15)+.85;
  return Math.max(1,Math.floor(base*stab*e*.925*roll));
}
function effScore(move,atkTypes,defTypes){ const e=eff(move.type,defTypes); let s=0;if(e===0)s-=60; else if(e<1)s-=(1-e)*40; else if(e>1)s+=(e-1)*55; if(atkTypes.includes(move.type)) s+=18; return s;}
function koScore(dmg,hp){const f=dmg/Math.max(1,hp); return f>=1?120:Math.floor(f*90)}
function bestMove(att,def){ let best=att.moves[0], score=-1e9; for(const m of att.moves){ let s=0; if(m.category==='status'){ s=(m.ailment_code?35:10)+(m.healing?22:0)+((m.stat_changes?.length||0)*6); } else { const dmg=estimateDamage(att,def,m); s+=dmg + effScore(m,att.types,def.types) + koScore(dmg,def.hp) + (m.accuracy??100)*.12; } s+=priority(m)*6; if(s>score){score=s; best=m;} } return best; }

/* Turn flow */
async function takeTurn(){
  if(S.lock) return; S.lock=true; if(!S.queuedMove){ toast('Choose a move'); S.lock=false; return; }
  const A=currA(), B=currB();
  const cpuMove=bestMove(B,A);

  // Order by priority then speed (no ties)
  const order=[{side:'A',move:S.queuedMove},{side:'B',move:cpuMove}];
  const pA=priority(order[0].move), pB=priority(order[1].move);
  if(pA!==pB) order.sort((x,y)=>priority(x.move)>priority(y.move)?-1:1);
  else { const aSpd=A.stats.spe, bSpd=B.stats.spe; if(bSpd>aSpd || (bSpd===aSpd && Math.random()<.5)) order.reverse(); }

  for(const step of order){
    if(!alive()) break;
    const atk=step.side==='A'?currA():currB(), def=step.side==='A'?currB():currA();
    await act(step.side, atk, def, step.move);
  }

  if(alive()){
    endResidual(currA(),'A'); endResidual(currB(),'B');
    S.round++; $('#roundTag').textContent=`Round ${S.round}`;
    S.waiting=true; setBanner(`Your turn â€” choose a move for ${currA().name}.`,'your');
    requestRender();
  }else{
    setBanner(S.rosterA.some(m=>m.hp>0)?'ðŸ† You win!':'ðŸ† Rival wins!', S.rosterA.some(m=>m.hp>0)?'your':'rival');
    requestRender();
  }
  S.queuedMove=null; S.lock=false;
}

async function act(side, atk, def, move){
  if(atk.hp<=0 || def.hp<=0) return;

  // Preâ€‘move statuses
  if(atk.volatile?.recharge){ atk.volatile.recharge=0; log(`${atk.name} must recharge!`); await sleep(250); return; }
  if(atk.status?.type==='slp'){ log(`${atk.name} is fast asleepâ€¦`); await sleep(250); return; }
  if(atk.status?.type==='frz'){ if(Math.random()<.2){ log(`${atk.name} thawed out!`); atk.status=null; } else { log(`${atk.name} is frozen solid!`); await sleep(250); return; } }
  if(atk.status?.type==='par' && Math.random()<.25){ log(`${atk.name} is fully paralyzed!`); await sleep(250); return; }

  setBanner(`${atk.name} used ${move.display}!`, side==='A'?'your':'rival');

  // Charging & semiâ€‘inv
  const key=(move.key||'').toLowerCase();
  if(atk.volatile?.charging){
    move=atk.volatile.charging; delete atk.volatile.charging;
    if(atk.volatile.semiInv){ delete atk.volatile.semiInv; requestRender(); }
  } else if(SEMI_INV[key]){
    atk.volatile.charging=move; atk.volatile.semiInv=SEMI_INV[key].tag; log(`${atk.name} ${SEMI_INV[key].msg}`); requestRender(); await sleep(300); return;
  } else if(key==='solar-beam'||key==='sky-attack'||key==='razor-wind'){
    atk.volatile.charging=move; log(`${atk.name} is charging ${move.display}!`); await sleep(300); return;
  }

  // Protect/Sub/Leech
  if(spec.protect.has(key)){ atk.volatile.protect=true; log(`${atk.name} protected itself!`); await sleep(200); return; }
  if(spec.sub.has(key)){
    if(atk.volatile.subHP>0){ log('But it failed!'); return;}
    const cost=Math.floor(atk.stats.maxHP/4); if(atk.hp<=cost){ log('Not enough HP!'); return;}
    atk.hp-=cost; atk.volatile.subHP=cost; requestRender(); log(`${atk.name} put in a Substitute!`); await sleep(200); return;
  }
  if(spec.leech.has(key)){
    if(def.types.includes('grass')||def.volatile.leech){ log('But it failed!'); return; }
    if(Math.random()*100>(move.accuracy??90)){ log('Leech Seed missed!'); return; }
    def.volatile.leech={from:side}; log(`${def.name} was seeded!`); await sleep(200); return;
  }

  // Accuracy & semiâ€‘inv auto-miss
  const autoMiss = def.volatile?.semiInv && !(SEMI_HITS[def.volatile.semiInv]?.hits.has(key));
  if(autoMiss || Math.random()*100>(move.accuracy??100)){ log(`${atk.name}'s ${move.display} missed!`); await sleep(200); return; }

  // Status-only move effects
  if(move.category==='status' && (!move.power||move.power===0) && (move.ailment_code || (move.stat_changes&&move.stat_changes.length) || move.healing)){
    if(def.volatile?.subHP && (move.ailment_code || (move.stat_changes||[]).some(s=>s.change<0))){ log(`Substitute blocked the effect!`); return; }
    const done = await applyStatusMove(atk,def,move,side);
    if(!done) log('But it failed!');
    requestRender(); return;
  }

  // Damage
  let hits=1, effBonus=1;
  if(def.volatile?.semiInv){ const t=def.volatile.semiInv; const counters=SEMI_HITS[t]; if(counters?.hits.has(key)) effBonus=counters.bonus||1; }
  if(['double-slap','fury-attack','fury-swipes','bullet-seed','icicle-spear','pin-missile','rock-blast','arm-thrust'].includes(key)){ const r=Math.random(); hits=r<0.35?2:r<0.70?3:r<0.85?4:5; }
  if(['bonemerang','dual-chop','twineedle'].includes(key)) hits=2;

  let landed=0, total=0;
  for(let i=0;i<hits;i++){ if(Math.random()*100 <= (move.accuracy??100)){ landed++; total+=Math.floor(estimateDamage(atk,def,move)*(effBonus)); } }
  if(landed===0){ log(`${atk.name}'s ${move.display} missed!`); await sleep(200); return; }

  const crit = Math.random()<.1;
  if(crit) total=Math.floor(total*1.75);

  // Apply damage or to Substitute
  if(def.volatile?.subHP){
    const before=def.volatile.subHP; def.volatile.subHP=Math.max(0,def.volatile.subHP-total);
    log(`The Substitute took ${Math.min(before,total)} damage.`); if(def.volatile.subHP<=0){ delete def.volatile.subHP; log(`The Substitute broke!`); }
  }else{
    def.hp=Math.max(0, def.hp-total); if(side==='A') S.stats.dmgA+=total; else S.stats.dmgB+=total;
    log(`${atk.name} dealt ${total}${hits>1?` (${hits} hits)`:''} to ${def.name}.${crit?' Critical hit!':''}`);
  }
  requestRender();
  await sleep(250);

  // Secondary: ailment
  if(def.hp>0 && move.ailment_code && Math.random()*100 <= (move.ailment_chance||0)){
    if(!def.status) { def.status={type:move.ailment_code}; S.stats.statusCounts[move.ailment_code]=(S.stats.statusCounts[move.ailment_code]||0)+1; log(`${def.name} is now ${move.ailment_code.toUpperCase()}!`); requestRender(); await sleep(150); }
  }

  // Drain / recoil / self-KO
  if(spec.drain50.has(key) && total>0 && atk.hp>0){
    const heal=Math.max(1,Math.floor(total*0.5)); const before=atk.hp; atk.hp=Math.min(atk.stats.maxHP, atk.hp+heal); if(atk.hp>before){ log(`${atk.name} drained ${atk.hp-before} HP!`); requestRender(); await sleep(140); }
  }
  if(spec.recoil33.has(key) && total>0){ const recoil=Math.max(1,Math.floor(total/3)); atk.hp=Math.max(0,atk.hp-recoil); log(`${atk.name} is hit with recoil (${recoil}).`); requestRender(); await sleep(120); }
  if(spec.recoil25.has(key) && total>0){ const recoil=Math.max(1,Math.floor(total/4)); atk.hp=Math.max(0,atk.hp-recoil); log(`${atk.name} is hit with recoil (${recoil}).`); requestRender(); await sleep(120); }
  if(spec.selfKO.has(key)){ atk.hp=0; log(`${atk.name} fainted from ${move.display}!`); requestRender(); await sleep(140); }

  // Destiny Bond handling (simple): if defender fainted this step and had destinyBond flag, attacker faints too
  if(def.hp<=0 && def.volatile?.destinyBond){ atk.hp=0; log(`${def.name} took ${atk.name} down with it!`); requestRender(); await sleep(140); }

  // Faints & send next
  if(def.hp<=0){
    if(side==='A') S.stats.koA++; else S.stats.koB++;
    const nextIdx = (side==='A') ? S.rosterB.findIndex((m,i)=>i>S.bIdx&&m.hp>0) : S.rosterA.findIndex((m,i)=>i>S.aIdx&&m.hp>0);
    if(side==='A'){ if(nextIdx!==-1) S.bIdx=nextIdx; } else { if(nextIdx!==-1) S.aIdx=nextIdx; }
    requestRender(); await sleep(250);
  }
  if(atk.hp<=0){
    if(side==='A') S.stats.koB++; else S.stats.koA++;
    const nextIdx = (side==='A') ? S.rosterA.findIndex((m,i)=>i>S.aIdx&&m.hp>0) : S.rosterB.findIndex((m,i)=>i>S.bIdx&&m.hp>0);
    if(side==='A'){ if(nextIdx!==-1) S.aIdx=nextIdx; } else { if(nextIdx!==-1) S.bIdx=nextIdx; }
    requestRender(); await sleep(250);
  }

  if(RECHARGE.has(key) && atk.hp>0){ atk.volatile.recharge=1; }
}

function alive(){ return S.rosterA.some(m=>m.hp>0) && S.rosterB.some(m=>m.hp>0); }
function endResidual(mon, side){
  if(mon.hp<=0) return;
  if(mon.status?.type==='brn' || mon.status?.type==='psn'){
    const dmg=Math.max(1,Math.floor(mon.stats.maxHP/RESIDUAL_FRACTION)); mon.hp=Math.max(0,mon.hp-dmg); log(`${mon.name} is hurt by ${mon.status.type==='brn'?'its burn':'poison'} (${dmg}).`);
  }
  if(mon.volatile?.leech){
    const dmg=Math.max(1,Math.floor(mon.stats.maxHP/8)); mon.hp=Math.max(0,mon.hp-dmg);
    const other = side==='A'?currB():currA(); if(other?.hp>0){ other.hp=Math.min(other.stats.maxHP, other.hp+dmg); }
    log(`${mon.name} had its energy drained (${dmg}).`);
  }
  requestRender();
}

/* Switch picker */
function openSwitchPicker(){
  const list=$('#swList'); list.innerHTML='';
  S.rosterA.forEach((mon,i)=>{
    const disabled=(i===S.aIdx)||mon.hp<=0;
    const btn=document.createElement('button');
    btn.className='border border-slate-700 rounded-xl p-2 bg-slate-800 flex flex-col items-center'; btn.disabled=disabled; btn.style.opacity=disabled?'.5':'1';
    btn.innerHTML=`<img src="${spriteURL(mon.id)}" class="w-12 h-12 pixel"/><div class="mt-1 text-[11px]">${mon.name}</div>`;
    btn.addEventListener('click', async ()=>{ if(disabled) return; S.queuedAction={type:'switch',to:i}; closeSwitchPicker(); await performSwitch('A',i); S.waiting=false; await takeTurn(); });
    list.appendChild(btn);
  });
  $('#switchPicker').classList.remove('hidden');
}
function closeSwitchPicker(){ $('#switchPicker').classList.add('hidden'); }
async function performSwitch(side,toIndex){
  const isPlayer=side==='A';
  const outMon=isPlayer?currA():currB();
  if(outMon?.volatile?.semiInv){ delete outMon.volatile.semiInv; delete outMon.volatile.charging; }
  log(isPlayer?`${outMon.name}, come back!`:`${outMon.name} was withdrawn!`);
  if(isPlayer) S.aIdx=toIndex; else S.bIdx=toIndex;
  const inMon=isPlayer?currA():currB(); inMon.volatile=inMon.volatile||{}; delete inMon.volatile.semiInv; delete inMon.volatile.charging;
  log(isPlayer?`Go, ${inMon.name}!`:`Foe sent out ${inMon.name}!`);
  requestRender(); await sleep(200);
}

/* Misc UI */
let toastTimer; function toast(msg){ clearTimeout(toastTimer); let t=$('#toast'); if(!t){ t=document.createElement('div'); t.id='toast'; t.className='fixed bottom-3 inset-x-0 mx-auto w-fit max-w-[90%] px-4 py-2 rounded-xl bg-slate-800 text-slate-100 border border-slate-700 text-sm shadow-lg'; document.body.appendChild(t); } t.textContent=msg; t.style.opacity='1'; toastTimer=setTimeout(()=>t.style.opacity='0',1600); }

</script>
</body>
</html>
