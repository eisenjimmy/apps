<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Jimmy’s Pokémon Stadium</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<link rel="icon" type="image/png" href="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png"/>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config={theme:{extend:{fontFamily:{ui:['ui-sans-serif','system-ui']}}}}
</script>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--border:#1f2a44;--text:#e5e7eb}
*{box-sizing:border-box}
body{background:linear-gradient(#020617,#0b1220 28%,#0f172a);color:var(--text)}
.card{background:rgba(15,23,42,.92);backdrop-filter:blur(8px);border:1px solid var(--border);border-radius:1rem}
.btn{display:inline-flex;align-items:center;justify-content:center;border-radius:.75rem;padding:.55rem 1rem;font-weight:700}
.btn-primary{background:linear-gradient(180deg,#10b981,#059669);color:#fff}
.btn-secondary{background:linear-gradient(180deg,#334155,#475569);color:#e5e7eb}
.btn-ghost{background:transparent;color:#cbd5e1;padding:.5rem .75rem;border:1px solid #334155}
.btn-chip{padding:.28rem .5rem;font-size:11px;font-weight:700;border-radius:999px;border:1px solid #334155;background:#0b1220;color:#cbd5e1}
.btn-chip:hover{border-color:#10b981;color:#eaffef}
.pixel{image-rendering:pixelated}
.type-badge{font-size:10px;font-weight:900;padding:.125rem .5rem;border-radius:999px;color:#fff}

/* ===== Game Boy battle layout (HTML-only) ===== */
.battle-wrap{border:1px solid #1f2a44;border-radius:1rem;background:#081022;padding:.75rem}
.field{position:relative;min-height:360px}
.side{position:absolute;display:flex;gap:.75rem;align-items:flex-start}
.side.enemy{top:.5rem;right:.5rem;flex-direction:row-reverse}
.side.player{bottom:.5rem;left:.5rem;flex-direction:row}
.mon{display:flex;flex-direction:column;align-items:center;min-width:96px}
.mon img{width:120px;height:120px}
.hpbox{width:240px;max-width:62vw;background:#0b1220;border:2px solid #334155;border-radius:.75rem;box-shadow:inset 0 0 0 2px #1e293b}
.hp-head{display:flex;align-items:center;justify-content:space-between;padding:.35rem .5rem}
.hp-name{display:flex;align-items:center;gap:.4rem}
.dot{width:8px;height:8px;border-radius:999px;display:inline-block}
.hpbar{height:8px;background:#1f2937;border-radius:6px;overflow:hidden;margin:0 .5rem .4rem}
.hpfill{height:100%}
.subrow{display:flex;align-items:center;justify-content:space-between;padding:0 .5rem .45rem}
.pips{display:flex;gap:.35rem}
.pip{width:22px;height:22px;border-radius:.5rem;border:1px solid #334155;background:#0b1220;display:flex;align-items:center;justify-content:center}
.pip img{width:18px;height:18px}
.pip.dead{opacity:.4;filter:grayscale(1)}
/* faint anim */
.faint{animation:faint 420ms ease forwards}
@keyframes faint{to{opacity:.0; transform:translateY(18px)}}
/* GB banner */
.gb{position:relative;background:#0b1220;border:2px solid #334155;border-radius:.75rem;box-shadow:inset 0 0 0 2px #1e293b}
.caret{font-weight:900;margin-left:.5rem;display:inline-block;animation:blink .95s steps(1,end) infinite}
@keyframes blink{0%,70%{opacity:1}85%{opacity:.1}100%{opacity:1}}
/* selection + lists */
.grid-auto{display:grid;grid-template-columns:repeat(auto-fit,minmax(88px,1fr));gap:.75rem}
.team-card{padding:.6rem}
.team-card img{width:56px;height:56px}
.team-actions{display:flex;flex-wrap:wrap;gap:.35rem;justify-content:center}
.move-tag{display:inline-flex;align-items:center;gap:.35rem;padding:.2rem .45rem;border-radius:.6rem;background:#0f172a;border:1px solid #1f2a44;font-size:11px}
/* modal (end) */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:50}
.modal.show{display:flex}
.modal .backdrop{position:absolute;inset:0;background:rgba(2,6,23,.55);backdrop-filter:blur(6px)}
</style>
</head>
<body class="min-h-screen font-ui">
<header class="sticky top-0 z-10 bg-slate-900/80 backdrop-blur border-b border-slate-800">
  <div class="max-w-5xl mx-auto px-4 py-3">
    <div class="flex items-center gap-3">
      <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" class="w-6 h-6 pixel" alt="">
      <h1 class="text-lg font-extrabold leading-none">Jimmy’s Pokémon Stadium</h1>
    </div>
    <div class="pl-9 text-[12px] text-slate-400">Gen‑1 layout • Lv.50 • Gens I–III • HTML UI</div>
  </div>
</header>

<main class="max-w-5xl mx-auto px-4 py-4 space-y-6">
  <!-- Builder -->
  <section id="builder" class="space-y-4">
    <div class="flex items-center justify-between">
      <h2 class="text-base font-bold text-slate-300">Build your teams</h2>
      <div class="flex gap-2">
        <button id="btnRandomize" class="btn btn-secondary">Randomize teams</button>
        <button id="btnClear" class="btn btn-ghost">Clear</button>
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-4">
      <div class="card p-4">
        <div class="flex items-center gap-2 mb-3">
          <span class="text-xs text-slate-400">You</span>
          <div class="ml-auto"><button id="pickA" class="btn btn-primary">Pick</button></div>
        </div>
        <div id="teamA" class="grid grid-cols-3 gap-3"></div>
      </div>
      <div class="card p-4">
        <div class="flex items-center gap-2 mb-3">
          <span class="text-xs text-slate-400">Rival</span>
          <div class="ml-auto"><button id="pickB" class="btn btn-primary">Pick</button></div>
        </div>
        <div id="teamB" class="grid grid-cols-3 gap-3"></div>
      </div>
    </div>

    <div class="flex flex-wrap items-center gap-3 pt-2">
      <button id="startBattle" class="btn btn-secondary disabled:opacity-50" disabled>Start Battle</button>
      <div id="buildHint" class="text-sm text-slate-400">Pick 3 for each side to begin.</div>
    </div>
  </section>

  <!-- Arena -->
  <section id="arena" class="hidden space-y-3">
    <div class="flex items-center gap-2">
      <span id="roundTag" class="text-xs px-2 py-1 rounded-md bg-slate-800 border border-slate-700">Round 1</span>
      <div class="ml-auto"><button id="reset" class="btn btn-secondary">Back to builder</button></div>
    </div>

    <div class="battle-wrap">
      <div class="field">
        <!-- Enemy: top-right -->
        <div class="side enemy">
          <div class="hpbox">
            <div class="hp-head text-[12px]">
              <div class="hp-name"><span id="eStatus" class="dot"></span><b id="eName">—</b> <span class="text-slate-400 ml-1">Lv 50</span></div>
              <div class="text-slate-400" id="eHPText">0 / 0</div>
            </div>
            <div class="hpbar"><div id="eHPFill" class="hpfill" style="width:0;background:#22c55e"></div></div>
            <div class="subrow">
              <div class="pips" id="eRoster"></div>
              <div id="eTypes" class="text-[11px] text-slate-400">—</div>
            </div>
          </div>
          <div class="mon">
            <img id="eSprite" class="pixel" alt="">
          </div>
        </div>

        <!-- You: bottom-left -->
        <div class="side player">
          <div class="mon">
            <img id="pSprite" class="pixel" alt="">
          </div>
          <div class="hpbox">
            <div class="hp-head text-[12px]">
              <div class="hp-name"><span id="pStatus" class="dot"></span><b id="pName">—</b> <span class="text-slate-400 ml-1">Lv 50</span></div>
              <div class="text-slate-400" id="pHPText">0 / 0</div>
            </div>
            <div class="hpbar"><div id="pHPFill" class="hpfill" style="width:0;background:#22c55e"></div></div>
            <div class="subrow">
              <div class="pips" id="pRoster"></div>
              <div id="pTypes" class="text-[11px] text-slate-400">—</div>
            </div>
          </div>
        </div>
      </div>

      <div id="banner" class="gb mt-3 p-3 text-sm">Ready! <span id="caret" class="caret hidden">►</span></div>

      <div id="moveButtons" class="mt-3 grid grid-cols-2 gap-2"></div>
      <div class="mt-2 flex items-center gap-2">
        <button id="btnSwitch" class="btn btn-secondary">Pokémon</button>
      </div>

      <details class="card p-3 mt-3">
        <summary class="text-sm cursor-pointer text-slate-300">Show battle log (newest first)</summary>
        <ol id="log" class="space-y-2 text-sm max-h-80 overflow-auto pr-1 mt-2 text-slate-300"></ol>
      </details>
    </div>
  </section>
</main>

<!-- Picker (minimal — same style as earlier iterations, omitted for brevity) -->
<div id="picker" class="fixed inset-0 hidden z-30">
  <div class="absolute inset-0 bg-black/50" data-close></div>
  <div class="absolute inset-x-0 bottom-0 max-h-[88vh] rounded-t-3xl bg-slate-900 p-4 space-y-3 border-t border-slate-800 flex flex-col">
    <div class="flex items-center gap-2">
      <div id="pickerLabel" class="text-xs px-2 py-1 rounded-md bg-slate-800 border border-slate-700">Pick — You</div>
      <input id="search" type="text" placeholder="Search Pokémon…" class="ml-auto w-full max-w-xs px-3 py-2 rounded-xl border border-slate-700 bg-slate-800 text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-400" />
      <button id="donePick" class="btn btn-secondary">Done</button>
    </div>
    <div id="pickedCount" class="text-xs text-slate-400">0 / 3 selected</div>
    <div class="flex-1 min-h-0 overflow-y-auto pr-1"><div id="grid" class="grid-auto"></div></div>
  </div>
</div>

<!-- Switch Picker -->
<div id="switchPicker" class="fixed inset-0 z-40 hidden">
  <div class="absolute inset-0 bg-black/50" data-close-sw></div>
  <div class="absolute inset-x-0 bottom-0 max-h-[60vh] rounded-t-3xl bg-slate-900 p-4 space-y-3 border-t border-slate-800">
    <div class="flex items-center gap-2">
      <div class="text-xs px-2 py-1 rounded-md bg-slate-800 border border-slate-700">Switch Pokémon</div>
      <div class="ml-auto text-xs text-slate-400">Switching uses your turn</div>
    </div>
    <div id="swList" class="grid grid-cols-3 sm:grid-cols-6 gap-2"></div>
    <div class="flex justify-end"><button id="swCancel" class="btn btn-ghost">Cancel</button></div>
  </div>
</div>

<!-- End of battle modal -->
<div id="resultModal" class="modal">
  <div class="backdrop" data-close-res></div>
  <div class="relative card p-6 w-[min(92vw,480px)] text-center">
    <div id="resultTitle" class="text-2xl font-extrabold mb-2">You Win!</div>
    <div id="resultSummary" class="text-slate-300 text-sm mb-5">Battle summary…</div>
    <div class="flex justify-center gap-3">
      <button id="btnTryAgain" class="btn btn-primary">Try again?</button>
      <button id="btnBackToBuilder" class="btn btn-secondary">Back to Builder</button>
    </div>
  </div>
</div>

<script>
/* ===== Tiny helpers ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const cap=s=>s? s[0].toUpperCase()+s.slice(1):s;
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
const LV=50, MAX_ID=386;

/* Colors & sprites */
const TYPE_COLORS={normal:'#A8A77A',fire:'#EE8130',water:'#6390F0',electric:'#F7D02C',grass:'#7AC74C',ice:'#96D9D6',fighting:'#C22E28',poison:'#A33EA1',ground:'#E2BF65',flying:'#A98FF3',psychic:'#F95587',bug:'#A6B91A',rock:'#B6A136',ghost:'#735797',dragon:'#6F35FC',dark:'#705746',steel:'#B7B7CE',fairy:'#D685AD'};
const typeColor=t=>TYPE_COLORS[t]||'#64748b';
const spriteURL=id=>`https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`;

/* Fetch with retries */
async function fetchJSON(url,{tries=5,baseDelay=300}={}){let e;for(let i=0;i<tries;i++){try{const r=await fetch(url);if(!r.ok)throw new Error('HTTP '+r.status);return await r.json()}catch(err){e=err;await sleep(baseDelay*Math.pow(2,i)+Math.random()*120)}}throw e}

/* Safe tiny cache */
let store;try{localStorage.setItem('_t','1');localStorage.removeItem('_t');store=localStorage;}catch(e){try{sessionStorage.setItem('_t','1');sessionStorage.removeItem('_t');store=sessionStorage;}catch(_){store=null}}
function cget(k){if(!store)return null;try{return store.getItem(k)}catch(e){return null}}
function cset(k,v){if(!store)return;try{store.setItem(k,v)}catch(e){try{for(let i=store.length-1;i>=0;i--){const kk=store.key(i);if(kk&&kk.startsWith('mv:')) store.removeItem(kk)}store.setItem(k,v)}catch(_){}}}

/* State */
const S={ all:[], teamA:[], teamB:[], tempPick:new Set(), pickingFor:'A',
  rosterA:[], rosterB:[], aIdx:0, bIdx:0, round:1, waiting:true, queuedMove:null, queuedAction:null, lock:false,
  stats:{aKOs:0,bKOs:0,turns:0}, typesById:new Map(), mvPool:new Map()
};

/* Init */
document.addEventListener('DOMContentLoaded', init);
async function init(){
  wireBuilder(); wirePicker(); wireSwitch(); wireResult();
  await loadList();
  // Preseed BOTH teams (so Start Battle works instantly)
  autoSeed('A'); autoSeed('B');
  renderTeams(); updateStart();
}

/* Load Gen 1–3 list */
async function loadList(){
  const r=await fetchJSON(`https://pokeapi.co/api/v2/pokemon?limit=${MAX_ID}`);
  S.all=r.results.map(u=>({id:Number(u.url.split('/').filter(Boolean).pop()), name:cap(u.name)})).filter(p=>p.id>=1&&p.id<=MAX_ID);
  renderGrid();
}

/* Details & moves */
const mem=new Map();
async function getDetail(id){
  if(mem.has(id)) return mem.get(id);
  const p=await fetchJSON(`https://pokeapi.co/api/v2/pokemon/${id}`);
  const out={id,name:cap(p.name), types:p.types.sort((a,b)=>a.slot-b.slot).map(t=>t.type.name),
    sprites:{front:p.sprites.front_default, back:p.sprites.back_default||p.sprites.front_default},
    stats:p.stats.map(s=>({name:s.stat.name,base:s.base_stat})), moves:p.moves
  };
  mem.set(id,out); return out;
}
async function movePool(id){
  if(S.mvPool.has(id)) return S.mvPool.get(id);
  const d=await getDetail(id);
  // gather <=50 level-up + machine
  const seen=new Map();
  for(const m of d.moves){
    for(const v of m.version_group_details){
      const meth=v.move_learn_method?.name, lvl=v.level_learned_at||0;
      if(meth==='level-up' && lvl<=50){ if(!seen.has(m.move.name)) seen.set(m.move.name,{name:m.move.name,method:'level-up',level:lvl}); else {const o=seen.get(m.move.name); o.method=o.method||'level-up'; o.level=Math.max(o.level||0,lvl);} }
      if(meth==='machine'){ if(!seen.has(m.move.name)) seen.set(m.move.name,{name:m.move.name,method:'machine',level:null}); else {const o=seen.get(m.move.name); if(o.method!=='level-up') o.method='machine';} }
    }
  }
  // fetch move slim (with mini cache)
  const out=[];
  for(const {name} of seen.values()){
    const key='mv:'+name; const cached=cget(key);
    if(cached){ out.push(JSON.parse(cached)); continue; }
    try{
      const mv=await fetchJSON(`https://pokeapi.co/api/v2/move/${name}`);
      if(!['generation-i','generation-ii','generation-iii'].includes(mv.generation?.name)) continue;
      const slim={key:mv.name,display:mv.name.replace(/-/g,' ').replace(/\b\w/g,c=>c.toUpperCase()),
        type:mv.type?.name||'normal',category:mv.damage_class?.name||'status',
        power:mv.power!=null?mv.power:null,accuracy:mv.accuracy!=null?mv.accuracy:100,priority:mv.priority||0,
        meta:{ailment:mv.meta?.ailment?.name,ailment_chance:mv.meta?.ailment_chance||0},
        stat_changes:(mv.stat_changes||[]).map(s=>({stat:s.stat?.name,change:s.change})),
        target:mv.target?.name||'selected-pokemon', generation:mv.generation?.name
      };
      out.push(slim); cset(key,JSON.stringify(slim));
    }catch(_){ /* ignore fails */ }
  }
  if(!out.length) out.push({key:'tackle',display:'Tackle',type:'normal',category:'physical',power:40,accuracy:100,priority:0,meta:{},stat_changes:[],target:'selected-pokemon'});
  S.mvPool.set(id,out); return out;
}

/* Builder */
function wireBuilder(){
  $('#pickA').addEventListener('click',()=>openPicker('A'));
  $('#pickB').addEventListener('click',()=>openPicker('B'));
  $('#btnClear').addEventListener('click',()=>{S.teamA=[];S.teamB=[];renderTeams();updateStart();});
  $('#btnRandomize').addEventListener('click',()=>{autoSeed('A');autoSeed('B');renderTeams();updateStart();});
  $('#startBattle').addEventListener('click',startBattle);
}
function autoSeed(side){
  const ids=S.all.map(p=>p.id); shuffle(ids);
  const picks=ids.slice(0,3).map(id=>({id,name:nameFor(id)}));
  if(side==='A') S.teamA=picks; else S.teamB=picks;
}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j]]}return a}
function nameFor(id){const p=S.all.find(x=>x.id===id);return p?p.name:`#${id}`}
function renderTeams(){
  const mk=(teamKey,p)=>`
  <div class="card team-card flex flex-col items-center">
    <img src="${spriteURL(p.id)}" class="pixel" alt="${p.name}">
    <div class="text-xs mt-1 text-center">${p.name}</div>
    <div class="mt-2 team-actions">
      <button class="btn-chip" data-mv>Edit moves</button>
      <button class="btn-chip" data-rm>Remove</button>
    </div>
    <div class="mt-2 flex flex-wrap gap-1 justify-center">${
      (p.moves||[]).length?p.moves.map(m=>`<span class="move-tag"><span class="type-badge" style="background:${typeColor(m.type)}">${m.type.toUpperCase()}</span><span>${m.display}</span></span>`).join(''):'<span class="text-[10px] text-slate-400">No moves chosen</span>'
    }</div>
  </div>`;
  const fill=`<div class="rounded-2xl border border-dashed border-slate-700 h-20 flex items-center justify-center text-slate-500 text-xs">Empty</div>`;
  const mount=(el,key)=>{
    el.innerHTML='';
    const t=S[key];
    t.forEach((p,i)=>{
      const w=document.createElement('div'); w.innerHTML=mk(key,p);
      w.querySelector('[data-rm]').addEventListener('click',()=>{t.splice(i,1);renderTeams();updateStart();});
      w.querySelector('[data-mv]').addEventListener('click',()=>openMovePicker(key==='teamA'?'A':'B',p.id,p.name));
      el.appendChild(w.firstElementChild);
    });
    for(let i=t.length;i<3;i++){const d=document.createElement('div'); d.innerHTML=fill; el.appendChild(d.firstElementChild);}
  };
  mount($('#teamA'),'teamA'); mount($('#teamB'),'teamB');
}
function updateStart(){ $('#startBattle').disabled=!(S.teamA.length===3 && S.teamB.length===3); $('#buildHint').textContent=$('#startBattle').disabled?'Pick 3 for each side to begin.':'Start when ready—or edit moves first.'; }

/* Picker */
function wirePicker(){
  $('#donePick').addEventListener('click',()=>closePicker(true));
  $('#picker').addEventListener('click',e=>{ if(e.target?.hasAttribute('data-close')) closePicker(false); });
  $('#search').addEventListener('input',e=>filterGrid(e.target.value.toLowerCase()));
}
function openPicker(side){
  S.pickingFor=side; S.tempPick=new Set((side==='A'?S.teamA:S.teamB).map(p=>p.id));
  $('#pickerLabel').textContent='Pick — '+(side==='A'?'You':'Rival');
  $('#pickedCount').textContent=S.tempPick.size+' / 3 selected';
  $('#picker').classList.remove('hidden');
  if(!$('#grid').children.length) renderGrid();
}
function closePicker(commit){
  if(commit){
    const list=Array.from(S.tempPick).slice(0,3).map(id=>({id,name:nameFor(id)}));
    if(S.pickingFor==='A') S.teamA=list; else S.teamB=list;
    renderTeams(); updateStart();
  }
  $('#picker').classList.add('hidden');
}
function renderGrid(){
  const grid=$('#grid'); grid.innerHTML='';
  S.all.forEach(p=>{
    const b=document.createElement('button');
    b.className='rounded-2xl border border-slate-700 bg-slate-800 p-2 flex flex-col items-center hover:border-emerald-400 focus:outline-none';
    b.setAttribute('data-id',p.id);
    b.innerHTML=`<img src="${spriteURL(p.id)}" class="w-14 h-14 pixel" alt="${p.name}"><div class="text-[11px] mt-1">${String(p.id).padStart(3,'0')} • ${p.name}</div>`;
    b.addEventListener('click',()=>togglePick(p.id,b));
    grid.appendChild(b);
  });
}
function togglePick(id,el){
  if(S.tempPick.has(id)) S.tempPick.delete(id); else { if(S.tempPick.size>=3) return; S.tempPick.add(id); }
  $('#pickedCount').textContent=S.tempPick.size+' / 3 selected';
  el.style.borderColor=S.tempPick.has(id)?'#10b981':'#334155';
}
function filterGrid(q){
  $$('#grid [data-id]').forEach(el=>{
    const id=Number(el.getAttribute('data-id')); const name=nameFor(id).toLowerCase();
    const show=!q||name.includes(q)||String(id).padStart(3,'0').includes(q);
    el.classList.toggle('hidden',!show);
  });
}

/* Switcher */
function wireSwitch(){
  $('#btnSwitch').addEventListener('click',()=>{ if(S.lock||!S.waiting) return; openSwitch(); });
  $('#switchPicker').addEventListener('click',e=>{ if(e.target?.hasAttribute('data-close-sw')) closeSwitch(); });
  $('#swCancel').addEventListener('click',closeSwitch);
}
function openSwitch(){
  const box=$('#swList'); box.innerHTML='';
  S.rosterA.forEach((m,i)=>{
    const dis=(i===S.aIdx)||m.hp<=0;
    const b=document.createElement('button'); b.className='border border-slate-700 rounded-xl p-2 bg-slate-800 flex flex-col items-center'; b.disabled=dis; b.style.opacity=dis?'.5':'1';
    b.innerHTML=`<img src="${spriteURL(m.id)}" class="w-12 h-12 pixel"><div class="text-[11px] mt-1">${m.name}</div>`;
    b.addEventListener('click',async()=>{ if(dis) return; S.queuedAction={type:'switch',to:i}; closeSwitch(); await takeTurn(); });
    box.appendChild(b);
  });
  $('#switchPicker').classList.remove('hidden');
}
function closeSwitch(){ $('#switchPicker').classList.add('hidden'); }

/* Result modal */
function wireResult(){
  $('#btnTryAgain').addEventListener('click',()=>{ hideResult(); startBattle(); });
  $('#btnBackToBuilder').addEventListener('click',()=>{ hideResult(); $('#arena').classList.add('hidden'); $('#builder').classList.remove('hidden'); });
  $('[data-close-res]').addEventListener('click',hideResult);
}
function showResult(title,summary){ $('#resultTitle').textContent=title; $('#resultSummary').textContent=summary; $('#resultModal').classList.add('show'); }
function hideResult(){ $('#resultModal').classList.remove('show'); }

/* ===== Battle engine (GB layout updates) ===== */
const chart={normal:{rock:.5,ghost:0},fire:{fire:.5,water:.5,grass:2,ice:2,bug:2,rock:.5,dragon:.5,steel:2},water:{fire:2,water:.5,grass:.5,ground:2,rock:2,dragon:.5},electric:{water:2,electric:.5,grass:.5,ground:0,flying:2,dragon:.5},grass:{fire:.5,water:2,grass:.5,poison:.5,ground:2,flying:.5,bug:.5,rock:2,dragon:.5,steel:.5},ice:{water:.5,ice:.5,grass:2,ground:2,flying:2,dragon:2},fighting:{normal:2,ice:2,rock:2,dark:2,steel:2,poison:.5,flying:.5,psychic:.5,bug:.5,fairy:.5,ghost:0},poison:{grass:2,fairy:2,poison:.5,ground:.5,rock:.5,ghost:.5,steel:0},ground:{fire:2,electric:2,poison:2,rock:2,steel:2,grass:.5,flying:0,bug:.5},flying:{grass:2,fighting:2,bug:2,electric:.5,rock:.5,steel:.5},psychic:{fighting:2,poison:2,psychic:.5,dark:0,steel:.5},bug:{grass:2,psychic:2,dark:2,fire:.5,fighting:.5,poison:.5,flying:.5,ghost:.5,steel:.5,fairy:.5},rock:{fire:2,ice:2,flying:2,bug:2,fighting:.5,ground:.5,steel:.5},ghost:{ghost:2,psychic:2,normal:0,dark:.5},dragon:{dragon:2,steel:.5,fairy:0},dark:{ghost:2,psychic:2,fighting:.5,dark:.5,fairy:.5},steel:{rock:2,ice:2,fairy:2,fire:.5,water:.5,electric:.5,steel:.5}};
const eff=(atk,defs)=>defs.reduce((m,t)=>m*(chart[atk]&&chart[atk][t]!=null?chart[atk][t]:1),1);
const RECHARGE=new Set(['hyper-beam','giga-impact']);
const SEMI_INV={'fly':{tag:'fly',msg:'flew up high!'},'dig':{tag:'dig',msg:'dug underground!'}};
const SEMI_HITS={fly:{hits:new Set(['gust','twister','thunder','hurricane']),bonus:2},dig:{hits:new Set(['earthquake','magnitude']),bonus:2}};
const PRI_P1=new Set(['quick-attack','aqua-jet','bullet-punch','ice-shard','shadow-sneak','sucker-punch']);
const PRI_P2=new Set(['extreme-speed']);
const specials={ selfKO:new Set(['self-destruct','explosion']), drain50:new Set(['absorb','mega-drain','giga-drain','drain-punch','leech-life']), recoil33:new Set(['double-edge','flare-blitz','brave-bird','volt-tackle','wild-charge','wood-hammer']), recoil25:new Set(['take-down','submission']), fixed50:new Set(['seismic-toss','night-shade']), fixed40:new Set(['dragon-rage']), fixed20:new Set(['sonic-boom']), protect:new Set(['protect','detect']), sub:new Set(['substitute']), leech:new Set(['leech-seed']) };
const PAR_SPEED=.5, RESIDUAL=16;

function derive50(b){const hp=Math.floor(((2*b.hp)*LV)/100)+LV+10; const atk=Math.floor(((2*b.atk)*LV)/100)+5; const def=Math.floor(((2*b.def)*LV)/100)+5; const spa=Math.floor(((2*b.spa)*LV)/100)+5; const spd=Math.floor(((2*b.spd)*LV)/100)+5; const spe=Math.floor(((2*b.spe)*LV)/100)+5; return {maxHP:hp,atk,def,spa,spd,spe}}
function stage(val,st){ if(st===0) return val; return st>0?Math.floor(val*(2+st)/2):Math.floor(val*2/(2-st)); }
function priority(m){ if(typeof m.priority==='number') return m.priority; const k=(m.key||'').toLowerCase(); return PRI_P2.has(k)?2:PRI_P1.has(k)?1:0; }
function spd(mon){ let s=stage(mon.stats.spe,mon.stages.spe); if(mon.status==='par') s=Math.floor(s*PAR_SPEED); return s; }
function dmg(att,def,move){
  const k=(move.key||'').toLowerCase();
  if(specials.fixed50.has(k)) return LV; if(specials.fixed40.has(k)) return 40; if(specials.fixed20.has(k)) return 20;
  let A=move.category==='physical'?att.stats.atk:att.stats.spa, D=move.category==='physical'?def.stats.def:def.stats.spd;
  A=stage(A, move.category==='physical'?att.stages.atk:att.stages.spa); D=stage(D, move.category==='physical'?def.stages.def:def.stages.spd);
  if(move.category==='physical' && att.status==='brn') A=Math.floor(A*.5);
  const base=(((2*LV/5+2)*(move.power||0)*(A/Math.max(1,D)))/50)+2;
  const stab=att.types.includes(move.type)?1.5:1, e=eff(move.type,def.types), roll=(Math.random()*.15)+.85;
  return Math.max(1,Math.floor(base*stab*e*.925*roll));
}

/* UI helpers */
function setBanner(t,mode){ const b=$('#banner'), c=$('#caret'); b.textContent=t+' '; b.appendChild(c); c.classList.toggle('hidden', mode!=='your'); }
function log(t){ const li=document.createElement('li'); li.textContent=t; const list=$('#log'); if(list.firstChild) list.insertBefore(li,list.firstChild); else list.appendChild(li); }
function statusDotColor(st){return st==='par'?'#fbbf24':st==='brn'?'#f97316':st==='psn'?'#8b5cf6':st==='frz'?'#22d3ee':st==='slp'?'#94a3b8':'#10b981'}

/* Start battle */
async function startBattle(){
  $('#builder').classList.add('hidden'); $('#arena').classList.remove('hidden'); $('#log').innerHTML=''; hideResult();
  S.rosterA=[]; S.rosterB=[]; S.aIdx=0; S.bIdx=0; S.round=1; S.waiting=true; S.queuedMove=null; S.queuedAction=null; S.lock=false; S.stats={aKOs:0,bKOs:0,turns:0};

  const all=[...S.teamA,...S.teamB];
  const details=await Promise.all(all.map(async p=>{
    const d=await getDetail(p.id);
    // convert stats
    const g=k=>d.stats.find(x=>x.name===k)?.base||50;
    const base={hp:g('hp'),atk:g('attack'),def:g('defense'),spa:g('special-attack'),spd:g('special-defense'),spe:g('speed')};
    const derived=derive50(base);
    // moves
    let pool=await movePool(d.id);
    if(pool.length>180) pool=pool.slice(0,180);
    const rec=recommend(pool,d.types).slice(0,4);
    return {
      id:d.id, name:d.name, types:d.types,
      front:preferSprite(d.sprites.front,d.id), back:preferSprite(d.sprites.back,d.id,true),
      base, stats:{...derived}, stages:{atk:0,def:0,spa:0,spd:0,spe:0}, hp:derived.maxHP,
      moves:(p.moves&&p.moves.length?p.moves:rec), status:null, volatile:{}
    };
  }));

  S.rosterA=details.slice(0,3); S.rosterB=details.slice(3,6);
  mountField(); drawMoves(); setBanner('Your turn — choose a move for '+currA().name+'.','your');
}
function preferSprite(src,id,isBack){
  // Fallback chain to keep sprites loading
  if(src) return src;
  // back sprites sometimes missing; use front as fallback, else official static
  return isBack ? `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`
                : `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`;
}

const currA=()=>S.rosterA[S.aIdx], currB=()=>S.rosterB[S.bIdx];

function mountField(){
  const A=currA(), B=currB();
  // names & types
  $('#pName').textContent=A.name; $('#eName').textContent=B.name;
  $('#pTypes').innerHTML=A.types.map(t=>`<span class="type-badge" style="background:${typeColor(t)}">${t.toUpperCase()}</span>`).join(' ');
  $('#eTypes').innerHTML=B.types.map(t=>`<span class="type-badge" style="background:${typeColor(t)}">${t.toUpperCase()}</span>`).join(' ');
  // sprites
  const pS=$('#pSprite'), eS=$('#eSprite');
  pS.classList.remove('faint'); eS.classList.remove('faint');
  pS.src=A.back; eS.src=B.front;
  // hp & pips
  setHP('p',A); setHP('e',B);
  renderPips('#pRoster',S.rosterA,S.aIdx); renderPips('#eRoster',S.rosterB,S.bIdx);
}
function setHP(prefix,mon){
  $('#'+prefix+'HPText').textContent=`${mon.hp} / ${mon.stats.maxHP}`;
  const pct=Math.max(0,mon.hp/mon.stats.maxHP), fill=$('#'+prefix+'HPFill');
  fill.style.width=(pct*100).toFixed(0)+'%';
  fill.style.background=pct>0.5?'#22c55e':pct>0.2?'#f59e0b':'#ef4444';
  $('#'+prefix+'Status').style.background=statusDotColor(mon.status);
}
function renderPips(sel, roster, idx){
  const c=$(sel); c.innerHTML='';
  roster.forEach((m,i)=>{ const d=document.createElement('div'); d.className='pip'+(m.hp<=0?' dead':'')+(i===idx?' border-emerald-400':''); d.innerHTML=`<img src="${spriteURL(m.id)}" class="pixel">`; c.appendChild(d); });
}

function drawMoves(){
  const A=currA(); const box=$('#moveButtons'); box.innerHTML='';
  A.moves.forEach(m=>{
    const b=document.createElement('button');
    b.className='btn w-full'; b.style.background=`linear-gradient(180deg, ${typeColor(m.type)}, #1f2937)`; b.style.color='#fff';
    b.innerHTML=`<div class="flex-1 text-left">
      <div class="font-extrabold">${m.display}</div>
      <div class="text-[10px] opacity-90">${m.category==='status'?'Status':('Pow '+(m.power==null?'—':m.power))} • Acc ${m.accuracy==null?'—':m.accuracy}% • ${cap(m.category)}</div>
    </div><span class="type-badge" style="background:${typeColor(m.type)}">${m.type.toUpperCase()}</span>`;
    b.addEventListener('click',()=>{ if(S.lock||!S.waiting) return; S.queuedMove=m; takeTurn(); });
    box.appendChild(b);
  });
}

/* Turn flow + AI */
function priorityVal(m){ if(typeof m.priority==='number') return m.priority; const k=(m.key||'').toLowerCase(); return PRI_P2.has(k)?2:PRI_P1.has(k)?1:0; }
function bestMove(att,def){
  let best=att.moves[0], sc=-1e9;
  for(const m of att.moves){
    let s=0;
    if(m.category==='status'){ s=10 + (m.meta?.ailment?25:0) + ((m.stat_changes?.length||0)*6); }
    else{ const d=dmg(att,def,m); const e=eff(m.type,def.types); s=d + (e>1?(e-1)*55:(e<1?-(1-e)*40:0)) + ((m.accuracy??100)*.12) + (att.types.includes(m.type)?18:0); }
    s+=priorityVal(m)*6;
    if(s>sc){ sc=s; best=m; }
  }
  return best;
}

async function takeTurn(){
  if(S.lock) return; S.lock=true;

  // switching first?
  if(S.queuedAction && S.queuedAction.type==='switch'){
    await doSwitch('A',S.queuedAction.to);
    S.queuedAction=null; S.queuedMove=null; S.waiting=false;
    if(alive()){ await act('B',currB(),currA(),bestMove(currB(),currA())); }
    await endTurn(); S.lock=false; return;
  }

  if(!S.queuedMove){ toast('Choose a move'); S.lock=false; return; }

  const A=currA(), B=currB();
  const order=[{side:'A',move:S.queuedMove},{side:'B',move:bestMove(B,A)}];
  const pA=priorityVal(order[0].move), pB=priorityVal(order[1].move);
  if(pA!==pB) order.sort((x,y)=>priorityVal(x.move)>priorityVal(y.move)?-1:1);
  else { const sA=spd(A), sB=spd(B); if(sB>sA || (sA===sB && Math.random()<.5)) order.reverse(); }

  for(const step of order){ if(!alive()) break; await act(step.side, step.side==='A'?currA():currB(), step.side==='A'?currB():currA(), step.move); }

  await endTurn();
  S.queuedMove=null; S.lock=false;
}

async function act(side, atk, def, move){
  if(atk.hp<=0 || def.hp<=0) return;

  // pre-move
  if(atk.volatile?.recharge){ atk.volatile.recharge=0; log(atk.name+' must recharge!'); await sleep(250); return; }
  if(atk.status==='slp'){ log(atk.name+' is fast asleep…'); await sleep(250); return; }
  if(atk.status==='frz'){ if(Math.random()<.2){ log(atk.name+' thawed out!'); atk.status=null; } else { log(atk.name+' is frozen solid!'); await sleep(250); return; } }
  if(atk.status==='par' && Math.random()<.25){ log(atk.name+' is fully paralyzed!'); await sleep(250); return; }

  setBanner(atk.name+' used '+move.display+'!', side==='A'?'your':'rival');

  const key=(move.key||'').toLowerCase();
  // charging/semi-inv
  if(atk.volatile?.charging){ move=atk.volatile.charging; delete atk.volatile.charging; if(atk.volatile.semiInv) delete atk.volatile.semiInv; }
  else if(SEMI_INV[key]){ atk.volatile=atk.volatile||{}; atk.volatile.charging=move; atk.volatile.semiInv=SEMI_INV[key].tag; log(atk.name+' '+SEMI_INV[key].msg); await sleep(300); return; }
  else if(['solar-beam','sky-attack','razor-wind'].includes(key)){ atk.volatile=atk.volatile||{}; atk.volatile.charging=move; log(atk.name+' is charging '+move.display+'!'); await sleep(300); return; }

  // protect/sub/leech
  if(specials.protect?.has(key)){ atk.volatile=atk.volatile||{}; atk.volatile.protect=true; log(atk.name+' protected itself!'); await sleep(200); return; }
  if(specials.sub?.has(key)){
    atk.volatile=atk.volatile||{}; if(atk.volatile.subHP>0){ log('But it failed!'); return; }
    const cost=Math.floor(atk.stats.maxHP/4); if(atk.hp<=cost){ log('Not enough HP!'); return; }
    atk.hp-=cost; atk.volatile.subHP=cost; updateHP(); log(atk.name+' put in a Substitute!'); await sleep(220); return;
  }
  if(specials.leech?.has(key)){
    if(def.types.includes('grass')|| def.volatile?.leech){ log('But it failed!'); return; }
    if(Math.random()*100>(move.accuracy??90)){ log('Leech Seed missed!'); return; }
    def.volatile=def.volatile||{}; def.volatile.leech={from:side}; log(def.name+' was seeded!'); await sleep(220); return;
  }

  const autoMiss = def.volatile?.semiInv && !(SEMI_HITS[def.volatile.semiInv]?.hits?.has(key));
  if(autoMiss || Math.random()*100 > (move.accuracy??100)){ log(atk.name+"'s "+move.display+' missed!'); await sleep(220); return; }

  // status-only moves
  if(move.category==='status' && (!move.power||move.power===0) && ((move.meta?.ailment) || (move.stat_changes?.length) || move.healing)){
    if(def.volatile?.subHP && ((move.meta?.ailment) || (move.stat_changes||[]).some(s=>s.change<0))){ log('Substitute blocked the effect!'); return; }
    const applied = await applyStatus(atk,def,move,side); if(!applied) log('But it failed!'); updateHP(); return;
  }

  // damage / multihit
  let hits=1, effBonus=1;
  if(def.volatile?.semiInv){ const t=def.volatile.semiInv; const c=SEMI_HITS[t]; if(c?.hits?.has(key)) effBonus=c.bonus||1; }
  if(['double-slap','fury-attack','fury-swipes','bullet-seed','icicle-spear','pin-missile','rock-blast','arm-thrust'].includes(key)){ const r=Math.random(); hits=r<.35?2:r<.70?3:r<.85?4:5; }
  if(['bonemerang','dual-chop','twineedle'].includes(key)) hits=2;

  let total=0, landed=0;
  for(let i=0;i<hits;i++){ if(Math.random()*100 <= (move.accuracy??100)){ landed++; total+=Math.floor(dmg(atk,def,move)*effBonus); } }
  if(landed===0){ log(atk.name+"'s "+move.display+' missed!'); await sleep(220); return; }

  const crit=Math.random()<.1; if(crit) total=Math.floor(total*1.75);

  if(def.volatile?.subHP){
    const before=def.volatile.subHP; def.volatile.subHP=Math.max(0,before-total);
    log('The Substitute took '+Math.min(before,total)+' damage.'); if(def.volatile.subHP<=0){ delete def.volatile.subHP; log('The Substitute broke!'); }
  }else{
    if(def.volatile?.protect){ log(def.name+' protected itself!'); delete def.volatile.protect; await sleep(200); return; }
    def.hp=Math.max(0,def.hp-total); log(atk.name+' dealt '+total+(hits>1?' ('+hits+' hits)':'')+' to '+def.name+'.'+(crit?' Critical hit!':''));
    if(def.hp<=0){ (side==='A'?S.stats.aKOs++:S.stats.bKOs++); // faint anim
      const img = side==='A' ? $('#eSprite') : $('#pSprite'); img.classList.add('faint');
    }
  }
  updateHP(); await sleep(260);

  // simple secondary ailment chance
  const ail=move.meta?.ailment, ailC=move.meta?.ailment_chance||0;
  if(def.hp>0 && ail && Math.random()*100 <= ailC && !def.status){ def.status=ailToShort(ail); log(def.name+' is now '+def.status.toUpperCase()+'!'); updateHP(); await sleep(150); }

  // self drain/recoil/selfKO
  if(specials.drain50.has(key) && total>0 && atk.hp>0){ const h=Math.max(1,Math.floor(total*.5)); const before=atk.hp; atk.hp=Math.min(atk.stats.maxHP, atk.hp+h); if(atk.hp>before){ log(atk.name+' drained '+(atk.hp-before)+' HP!'); updateHP(); await sleep(140); } }
  if(specials.recoil33.has(key) && total>0){ const r=Math.max(1,Math.floor(total/3)); atk.hp=Math.max(0,atk.hp-r); log(atk.name+' is hit with recoil ('+r+').'); updateHP(); await sleep(140); }
  if(specials.recoil25.has(key) && total>0){ const r=Math.max(1,Math.floor(total/4)); atk.hp=Math.max(0,atk.hp-r); log(atk.name+' is hit with recoil ('+r+').'); updateHP(); await sleep(140); }
  if(['self-destruct','explosion'].includes(key)){ atk.hp=0; log(atk.name+' fainted from '+move.display+'!'); updateHP(); await sleep(160); }

  // auto-send next
  if(def.hp<=0){ const opp = side==='A'?S.rosterB:S.rosterA; const cur = side==='A'?S.bIdx:S.aIdx; const next=opp.findIndex((m,i)=>i>cur && m.hp>0); if(side==='A'){ if(next!==-1) S.bIdx=next; } else { if(next!==-1) S.aIdx=next; } mountField(); await sleep(280); }
  if(atk.hp<=0){ const my = side==='A'?S.rosterA:S.rosterB; const cur=side==='A'?S.aIdx:S.bIdx; const next=my.findIndex((m,i)=>i>cur && m.hp>0); if(side==='A'){ if(next!==-1) S.aIdx=next; } else { if(next!==-1) S.bIdx=next; } mountField(); await sleep(280); }

  if(RECHARGE.has(key) && atk.hp>0){ atk.volatile=atk.volatile||{}; atk.volatile.recharge=1; }
}
function ailToShort(a){return a==='paralysis'?'par':a==='burn'?'brn':(a==='poison'||a==='bad-poison')?'psn':a==='freeze'?'frz':a==='sleep'?'slp':null}

function updateHP(){ setHP('p',currA()); setHP('e',currB()); renderPips('#pRoster',S.rosterA,S.aIdx); renderPips('#eRoster',S.rosterB,S.bIdx); }
function alive(){ return S.rosterA.some(m=>m.hp>0) && S.rosterB.some(m=>m.hp>0); }

async function endTurn(){
  if(alive()){
    // residuals
    for(const [mon,side] of [[currA(),'A'],[currB(),'B']]){
      if(mon.hp<=0) continue;
      if(mon.status==='brn'||mon.status==='psn'){ const d=Math.max(1,Math.floor(mon.stats.maxHP/RESIDUAL)); mon.hp=Math.max(0,mon.hp-d); log(mon.name+' is hurt by '+(mon.status==='brn'?'burn':'poison')+' ('+d+').'); }
      if(mon.volatile?.leech){ const d=Math.max(1,Math.floor(mon.stats.maxHP/8)); mon.hp=Math.max(0,mon.hp-d); const other=side==='A'?currB():currA(); if(other && other.hp>0) other.hp=Math.min(other.stats.maxHP, other.hp+d); log(mon.name+' had its energy drained ('+d+').'); }
    }
    S.stats.turns++; S.round++; $('#roundTag').textContent='Round '+S.round; updateHP();
    setBanner('Your turn — choose a move for '+currA().name+'.','your'); S.waiting=true; return;
  }
  // end battle
  updateHP();
  const youAlive=S.rosterA.some(m=>m.hp>0);
  showResult(youAlive?'You win!':'Rival wins!', `Turns: ${S.stats.turns} • Your KOs: ${S.stats.aKOs} • Rival KOs: ${S.stats.bKOs}`);
}

/* Status application */
async function applyStatus(atk,def,move,side){
  let done=false;
  const ail=move.meta?.ailment;
  if(ail){ const target=move.target?.includes('user')?atk:def; if(!target.status){ target.status=ailToShort(ail); log(target.name+' is now '+target.status.toUpperCase()+'!'); done=true; } }
  if(move.stat_changes?.length){
    const target=move.target?.includes('user')?atk:def;
    for(const sc of move.stat_changes){ const map={'attack':'atk','defense':'def','special-attack':'spa','special-defense':'spd','speed':'spe'}; const k=map[sc.stat]; if(!k) continue; target.stages[k]=Math.max(-6,Math.min(6,target.stages[k]+sc.change)); const dir=sc.change>0?'rose':'fell'; log(target.name+"'s "+sc.stat.replace('-',' ')+' '+dir+'!'); done=true; }
  }
  return done;
}

/* Switching (consumes your turn) */
async function doSwitch(side,toIndex){
  const me = side==='A', out=me?currA():currB();
  log(me?`${out.name}, come back!`:`${out.name} was withdrawn!`);
  if(me) S.aIdx=toIndex; else S.bIdx=toIndex;
  const incoming=me?currA():currB();
  log(me?`Go, ${incoming.name}!`:`Foe sent out ${incoming.name}!`);
  mountField(); await sleep(220);
}

/* Recommend moves (simple) */
function recommend(pool,types){
  const scored=pool.map(m=>{
    const stab=types.includes(m.type)?1.5:1;
    const base=m.category==='status'?(40+(m.meta?.ailment?20:0)+((m.stat_changes?.length||0)*24)):(m.power||0)*stab;
    return {s:base+(m.priority||0)*6+(m.accuracy??100)*.05, m};
  });
  scored.sort((a,b)=>b.s-a.s);
  const seen=new Set(),out=[]; for(const s of scored){ if(!seen.has(s.m.key)){seen.add(s.m.key); out.push(s.m);} if(out.length>=4) break; }
  return out.length?out:[{key:'tackle',display:'Tackle',type:'normal',category:'physical',power:40,accuracy:100,priority:0}];
}

/* Toast */
let tTimer; function toast(msg){ clearTimeout(tTimer); let t=$('#toast'); if(!t){ t=document.createElement('div'); t.id='toast'; t.className='fixed bottom-3 inset-x-0 mx-auto w-fit max-w-[90%] px-4 py-2 rounded-xl bg-slate-800 text-slate-100 border border-slate-700 text-sm shadow-lg'; document.body.appendChild(t);} t.textContent=msg; t.style.opacity='1'; tTimer=setTimeout(()=>t.style.opacity='0',1600); }
</script>
</body>
</html>