<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Jimmy’s LoL Duel</title>
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect width="128" height="128" rx="24" fill="%230b1220"/><path fill="%23a855f7" d="M24 92 44 36h12L36 92zM70 92l20-56h12L82 92z"/><circle cx="64" cy="34" r="6" fill="%235a7cff"/></svg>'/>
<meta name="theme-color" content="#0b1220"/>
<meta name="description" content="Jimmy’s LoL Duel — Mobile 3v3 LoL duel with roster pick, CPU, items, status effects, rotating fields, and an ultimate meter."/>
<meta property="og:title" content="Jimmy’s LoL Duel"/>
<meta property="og:image" content="https://ddragon.leagueoflegends.com/cdn/img/champion/splash/Ahri_0.jpg"/>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config={theme:{extend:{
  keyframes:{
    hit:{'0%':{transform:'translateX(0) scale(1)'},'20%':{transform:'translateX(-6px) scale(1.02)'},'40%':{transform:'translateX(6px) scale(1.02)'},'60%':{transform:'translateX(-3px)'},'80%':{transform:'translateX(3px)'},'100%':{transform:'translateX(0) scale(1)'}},
    flash:{'0%':{opacity:0},'30%':{opacity:.6},'100%':{opacity:0}},
    float:{'0%':{transform:'translateY(0)',opacity:1},'100%':{transform:'translateY(-24px)',opacity:0}},
    blink:{'0%,100%':{opacity:1},'50%':{opacity:.1}},
    ken:{'0%':{transform:'scale(1) translate(0,0)'},'100%':{transform:'scale(1.15) translate(-2%,-2%)'}}
  },
  animation:{hit:'hit .3s ease-in-out',flash:'flash .5s ease-out',float:'float .7s ease-out forwards',blink:'blink 1s steps(2,start) infinite',ken:'ken 14s ease-in-out infinite alternate'}
}}}
</script>
<style>
*{touch-action:manipulation}
canvas.radar{width:100%;height:160px}
html,body{height:100%}
.chip{padding:.35rem .6rem;border-radius:.5rem;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12)}
.chip.active{background:rgba(99,102,241,.28);border-color:rgba(99,102,241,.6)}
.badge{font-size:10px;padding:.15rem .35rem;border-radius:.35rem;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12)}
.statdot{font-size:11px}
</style>
</head>
<body class="bg-slate-950 text-slate-100 antialiased">

<header class="sticky top-0 z-50 backdrop-blur bg-slate-950/80 border-b border-white/10">
  <div class="mx-auto max-w-6xl px-3 sm:px-4 py-3 flex items-center gap-2">
    <div class="size-8 rounded-md bg-indigo-500/20 grid place-items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="size-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3 6 6 .9-4.5 4.3L17.8 20 12 16.9 6.2 20l1.3-6.8L3 8.9 9 8z"/></svg>
    </div>
    <div class="min-w-0 flex-1">
      <h1 class="text-lg font-semibold truncate">Jimmy’s LoL Duel</h1>
      <p class="text-xs text-slate-400 truncate">Roster pick • 3v3 • Elements • Status • Fields • Ult meter</p>
    </div>
    <button id="shareBtn" class="hidden sm:inline rounded-lg px-3 py-2 bg-white/10 hover:bg-white/15 text-sm">Share</button>
  </div>
  <!-- Sticky select bar -->
  <div id="pickBar" class="border-t border-white/10">
    <div class="mx-auto max-w-6xl px-3 sm:px-4 py-2 flex items-center gap-2">
      <div class="text-xs flex items-center gap-2">
        <span class="opacity-70">Assign to:</span>
        <select id="assignSide" class="rounded bg-slate-900/70 border border-white/10 px-2 py-1.5 text-xs">
          <option value="left" selected>P1</option>
          <option value="right">P2 / CPU</option>
        </select>
        <span class="opacity-70">P2 Mode:</span>
        <select id="p2ModeSelect" class="rounded bg-slate-900/70 border border-white/10 px-2 py-1.5 text-xs">
          <option value="cpu" selected>CPU</option>
          <option value="human">Human</option>
        </select>
      </div>
      <div class="text-xs ml-2">
        <span class="mr-2">P1: <b id="cntLeft">0</b>/3</span>
        <span>P2: <b id="cntRight">0</b>/3</span>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <button id="randomBoth" class="rounded-md px-3 py-1.5 bg-white/10 hover:bg-white/15 text-xs">Randomize Both</button>
        <button id="startBattleTop" class="rounded-md px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-sm font-semibold disabled:opacity-40 disabled:cursor-not-allowed" disabled>Start Battle</button>
      </div>
    </div>
  </div>
</header>

<main class="mx-auto max-w-6xl px-3 sm:px-4 py-4 md:py-6">
  <!-- ====================== SELECT SCREEN ====================== -->
  <section id="selectScreen" class="space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <div class="rounded-lg border border-white/10 bg-white/5 p-2">
        <div class="text-xs font-semibold mb-2">P1 Picks</div>
        <div id="leftPicks" class="flex gap-2"></div>
      </div>
      <div class="rounded-lg border border-white/10 bg-white/5 p-2">
        <div class="text-xs font-semibold mb-2">P2 / CPU Picks</div>
        <div id="rightPicks" class="flex gap-2 justify-end"></div>
      </div>
    </div>

    <!-- Filters -->
    <div class="rounded-lg border border-white/10 bg-white/5 p-2">
      <div class="text-xs font-semibold">Quick Filters</div>
      <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-2">
        <div class="flex flex-wrap gap-2 items-center text-xs" id="roleFilters">
          <span class="text-slate-400">Role:</span>
          <button class="chip" data-role="">All</button>
          <button class="chip" data-role="Assassin">Assassin</button>
          <button class="chip" data-role="Fighter">Fighter</button>
          <button class="chip" data-role="Mage">Mage</button>
          <button class="chip" data-role="Marksman">Marksman</button>
          <button class="chip" data-role="Support">Support</button>
          <button class="chip" data-role="Tank">Tank</button>
        </div>
        <div class="flex flex-wrap gap-2 items-center text-xs" id="elemFilters">
          <span class="text-slate-400">Element:</span>
          <button class="chip" data-elem="">All</button>
          <button class="chip" data-elem="Fire">Fire</button>
          <button class="chip" data-elem="Water">Water</button>
          <button class="chip" data-elem="Electric">Electric</button>
          <button class="chip" data-elem="Wind">Wind</button>
          <button class="chip" data-elem="Earth">Earth</button>
          <button class="chip" data-elem="Light">Light</button>
          <button class="chip" data-elem="Dark">Dark</button>
          <button class="chip" data-elem="Arcane">Arcane</button>
          <button class="chip" data-elem="Physical">Physical</button>
        </div>
      </div>
    </div>

    <!-- Roster search + grid -->
    <div class="rounded-xl border border-white/10 bg-gradient-to-b from-slate-900 to-slate-950 p-3 md:p-4">
      <div class="flex items-center gap-2 mb-3">
        <input id="rosterSearch" class="flex-1 rounded-lg bg-slate-900/70 border border-white/10 px-3 py-2 text-sm" placeholder="Search champions…">
        <button id="clearPicks" class="rounded-lg px-3 py-2 bg-white/10 hover:bg-white/15 text-sm">Clear Picks</button>
      </div>
      <div id="roster" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2"></div>
    </div>
  </section>

  <!-- ====================== BATTLE SCREEN ====================== -->
  <section id="battleScreen" class="hidden">
    <div class="rounded-lg border border-white/10 bg-white/5 px-3 py-2 text-xs flex items-center gap-2 mb-3">
      <span class="opacity-70">Field:</span><span id="fieldName">Calm</span>
      <span class="opacity-70">⏳</span><span id="fieldTurns">5</span>
      <span class="ml-auto opacity-70" id="turnBadge">Turn: P1</span>
      <button id="backToSelect" class="ml-2 rounded-md px-2 py-1 bg-white/10 hover:bg-white/15">Change Teams</button>
    </div>

    <div id="arenaWrap" class="rounded-2xl border border-white/10 overflow-hidden bg-slate-900">
      <div class="p-3 sm:p-4 bg-[radial-gradient(ellipse_at_center,_rgba(22,22,32,.6),_rgba(2,6,23,.95))] relative">
        <div id="arenaFlash" class="pointer-events-none absolute inset-0"></div>

        <!-- Enemy -->
        <div class="flex justify-end mb-6">
          <div class="flex items-center gap-3 max-w-xl">
            <img id="rightIcon" class="size-20 sm:size-24 rounded-full ring-2 ring-white/20 object-cover" alt="">
            <div class="flex-1 rounded-xl border border-white/10 bg-white/5 p-2">
              <div class="flex items-center gap-2">
                <div class="min-w-0">
                  <div id="rightName" class="text-sm font-semibold truncate">—</div>
                  <div id="rightTags" class="text-[10px] text-slate-300 truncate">—</div>
                </div>
                <div id="rightBadges" class="ml-auto text-[10px] flex gap-1 items-center"></div>
              </div>
              <div class="mt-1 h-2 w-full bg-slate-800 rounded overflow-hidden">
                <div id="rightHpBar" class="h-full bg-rose-500 transition-all"></div>
              </div>
              <div class="mt-1 text-[11px] text-slate-300">
                <span id="rightHpText">HP —/—</span> · <span id="rightResMini"></span> · <span id="rightUltMini">ULT 0%</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Player -->
        <div class="flex justify-start">
          <div class="flex items-center gap-3 max-w-xl">
            <img id="leftIcon" class="size-20 sm:size-24 rounded-full ring-2 ring-white/20 object-cover" alt="">
            <div class="flex-1 rounded-xl border border-white/10 bg-white/5 p-2">
              <div class="flex items-center gap-2">
                <div class="min-w-0">
                  <div id="leftName" class="text-sm font-semibold truncate">—</div>
                  <div id="leftTags" class="text-[10px] text-slate-300 truncate">—</div>
                </div>
                <div id="leftBadges" class="ml-auto text-[10px] flex gap-1 items-center"></div>
              </div>
              <div class="mt-1 h-2 w-full bg-slate-800 rounded overflow-hidden">
                <div id="leftHpBar" class="h-full bg-green-500 transition-all"></div>
              </div>
              <div class="mt-1 text-[11px] text-slate-300">
                <span id="leftHpText">HP —/—</span> · <span id="leftResMini"></span> · <span id="leftUltMini">ULT 0%</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Controls -->
      <div class="p-3 sm:p-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div id="leftPanel" class="rounded-xl bg-white/5 border border-white/10 p-2">
          <div class="flex items-center justify-between mb-1">
            <div class="text-xs font-semibold">Abilities (hold to inspect)</div>
            <div id="p2ModeBadge" class="text-[11px]">CPU</div>
          </div>
          <div id="leftAbilities" class="grid grid-cols-5 gap-1.5 sm:gap-2"></div>
          <div class="mt-3 flex items-center gap-2">
            <div class="text-xs font-semibold">Items</div>
            <button id="itemPotion" class="rounded-md px-2 py-1.5 text-xs bg-emerald-600/70 hover:bg-emerald-600">Potion (x<span id="potionLeftL">2</span>)</button>
            <button id="itemEther" class="rounded-md px-2 py-1.5 text-xs bg-sky-600/70 hover:bg-sky-600">Ether (x<span id="etherLeftL">2</span>)</button>
            <button id="btnSwap" class="ml-auto rounded-md px-2 py-1.5 text-xs bg-white/10 hover:bg-white/15">Switch</button>
          </div>
          <div id="leftBench" class="mt-2 flex gap-2"></div>
        </div>

        <div id="rightPanel" class="rounded-xl bg-white/5 border border-white/10 p-2 opacity-60">
          <div class="flex items-center justify-between mb-1">
            <div class="text-xs font-semibold">Opponent</div>
            <div id="oppItemsInfo" class="text-[11px]">Items: Potion x<span id="potionLeftR">2</span>, Ether x<span id="etherLeftR">2</span></div>
          </div>
          <details id="rightAbilitiesWrap" class="group">
            <summary class="cursor-pointer text-xs text-slate-300 flex items-center gap-2 select-none">
              <span id="rightAbilitiesLabel">Enemy Skills (CPU)</span>
              <span class="ml-auto text-slate-500 transition group-open:rotate-90">▸</span>
            </summary>
            <div id="rightAbilities" class="mt-2 grid grid-cols-5 gap-1.5 sm:gap-2 opacity-70"></div>
          </details>
          <div id="rightBench" class="mt-2 flex gap-2 justify-end"></div>
        </div>
      </div>

      <!-- Live feed -->
      <div class="bg-slate-900/90 border-t border-white/10">
        <div class="px-3 sm:px-4 py-3 font-mono text-sm flex items-center gap-2">
          <span class="animate-blink">▶</span>
          <div id="liveMsg" class="truncate" aria-live="polite">Welcome to Jimmy’s LoL Duel!</div>
          <div class="ml-auto flex items-center gap-2">
            <button id="resetBtn" class="tap-none rounded-lg px-2.5 py-1.5 text-xs bg-white/10 hover:bg-white/15">Reset</button>
          </div>
        </div>
        <details class="px-3 sm:px-4 pb-4">
          <summary class="cursor-pointer text-xs text-slate-300">Battle Log</summary>
          <div id="log" class="mt-2 space-y-2 max-h-56 overflow-auto text-sm"></div>
        </details>
      </div>
    </div>
  </section>

  <footer class="mt-6 text-xs text-slate-400">Uses Riot’s Data Dragon. Fan‑made demo.</footer>
</main>

<!-- =============== CHAMPION INFO MODAL (with splash animation) =============== -->
<div id="champModal" class="fixed inset-0 hidden z-[60]">
  <div id="champBackdrop" class="absolute inset-0 bg-black/80"></div>
  <div class="absolute inset-0 p-3 grid place-items-center">
    <div class="relative max-w-3xl w-full rounded-xl overflow-hidden border border-white/10 bg-slate-950">
      <div id="champSplash" class="absolute inset-0 opacity-25 bg-center bg-cover animate-ken"></div>
      <div class="relative p-4">
        <div class="flex items-center gap-3">
          <img id="cmIcon" class="size-12 rounded-lg ring-1 ring-white/10 object-cover" alt="">
          <div class="min-w-0">
            <div id="cmName" class="text-lg font-semibold truncate"></div>
            <div id="cmTags" class="text-xs text-slate-300 truncate"></div>
          </div>
          <div id="cmElem" class="ml-auto text-[11px] px-2 py-1 rounded bg-white/10"></div>
        </div>
        <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
          <canvas id="cmRadar" width="360" height="240" class="w-full rounded-lg bg-slate-950/70 border border-white/10"></canvas>
          <div id="cmSpells" class="text-sm space-y-2"></div>
        </div>
        <div class="mt-4 flex items-center justify-end gap-2">
          <button id="cmAddLeft" class="rounded-md px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 text-sm">Add to P1</button>
          <button id="cmAddRight" class="rounded-md px-3 py-1.5 bg-rose-600 hover:bg-rose-500 text-sm">Add to P2</button>
          <button id="cmClose" class="rounded-md px-3 py-1.5 bg-white/10 hover:bg-white/15 text-sm">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Inspect overlay -->
<div id="inspectOverlay" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden z-[70]">
  <div class="absolute inset-0 grid place-items-center p-4">
    <div class="max-w-md w-full rounded-xl border border-white/10 bg-slate-900 p-4">
      <div class="text-sm font-semibold" id="insName">Ability</div>
      <div class="text-xs text-slate-300 mt-1" id="insChamp">Champion</div>
      <div class="mt-2 h-px bg-white/10"></div>
      <div class="mt-2 text-sm" id="insDesc"></div>
      <div class="mt-3 grid grid-cols-2 gap-2 text-xs">
        <div><span class="text-slate-400">Element:</span> <span id="insElem"></span></div>
        <div><span class="text-slate-400">Type:</span> <span id="insDmgType"></span></div>
        <div><span class="text-slate-400">Cost:</span> <span id="insCost"></span></div>
        <div><span class="text-slate-400">Cooldown:</span> <span id="insCD"></span></div>
      </div>
      <div class="mt-4 text-right"><button id="insClose" class="rounded-md px-3 py-1.5 bg-white/10 hover:bg-white/15 text-sm">Close</button></div>
    </div>
  </div>
</div>

<!-- End screen -->
<div id="endOverlay" class="fixed inset-0 hidden z-[80]">
  <div id="endArt" class="absolute inset-0 opacity-20 md:opacity-30 bg-cover bg-center"></div>
  <div class="absolute inset-0 bg-gradient-to-b from-slate-900/90 to-black/95 backdrop-blur-sm"></div>
  <div class="relative h-full flex flex-col items-center justify-center p-6">
    <div id="endTitle" class="text-5xl sm:text-6xl font-extrabold tracking-wide drop-shadow-xl"></div>
    <div id="endSubtitle" class="mt-2 text-slate-300"></div>
    <div class="mt-8 flex flex-wrap items-center justify-center gap-3">
      <button id="btnTryAgain" class="rounded-lg px-5 py-3 bg-indigo-600 hover:bg-indigo-500 font-semibold">Try Again</button>
      <button id="btnResetBattle" class="rounded-lg px-5 py-3 bg-white/10 hover:bg-white/15">Back to Select</button>
    </div>
  </div>
</div>

<script>
(()=>{
// ---------- helpers ----------
const $=(s,e=document)=>e.querySelector(s);
const $$=(s,e=document)=>[...e.querySelectorAll(s)];
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
const live=(m)=>{$('#liveMsg')&&($('#liveMsg').textContent=m);}
function flashArena(){const f=$('#arenaFlash'); f.className='pointer-events-none absolute inset-0 bg-white/60 animate-flash'; setTimeout(()=>f.className='pointer-events-none absolute inset-0',520);}

// ---------- constants ----------
const TURN_DELAY_MS=950;
const BAL={BASE_HP:240,ROLE_HP_BONUS:{Tank:80,Fighter:40},BASE_DMG:[70,90,80,130],BASIC_ATK:55,CRIT:.1,CRITM:1.75,MISS:.07,
  RES:{Mana:{max:100,regen:15,costs:[20,25,25,45]},Energy:{max:100,regen:22,costs:[20,25,25,40]},None:{max:0,regen:0,costs:[0,0,0,0]}},
  ULT_REQ:100, ULT_GAIN:{basic:15,Q:20,W:25,E:25,taken:10},
  BURN_PCT:.10, SHIELD_REDUCE:.30, STATUS_TURNS:2
};
const EFF={Fire:{Wind:1.2,Earth:.5,Water:.5},Water:{Fire:2,Earth:1.2,Electric:.5},Electric:{Water:2,Wind:1.5,Earth:.5},Wind:{Earth:2,Fire:.8},Earth:{Electric:2,Wind:.5,Fire:1.2},Arcane:{Dark:1.2,Light:.8},Dark:{Light:2,Arcane:.8},Light:{Dark:2,Arcane:1.2},Physical:{}};

// Fields: name, duration, boosts map
const FIELDS=[
  {name:'Calm', turns:5, boost:{}},
  {name:'Inferno', turns:4, boost:{Fire:1.2,Water:0.85}},
  {name:'Rain', turns:4, boost:{Water:1.2,Electric:1.1}},
  {name:'Storm', turns:4, boost:{Electric:1.2,Earth:0.9}},
  {name:'Gale', turns:4, boost:{Wind:1.2,Fire:0.9}},
  {name:'Quake', turns:4, boost:{Earth:1.2,Wind:0.85}},
  {name:'Eclipse', turns:4, boost:{Dark:1.2,Light:0.9}},
  {name:'Radiance', turns:4, boost:{Light:1.2,Dark:0.9}},
  {name:'Arcana', turns:4, boost:{Arcane:1.15,Physical:0.95}}
];

// ---------- ddragon ----------
const DDRAGON='https://ddragon.leagueoflegends.com';
const VERS=`${DDRAGON}/api/versions.json`;
const ddata=(v,p)=>`${DDRAGON}/cdn/${v}/data/en_US/${p}`;
const imgChamp=(v,f)=>`${DDRAGON}/cdn/${v}/img/champion/${f}`;
const imgSpell=(v,f)=>`${DDRAGON}/cdn/${v}/img/spell/${f}`;
const splash=(id)=>`${DDRAGON}/cdn/img/champion/splash/${id}_0.jpg`;
async function J(u){const r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw new Error(r.status); return r.json();}

// ---------- parsing ----------
const RE_MAGIC=/(magic damage|magical|ap)/i, RE_PHYS=/(physical damage|ad|attack damage)/i;
const RE_HEAL=/(heal|restore)/i, RE_SHIELD=/(shield|barrier)/i, RE_BURN=/(burn|ignite|bleed|poison|damage over time)/i;
function roleElem(tags){if(tags.includes('Mage'))return'Arcane'; if(tags.includes('Marksman'))return'Wind'; if(tags.includes('Tank'))return'Earth'; if(tags.includes('Fighter'))return'Earth'; if(tags.includes('Assassin'))return'Dark'; if(tags.includes('Support'))return'Light'; return'Physical'}
function spellElem(sp,fb){const s=((sp.tooltip||'')+' '+(sp.description||'')).toLowerCase(); if(/\b(fire|ignite|flame|burn)\b/.test(s))return'Fire'; if(/\b(water|ice|frost|tide)\b/.test(s))return'Water'; if(/\b(lightning|electric|storm|thunder)\b/.test(s))return'Electric'; if(/\b(wind|gale|gust)\b/.test(s))return'Wind'; if(/\b(earth|stone|rock|ground|quake)\b/.test(s))return'Earth'; if(/\b(holy|light)\b/.test(s))return'Light'; if(/\b(shadow|dark)\b/.test(s))return'Dark'; return fb||'Physical'}
function dmgType(sp,ch){const t=((sp.tooltip||'')+' '+(sp.description||'')).toLowerCase(); if(RE_MAGIC.test(t))return'magic'; if(RE_PHYS.test(t))return'physical'; return ch.tags?.includes('Mage')?'magic':'physical'}
const clean=(h)=>String(h||'').replace(/<\/?br\s*\/?>/gi,' ').replace(/\{\{[^}]+\}\}/g,'').replace(/\s+/g,' ').trim();
const short=(t,n=90)=>{t=clean(t);return t.length>n?t.slice(0,n-1)+'…':t}

// ---------- state ----------
const S={version:null,list:[],champs:{},
  left:[null,null,null], right:[null,null,null],
  li:0, ri:0, turn:'left', p2:'cpu',
  items:{left:{potion:2,ether:2}, right:{potion:2,ether:2}},
  field:{name:'Calm', turns:5, boost:{}}
};

// ---------- radar ----------
function drawRadar(cv,labels,vals){const ctx=cv.getContext('2d');const W=cv.width,H=cv.height,cx=W/2,cy=H/2+8,r=Math.min(W,H)*.36,steps=5;ctx.clearRect(0,0,W,H);ctx.strokeStyle='rgba(148,163,184,.35)';ctx.lineWidth=1;
  for(let s=1;s<=steps;s++){ctx.beginPath();for(let i=0;i<labels.length;i++){const a=(Math.PI*2/labels.length)*i-Math.PI/2,rr=r*s/steps,x=cx+rr*Math.cos(a),y=cy+rr*Math.sin(a);i?ctx.lineTo(x,y):ctx.moveTo(x,y);}ctx.closePath();ctx.stroke();}
  for(let i=0;i<labels.length;i++){const a=(Math.PI*2/labels.length)*i-Math.PI/2,x=cx+r*Math.cos(a),y=cy+r*Math.sin(a);ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(x,y);ctx.stroke();}
  ctx.fillStyle='rgba(99,102,241,.28)';ctx.strokeStyle='rgba(99,102,241,.85)';ctx.beginPath();
  for(let i=0;i<labels.length;i++){const a=(Math.PI*2/labels.length)*i-Math.PI/2,rr=r*(vals[i]/10),x=cx+rr*Math.cos(a),y=cy+rr*Math.sin(a);i?ctx.lineTo(x,y):ctx.moveTo(x,y);}ctx.closePath();ctx.fill();ctx.stroke();
  ctx.fillStyle='rgba(203,213,225,.9)';ctx.font='12px system-ui';labels.forEach((lb,i)=>{const a=(Math.PI*2/labels.length)*i-Math.PI/2,x=cx+(r+14)*Math.cos(a),y=cy+(r+14)*Math.sin(a);ctx.textAlign=Math.cos(a)>0.2?'left':(Math.cos(a)<-0.2?'right':'center');ctx.fillText(lb,x,y);});
}

// ---------- selection UI refs ----------
const E={
  roster:$('#roster'), search:$('#rosterSearch'),
  leftPicks:$('#leftPicks'), rightPicks:$('#rightPicks'),
  cntLeft:$('#cntLeft'), cntRight:$('#cntRight'),
  startTop:$('#startBattleTop'), assignSide:$('#assignSide'), p2ModeSelect:$('#p2ModeSelect'),
  roleFilters:$('#roleFilters'), elemFilters:$('#elemFilters'),
  champModal:$('#champModal'), champBackdrop:$('#champBackdrop'),
  cmIcon:$('#cmIcon'), cmName:$('#cmName'), cmTags:$('#cmTags'), cmElem:$('#cmElem'),
  cmRadar:$('#cmRadar'), cmSpells:$('#cmSpells'), cmSplash:$('#champSplash'),
  cmAddLeft:$('#cmAddLeft'), cmAddRight:$('#cmAddRight'),
  leftIcon:$('#leftIcon'), rightIcon:$('#rightIcon'),
  leftName:$('#leftName'), rightName:$('#rightName'),
  leftTags:$('#leftTags'), rightTags:$('#rightTags'),
  leftHpBar:$('#leftHpBar'), rightHpBar:$('#rightHpBar'),
  leftHpText:$('#leftHpText'), rightHpText:$('#rightHpText'),
  leftResMini:$('#leftResMini'), rightResMini:$('#rightResMini'),
  leftUltMini:$('#leftUltMini'), rightUltMini:$('#rightUltMini'),
  leftBadges:$('#leftBadges'), rightBadges:$('#rightBadges'),
  leftAbilities:$('#leftAbilities'), rightAbilities:$('#rightAbilities'),
  leftBench:$('#leftBench'), rightBench:$('#rightBench'),
  turnBadge:$('#turnBadge'),
  itemPotion:$('#itemPotion'), itemEther:$('#itemEther'),
  endOverlay:$('#endOverlay'), endTitle:$('#endTitle'), endSubtitle:$('#endSubtitle'), endArt:$('#endArt'),
  fieldName:$('#fieldName'), fieldTurns:$('#fieldTurns')
};

// ---------- build champ ----------
function resType(f){const p=(f.partype||'').toLowerCase(); if(p.includes('mana'))return'Mana'; if(p.includes('energy'))return'Energy'; return'None'}
function buildChamp(full){
  const base=BAL.BASE_HP+(full.tags||[]).reduce((a,t)=>a+(BAL.ROLE_HP_BONUS[t]||0),0);
  const rt=resType(full), R=BAL.RES[rt];
  return {data:full, elem:roleElem(full.tags||[]), tags:full.tags||[], hp:base, max:base, cds:[0,0,0,0],
    resType:rt, res:R.max, resMax:R.max, ult:0,
    status:{burn:0, shield:0},
    roleMods:{magic:(full.tags||[]).includes('Mage')?1.05:1, physical:(full.tags||[]).some(x=>['Marksman','Fighter','Assassin'].includes(x))?1.05:1}
  }
}

// ---------- roster (filters + skill tooltips) ----------
let filterRole="", filterElem="";
function renderRoster(filter=''){
  const q=filter.trim().toLowerCase(); E.roster.innerHTML='';
  S.list.filter(c=>{
    const roleOK=!filterRole || (c.tags||[]).includes(filterRole);
    const elemOK=!filterElem || roleElem(c.tags||[])===filterElem;
    const qOK=!q || c.name.toLowerCase().includes(q) || c.id.toLowerCase().includes(q);
    return roleOK && elemOK && qOK;
  }).forEach(c=>{
    const el=roleElem(c.tags||[]);
    const card=document.createElement('button');
    card.className='group relative rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 p-2 text-left';
    card.innerHTML=`
      <img class="w-full aspect-square object-cover rounded-md ring-1 ring-white/10 mb-2" src="${imgChamp(S.version,c.image.full)}" alt="">
      <div class="text-sm font-medium truncate">${c.name}</div>
      <div class="text-[10px] text-slate-400 truncate">${(c.tags||[]).join(' • ')}</div>
      <div class="absolute top-2 right-2 text-[10px] bg-black/50 px-1.5 py-0.5 rounded">${el}</div>`;
    // brief skill blurbs on hover (desktop)
    let loaded=false; card.title='Loading…';
    card.addEventListener('mouseenter',async()=>{if(loaded) return; try{const js=await (await fetch(`${DDRAGON}/cdn/${S.version}/data/en_US/champion/${c.id}.json`)).json(); const sp=(js.data[c.id].spells||[]).slice(0,3).map(s=>`${s.name}: ${short(s.tooltip,70)}`); card.title=sp.join('\n');}catch{card.title='';} loaded=true;},{passive:true});
    // tap to add, long‑press to modal
    let t=null, opened=false; const start=()=>{t=setTimeout(()=>{opened=true; openChampModal(c);},420)}; const clear=()=>{if(t){clearTimeout(t);t=null}}
    card.addEventListener('mousedown',start); card.addEventListener('touchstart',start,{passive:true});
    ['mouseleave','mouseup','touchend','touchcancel'].forEach(ev=>card.addEventListener(ev,()=>{if(!opened){clear(); addPick(E.assignSide.value,c.id);} opened=false;},{passive:true}));
    card.addEventListener('click',e=>e.preventDefault());
    E.roster.appendChild(card);
  });
}
function markChips(group){$$('.chip',group).forEach(b=>b.classList.toggle('active', (b.dataset.role??'')===filterRole || (b.dataset.elem??'')===filterElem || ((b.dataset.role===''&&filterRole==='')||(b.dataset.elem===''&&filterElem===''))))}
E.roleFilters.addEventListener('click',e=>{const b=e.target.closest('.chip'); if(!b)return; filterRole=b.dataset.role??""; markChips(E.roleFilters); renderRoster(E.search.value||'');});
E.elemFilters.addEventListener('click',e=>{const b=e.target.closest('.chip'); if(!b)return; filterElem=b.dataset.elem??""; markChips(E.elemFilters); renderRoster(E.search.value||'');});

// ---------- picks ----------
function drawPicks(){
  const pill=(ch,side,idx)=> ch?`<div class="relative">
      <img class="size-14 rounded ring-2 ${side==='left'?'ring-indigo-500':'ring-rose-500'} object-cover" src="${imgChamp(S.version,ch.data.image.full)}" alt="">
      <button class="absolute -top-2 -right-2 size-6 grid place-items-center rounded-full bg-rose-600 text-white text-xs remove" data-side="${side}" data-idx="${idx}">×</button>
      <div class="absolute -top-1 -left-1 bg-black/70 rounded text-[10px] px-1">${idx+1}</div>
    </div>`:`<div class="size-14 rounded border border-dashed border-white/15"></div>`;
  E.leftPicks.innerHTML=S.left.map((x,i)=>pill(x,'left',i)).join('');
  E.rightPicks.innerHTML=S.right.map((x,i)=>pill(x,'right',i)).join('');
  $$('#leftPicks .remove').forEach(b=>b.addEventListener('click',()=>{S.left[+b.dataset.idx]=null; updatePickCounters(); drawPicks();}));
  $$('#rightPicks .remove').forEach(b=>b.addEventListener('click',()=>{S.right[+b.dataset.idx]=null; updatePickCounters(); drawPicks();}));
  updatePickCounters();
}
function updatePickCounters(){E.cntLeft.textContent=S.left.filter(Boolean).length; E.cntRight.textContent=S.right.filter(Boolean).length; E.startTop.disabled=!(S.left.every(Boolean)&&S.right.every(Boolean));}
async function addPick(side,id){const list=side==='left'?S.left:S.right; const slot=list.findIndex(x=>!x); if(slot===-1) return; const full=(await (await fetch(`${DDRAGON}/cdn/${S.version}/data/en_US/champion/${id}.json`)).json()).data[id]; list[slot]=buildChamp(full); drawPicks();}
function randomFill(side){const arr=S.list.slice().sort(()=>Math.random()-.5).slice(0,3); Promise.all(arr.map(c=>addPick(side,c.id)));}

// ---------- modal ----------
function openChampModal(c){
  $('#cmIcon').src=imgChamp(S.version,c.image.full);
  $('#cmName').textContent=c.name; $('#cmTags').textContent=(c.tags||[]).join(' • '); $('#cmElem').textContent=roleElem(c.tags||[]);
  $('#champSplash').style.backgroundImage=`url('${splash(c.id)}')`;
  const info=c.info||{attack:5,defense:5,magic:5,difficulty:5}; const speed=(c.tags||[]).some(t=>['Assassin','Marksman'].includes(t))?8:(c.tags||[]).includes('Tank')?4:6;
  drawRadar($('#cmRadar'),['Attack','Defense','Magic','Speed','Control'],[info.attack||5,info.defense||5,info.magic||5,speed,info.difficulty||5]);
  $('#cmSpells').innerHTML='Loading…';
  fetch(`${DDRAGON}/cdn/${S.version}/data/en_US/champion/${c.id}.json`).then(r=>r.json()).then(j=>{
    const full=j.data[c.id];
    $('#cmSpells').innerHTML=(full.spells||[]).map(s=>`<div class="flex items-start gap-2"><img class="size-6 mt-0.5" src="${imgSpell(S.version,s.image.full)}" alt=""><div><div class="font-medium">${s.name}</div><div class="text-slate-300 text-xs">${short(s.tooltip,120)}</div></div></div>`).join('');
    $('#cmAddLeft').onclick=()=>addPick('left',c.id); $('#cmAddRight').onclick=()=>addPick('right',c.id);
  }).catch(()=>$('#cmSpells').textContent='—');
  $('#champModal').classList.remove('hidden');
}
$('#cmClose').onclick=()=>$('#champModal').classList.add('hidden'); $('#champBackdrop').onclick=()=>$('#champModal').classList.add('hidden');

// ---------- battle helpers ----------
function team(s){return s==='left'?S.left:S.right}
function active(s){return team(s)[s==='left'?S.li:S.ri]}
function foeSide(s){return s==='left'?'right':'left'}
function eff(a,b){return (EFF[a]&&EFF[a][b])||1}
function abBase(i){return BAL.BASE_DMG[i]||80}
function scost(sp,i,rt){const C=BAL.RES[rt||'None']; let c=0; if(Array.isArray(sp.cost)&&sp.cost.length)c=+sp.cost[0]; if(!c&&typeof sp.costBurn==='string'){const m=sp.costBurn.match(/\d+/); if(m)c=+m[0];} if(!c)c=C.costs[i]||0; return c}
function grantUlt(ch,amt){const was=ch.ult; ch.ult=clamp(ch.ult+amt,0,BAL.ULT_REQ); if(was<BAL.ULT_REQ && ch.ult>=BAL.ULT_REQ) logLine(`${ch.data.name}'s Ultimate is ready!`);}
function spendUlt(ch){ch.ult=0;}

// Field apply
function fieldMult(elem){const b=S.field.boost||{}; return (elem in b)?b[elem]:1;}

// ---------- UI render ----------
function statusBadges(ch){
  const arr=[];
  if(ch.status.burn>0) arr.push(`<span class="badge">🔥 Burn ${ch.status.burn}</span>`);
  if(ch.status.shield>0) arr.push(`<span class="badge">🛡 Shield ${ch.status.shield}</span>`);
  return arr.join(' ');
}
function renderHUD(side){
  const cur=active(side), isL=side==='left';
  const icon=$(isL?'#leftIcon':'#rightIcon'), name=$(isL?'#leftName':'#rightName'), tags=$(isL?'#leftTags':'#rightTags'), hpbar=$(isL?'#leftHpBar':'#rightHpBar'), hptext=$(isL?'#leftHpText':'#rightHpText'), resmini=$(isL?'#leftResMini':'#rightResMini'), ultmini=$(isL?'#leftUltMini':'#rightUltMini'), badges=$(isL?'#leftBadges':'#rightBadges'), abil=$(isL?'#leftAbilities':'#rightAbilities'), bench=$(isL?'#leftBench':'#rightBench'), panel=$(isL?'#leftPanel':'#rightPanel');
  if(!cur){icon.src=''; name.textContent='—'; tags.textContent=''; hpbar.style.width='0%'; hptext.textContent='HP —/—'; resmini.textContent=''; ultmini.textContent='ULT —'; badges.innerHTML=''; abil.innerHTML=''; bench.innerHTML=''; return;}
  icon.src=imgChamp(S.version,cur.data.image.full);
  name.textContent=`${cur.data.name} (${cur.elem})`; tags.textContent=(cur.data.tags||[]).join(' / ');
  hpbar.style.width=Math.max(0,Math.min(100,(cur.hp/cur.max)*100))+'%'; hptext.textContent=`HP ${Math.max(0,Math.round(cur.hp))}/${cur.max}`;
  resmini.textContent=cur.resType!=='None'?`${cur.resType} ${Math.round(cur.res)}/${cur.resMax}`:''; ultmini.textContent=`ULT ${Math.min(100,Math.round(cur.ult))}%`;
  badges.innerHTML=statusBadges(cur);
  // abilities
  const myTurn=(S.turn===side)&&!(side==='right'&&S.p2==='cpu'); panel.style.opacity=myTurn?'1':'0.6';
  abil.innerHTML='';
  const dis=myTurn?'':'pointer-events-none opacity-60';
  // Basic
  const bA=document.createElement('button');
  bA.className=`relative aspect-square rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 ${dis}`;
  bA.innerHTML=`<div class="absolute top-1 left-1 text-[10px] px-1.5 py-0.5 rounded ${isL?'bg-indigo-600':'bg-rose-600'}">A</div><div class="grid place-items-center h-full"><svg viewBox="0 0 24 24" class="w-8 h-8" fill="currentColor"><path d="M7 14l-4.5 4.5a2 2 0 102.8 2.8L9.8 16.8 7 14zm6.1-1.7l2.6 2.6L22 6.6 17.4 2l-7.3 6.3 3 3zM3.7 21.4a.99.99 0 11-1.4-1.4l2.3-2.3 1.4 1.4-2.3 2.3z"/></svg></div>`;
  bA.onclick=()=>basic(side); abil.appendChild(bA);
  // QWER
  (cur.data.spells||[]).slice(0,4).forEach((sp,i)=>{
    const cd=cur.cds[i]||0, cost=scost(sp,i,cur.resType);
    const needsUlt=(i===3), ultReady=cur.ult>=BAL.ULT_REQ;
    const disabled=!myTurn || cd>0 || (needsUlt?!ultReady:(cur.resType!=='None' && cur.res<cost));
    const b=document.createElement('button');
    b.className=`relative aspect-square rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 overflow-hidden ${disabled?'pointer-events-none opacity-50':''}`;
    b.dataset.idx=i; b.dataset.side=side;
    b.innerHTML=`<div class="absolute top-1 left-1 text-[10px] px-1.5 py-0.5 rounded ${isL?'bg-indigo-600':'bg-rose-600'}">${['Q','W','E','R'][i]}</div>${needsUlt?`<div class="absolute top-1 right-1 text-[10px] px-1 py-0.5 rounded bg-black/60">ULT</div>`:(cost?`<div class="absolute top-1 right-1 text-[10px] px-1 py-0.5 rounded bg-black/60">${cost}</div>`:'')}<img class="w-full h-full object-cover" src="${imgSpell(S.version,sp.image.full)}" alt="${sp.name}">${cd>0?`<div class="absolute inset-0 bg-black/60 grid place-items-center text-sm font-semibold">${cd}</div>`:''}`;
    b.onclick=onAbility;
    holdInspect(b,sp,cur);
    abil.appendChild(b);
  });
  // bench
  const pill=(ch,isActive,side,idx)=> ch?`<button class="bench w-20 rounded-md border ${isActive?'border-indigo-500':'border-white/10'} bg-white/5 p-1 ${dis}" data-side="${side}" data-slot="${idx}">
    <img class="w-full h-10 object-cover rounded" src="${imgChamp(S.version,ch.data.image.full)}" alt="">
    <div class="mt-1 h-1.5 bg-slate-800 rounded overflow-hidden"><div style="width:${Math.max(0,Math.min(100,(ch.hp/ch.max)*100))}%;" class="h-full ${ch.hp/ch.max>.5?'bg-green-500':ch.hp/ch.max>.2?'bg-yellow-400':'bg-rose-500'}"></div></div>
  </button>`:'';
  bench.innerHTML=team(side).map((c,i)=>pill(c,i===(side==='left'?S.li:S.ri),side,i)).join('');
  bench.querySelectorAll('.bench').forEach(b=>b.addEventListener('click',()=>trySwitch(side,+b.dataset.slot)));
}
function renderAll(){
  renderHUD('left'); renderHUD('right');
  $('#turnBadge').textContent=`Turn: ${S.turn==='left'?'P1':(S.p2==='cpu'?'CPU':'P2')}`;
  $('#turnBadge').className='ml-auto opacity-70 px-1.5 py-0.5 rounded text-[11px] '+(S.turn==='left'?'bg-indigo-600':'bg-rose-600');
  $('#potionLeftL').textContent=S.items.left.potion; $('#etherLeftL').textContent=S.items.left.ether;
  $('#potionLeftR').textContent=S.items.right.potion; $('#etherLeftR').textContent=S.items.right.ether;
  E.fieldName.textContent=S.field.name; E.fieldTurns.textContent=S.field.turns;
}

// ---------- combat calc (no AOE) ----------
function abDmg(att,def,idx,sp){
  const isHeal=RE_HEAL.test((sp.tooltip||'')+' '+(sp.description||'')); if(isHeal) return{heal:true, elem:spellElem(sp,att.elem)};
  if(Math.random()<BAL.MISS) return{miss:true, elem:spellElem(sp,att.elem)};
  const type=dmgType(sp,att.data); const elem=spellElem(sp,att.elem);
  let base=abBase(idx); if(idx===3) base*=1.4;
  base*=(type==='magic'?att.roleMods.magic:att.roleMods.physical);
  let mult=eff(elem,def.elem);
  mult*=fieldMult(elem);
  if(def.status.shield>0) base*=(1-BAL.SHIELD_REDUCE);
  let crit=false; if(Math.random()<BAL.CRIT){crit=true;base*=BAL.CRITM;}
  const dmg=Math.max(20,Math.round(base*mult));
  const applyBurn=RE_BURN.test((sp.tooltip||'')+' '+(sp.description||'')) || elem==='Fire';
  const applyShield=RE_SHIELD.test((sp.tooltip||'')+' '+(sp.description||'')) && !isHeal;
  return{dmg,crit,mult,elem,applyBurn,applyShield};
}
function basicDmg(att,def){
  if(Math.random()<BAL.MISS) return{miss:true};
  let base=BAL.BASIC_ATK, t=att.tags||[];
  if(t.includes('Marksman')||t.includes('Fighter')||t.includes('Assassin')) base*=1.1;
  if(t.includes('Mage')) base*=.9; if(t.includes('Tank')) base*=.95;
  let mult=eff('Physical',def.elem)*fieldMult('Physical'); let crit=false; if(Math.random()<BAL.CRIT){crit=true;base*=BAL.CRITM;}
  if(def.status.shield>0) base*=(1-BAL.SHIELD_REDUCE);
  const dmg=Math.max(18,Math.round(base*mult)); return{dmg,crit,mult};
}

// ---------- float damage text ----------
function floatText(side,txt,kind='d'){const host=side==='left'?$('#leftIcon'):$('#rightIcon'); const n=document.createElement('div'); const r=host.getBoundingClientRect(); n.style.position='fixed'; n.style.left=(r.left+r.width/2-16)+'px'; n.style.top=(r.top-8)+'px'; n.innerHTML=`<span class="px-2 py-0.5 rounded ${kind==='h'?'bg-emerald-600/80':'bg-black/70'} text-white text-lg font-extrabold">${txt}</span>`; document.body.appendChild(n); n.classList.add('animate-float'); setTimeout(()=>n.remove(),760);}

// ---------- turn processing & status ticks ----------
function startTurnTicks(side){
  const me=active(side); if(!me) return;
  // Burn tick
  if(me.status.burn>0 && me.hp>0){
    const dot=Math.max(5,Math.round(me.max*BAL.BURN_PCT));
    me.hp=Math.max(0,me.hp-dot); me.status.burn--; floatText(side,`-${dot}`); logLine(`${me.data.name} suffers burn damage!`);
  }
  // Shield decay
  if(me.status.shield>0) me.status.shield--;
}
function endTurn(){
  const w=winner(); if(w) return endScreen(w);
  // field countdown
  S.field.turns--; if(S.field.turns<=0){ const next=FIELDS[Math.floor(Math.random()*FIELDS.length)]; S.field={name:next.name, turns:next.turns, boost:next.boost}; logLine(`The field shifted to ${S.field.name}!`); }
  const next=S.turn==='left'?'right':'left';
  // regen & cooldown on incoming actor
  const actor=active(next); if(actor){const C=BAL.RES[actor.resType]||{regen:0}; actor.res=clamp(actor.res+(C.regen||0),0,actor.resMax); actor.cds=actor.cds.map(c=>Math.max(0,c-1));}
  S.turn=next; startTurnTicks(next); renderAll();
  if(S.turn==='right'&&S.p2==='cpu') setTimeout(cpuAct,TURN_DELAY_MS);
}
function winner(){const L=S.left.filter(Boolean).every(s=>s.hp<=0), R=S.right.filter(Boolean).every(s=>s.hp<=0); if(L) return 'right'; if(R) return 'left'; return null;}
function endScreen(win){$('#endOverlay').classList.remove('hidden'); const p1=(win==='left'); $('#endTitle').textContent=p1?'VICTORY':'DEFEAT'; $('#endTitle').className='text-5xl sm:text-6xl font-extrabold '+(p1?'text-emerald-400':'text-rose-400'); const id=active(win)?.data?.id; if(id) $('#endArt').style.backgroundImage=`url('${splash(id)}')`; $('#endSubtitle').textContent=p1?'You defeated the opponent!':'Your team has fallen.';}

// ---------- actions ----------
function basic(side){
  const me=active(side), foeS=foeSide(side), foe=active(foeS); if(!me||!foe) return;
  flashArena(); $('#arenaWrap').classList.add('animate-hit'); setTimeout(()=>$('#arenaWrap').classList.remove('animate-hit'),320);
  const r=basicDmg(me,foe);
  if(r.miss){logLine(`${me.data.name} attacked… missed!`);}
  else{
    foe.hp=Math.max(0,foe.hp-r.dmg);
    grantUlt(me,BAL.ULT_GAIN.basic); grantUlt(foe,BAL.ULT_GAIN.taken);
    floatText(foeS,`-${r.dmg}${r.crit?'★':''}`);
    let tag=''; if(r.mult>1.01)tag=' Super effective!'; else if(r.mult<0.99)tag=' Not very effective…';
    logLine(`${me.data.name} used a basic attack!${tag}`);
    if(foe.hp<=0){logLine(`${foe.data.name} fainted!`); if(!switchIfDead(foeS)){renderAll(); endTurn(); const w=winner(); if(w) return endScreen(w);}}
  }
  renderAll(); endTurn();
}
function onAbility(e){const side=e.currentTarget.dataset.side, idx=+e.currentTarget.dataset.idx; if(S.turn!==side) return; if(side==='right'&&S.p2==='cpu') return; actAbility(side,idx);}
function actAbility(side,idx){
  const me=active(side), foeS=foeSide(side), foe=active(foeS); if(!me||!foe) return;
  const sp=(me.data.spells||[])[idx], cost=scost(sp,idx,me.resType);
  if(idx===3){ if(me.ult<BAL.ULT_REQ){logLine(`${me.data.name}'s Ultimate is not ready.`); return;} }
  else if(me.resType!=='None' && me.res<cost){logLine(`${me.data.name} lacks ${me.resType}!`); return;}
  if(idx!==3 && me.resType!=='None') me.res=Math.max(0,me.res-cost);
  const r=abDmg(me,foe,idx,sp);
  flashArena(); $('#arenaWrap').classList.add('animate-hit'); setTimeout(()=>$('#arenaWrap').classList.remove('animate-hit'),320);
  if(r.heal){const heal=Math.round(me.max*.22); me.hp=Math.min(me.max,me.hp+heal); if(idx===3) spendUlt(me); else grantUlt(me, idx===0?BAL.ULT_GAIN.Q:idx===1?BAL.ULT_GAIN.W:BAL.ULT_GAIN.E); floatText(side,'+'+heal,'h'); logLine(`${me.data.name} used ${sp.name}. +${heal} HP`);}
  else if(r.miss){logLine(`${me.data.name} used ${sp.name}… missed!`);}
  else{
    foe.hp=Math.max(0,foe.hp-r.dmg);
    if(idx===3) spendUlt(me); else grantUlt(me, idx===0?BAL.ULT_GAIN.Q:idx===1?BAL.ULT_GAIN.W:BAL.ULT_GAIN.E);
    grantUlt(foe,BAL.ULT_GAIN.taken);
    // status application
    if(r.applyBurn){foe.status.burn=Math.max(foe.status.burn, BAL.STATUS_TURNS); logLine(`${foe.data.name} is burning!`);}
    if(r.applyShield){me.status.shield=Math.max(me.status.shield, BAL.STATUS_TURNS); logLine(`${me.data.name} gains a shield!`);}
    let tag=''; if(r.mult>1.01)tag=' Super effective!'; else if(r.mult<0.99)tag=' Not very effective…'; if(r.crit)tag+=' Crit!';
    floatText(foeS,`-${r.dmg}${r.crit?'★':''}`); logLine(`${me.data.name} used ${sp.name}!${tag}`);
    if(foe.hp<=0){logLine(`${foe.data.name} fainted!`); if(!switchIfDead(foeS)){renderAll(); endTurn(); const w=winner(); if(w) return endScreen(w);}}
  }
  me.cds[idx]=[2,3,3,4][idx]||3; renderAll(); endTurn();
}

// switching & items
function trySwitch(side,slot){
  const t=team(side); const cur=(side==='left'?S.li:S.ri);
  if(slot===cur) return; if(!t[slot]||t[slot].hp<=0) return; if(S.turn!==side) return;
  if(side==='left') S.li=slot; else S.ri=slot;
  // Swap penalty: -10% ult on the incoming unit
  const inc=active(side); inc.ult=Math.max(0,inc.ult-10);
  logLine(`${side==='left'?'P1':'P2'} switched to ${inc.data.name}! (Turn consumed, ULT -10%)`);
  renderAll(); endTurn();
}
$('#btnSwap').onclick=()=>{const t=team('left'); const cur=S.li; const alt=[0,1,2].find(i=>i!==cur && t[i] && t[i].hp>0); if(alt!=null) trySwitch('left',alt)};
$('#itemPotion').onclick=()=>usePotion('left'); $('#itemEther').onclick=()=>useEther('left');
function usePotion(side){if(S.turn!==side)return; const bag=S.items[side]; if(bag.potion<=0)return logLine('No potions left.'); const me=active(side); const heal=Math.round(me.max*.4); me.hp=Math.min(me.max,me.hp+heal); bag.potion--; logLine(`${side==='left'?'P1':'P2'} used Potion! +${heal}`); renderAll(); endTurn();}
function useEther(side){if(S.turn!==side)return; const bag=S.items[side]; if(bag.ether<=0)return logLine('No ethers left.'); const me=active(side); if(me.resType==='None')return logLine('No resource to restore.'); const gain=Math.round(me.resMax*.4); me.res=Math.min(me.resMax,me.res+gain); bag.ether--; logLine(`${side==='left'?'P1':'P2'} used Ether! +${gain} ${me.resType}`); renderAll(); endTurn();}

// CPU
function cpuAct(){
  if(S.turn!=='right'||S.p2!=='cpu')return;
  const me=active('right'); if(!me){endTurn();return;}
  if(me.hp<me.max*.35 && S.items.right.potion>0){S.items.right.potion--; const heal=Math.round(me.max*.4); me.hp=Math.min(me.max,me.hp+heal); logLine('CPU used Potion! +'+heal); renderAll(); return endTurn();}
  const ready=[0,1,2,3].filter(i=>me.cds[i]===0 && ((i===3 && me.ult>=BAL.ULT_REQ) || (i!==3 && (me.resType==='None'||me.res>=scost(me.data.spells[i],i,me.resType)))));
  if(ready.includes(3)) return actAbility('right',3);
  if(ready.length>0) return actAbility('right',ready[0]);
  basic('right');
}

// inspect overlay
function holdInspect(btn,sp,ch){let t=null,open=false; const start=()=>{t=setTimeout(()=>{open=true; openInspect(sp,ch);},420)}; const clear=()=>{if(t){clearTimeout(t);t=null}}; btn.addEventListener('mousedown',start); btn.addEventListener('touchstart',start,{passive:true}); ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=>btn.addEventListener(ev,()=>{if(!open)clear();},{passive:true}))}
function openInspect(sp,ch){$('#insName').textContent=sp.name; $('#insChamp').textContent=ch.data.name; $('#insDesc').innerHTML=clean(sp.tooltip); $('#insElem').textContent=spellElem(sp,ch.elem); $('#insDmgType').textContent=dmgType(sp,ch.data); const cd=Array.isArray(sp.cooldown)&&sp.cooldown.length?sp.cooldown[0]:2; $('#insCD').textContent=cd; const c=scost(sp,0,ch.resType)||0; $('#insCost').textContent=(c?c:0)+(ch.resType!=='None'?' '+ch.resType:''); $('#inspectOverlay').classList.remove('hidden');}
$('#insClose').onclick=()=>$('#inspectOverlay').classList.add('hidden'); $('#inspectOverlay').addEventListener('click',e=>{if(e.target.id==='inspectOverlay')$('#inspectOverlay').classList.add('hidden')});

// ---------- start / nav ----------
function showSelect(){ $('#selectScreen').classList.remove('hidden'); $('#battleScreen').classList.add('hidden');}
function showBattle(){ $('#selectScreen').classList.add('hidden'); $('#battleScreen').classList.remove('hidden');}
$('#backToSelect').onclick=showSelect; $('#resetBtn').onclick=showSelect;
$('#btnTryAgain').onclick=()=>{ $('#endOverlay').classList.add('hidden'); showSelect(); };
$('#btnResetBattle').onclick=()=>{ $('#endOverlay').classList.add('hidden'); showSelect(); };
function startBattle(){
  S.li=0; S.ri=0; S.turn='left';
  S.items.left={potion:2,ether:2}; S.items.right={potion:2,ether:2};
  // randomize a field to start
  const startF=FIELDS[Math.floor(Math.random()*FIELDS.length)];
  S.field={name:startF.name, turns:startF.turns, boost:startF.boost};
  // start‑turn statuses for P1
  startTurnTicks('left'); renderAll(); showBattle(); logLine(`Battle start! Field: ${S.field.name}. P1 to move.`);
}
E.startTop.onclick=startBattle;

// share
$('#shareBtn')?.addEventListener('click',async()=>{const L=S.left.map(c=>c?.data?.id||'').join(','); const R=S.right.map(c=>c?.data?.id||'').join(','); const url=new URL(location.href); url.search=new URLSearchParams({l:L,r:R,mode:S.p2}).toString(); try{await navigator.clipboard.writeText(url.toString()); alert('Link copied!');}catch{prompt('Copy link',url.toString());}});

// search / clear / random / p2
E.search.oninput=(e)=>renderRoster(e.target.value);
$('#clearPicks').onclick=()=>{S.left=[null,null,null]; S.right=[null,null,null]; drawPicks();};
$('#randomBoth').onclick=()=>{randomFill('left'); randomFill('right');};
E.p2ModeSelect.onchange=e=>S.p2=e.target.value;

// ---------- bootstrap ----------
(async function init(){
  try{
    S.version=(await J(VERS))[0];
    const short=await J(ddata(S.version,'champion.json')); S.champs=short.data;
    S.list=Object.values(S.champs).map(c=>({id:c.id,name:c.name,tags:c.tags,image:c.image}));
    renderRoster(); drawPicks();
  }catch(e){console.error(e); alert('Failed to load champion data.');}
})();
})();
</script>
</body>
</html>