<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Jimmy’s LoL Duel</title>
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128"><rect width="128" height="128" rx="24" fill="%230b1220"/><path fill="%23a855f7" d="M24 92 44 36h12L36 92zM70 92l20-56h12L82 92z"/><circle cx="64" cy="34" r="6" fill="%235a7cff"/></svg>'/>
<meta name="theme-color" content="#0b1220"/>
<meta name="description" content="Jimmy’s LoL Duel — roster-pick LoL duel with modal stats, CPU, items, elements, and flashy move FX."/>

<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config={theme:{extend:{
  keyframes:{
    hit:{'0%':{transform:'translateX(0) scale(1)'},'20%':{transform:'translateX(-6px) scale(1.02)'},'40%':{transform:'translateX(6px) scale(1.02)'},'60%':{transform:'translateX(-3px)'},'80%':{transform:'translateX(3px)'},'100%':{transform:'translateX(0) scale(1)'}},
    flash:{'0%':{opacity:0},'30%':{opacity:.55},'100%':{opacity:0}},
    float:{'0%':{transform:'translateY(0)',opacity:1},'100%':{transform:'translateY(-24px)',opacity:0}},
    blink:{'0%,100%':{opacity:1},'50%':{opacity:.1}}
  },
  animation:{hit:'hit .3s',flash:'flash .5s ease-out',float:'float .7s forwards',blink:'blink 1s steps(2,start) infinite'}
}}}
</script>
<style>
*{touch-action:manipulation}
canvas.radar{width:100%;height:140px}
</style>
</head>
<body class="bg-slate-950 text-slate-100 antialiased">
<header class="sticky top-0 z-50 backdrop-blur bg-slate-950/80 border-b border-white/10">
  <div class="mx-auto max-w-6xl px-3 sm:px-4 py-3 flex items-center gap-2">
    <div class="size-8 rounded-md bg-indigo-500/20 grid place-items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="size-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3 6 6 .9-4.5 4.3L17.8 20 12 16.9 6.2 20l1.3-6.8L3 8.9 9 8z"/></svg>
    </div>
    <div class="flex-1 min-w-0">
      <h1 class="text-lg font-semibold truncate">Jimmy’s LoL Duel</h1>
      <p class="text-xs text-slate-400 truncate">Roster pick • Modal stats • 3v3 • CPU/Human P2</p>
    </div>
    <button id="shareBtn" class="hidden sm:inline rounded-lg px-3 py-2 bg-white/10 hover:bg-white/15 text-sm">Share</button>
  </div>

  <!-- Sticky select toolbar -->
  <div id="selectToolbar" class="hidden border-t border-white/10 bg-slate-900/80">
    <div class="mx-auto max-w-6xl px-3 sm:px-4 py-2 flex items-center gap-2">
      <button id="startBattleTop" class="rounded-lg px-4 py-2 bg-indigo-600 hover:bg-indigo-500 font-semibold text-sm disabled:opacity-40 disabled:cursor-not-allowed" disabled>Start Battle</button>
      <div class="ml-2 text-xs flex items-center gap-2">
        <span>P2:</span>
        <select id="p2ModeTop" class="rounded bg-slate-900/70 border border-white/10 px-2 py-1.5">
          <option value="cpu" selected>CPU</option>
          <option value="human">Human</option>
        </select>
        <button id="randomBothTop" class="rounded px-3 py-1.5 bg-white/10 hover:bg-white/15">Randomize</button>
      </div>
      <div class="ml-auto text-xs text-slate-400">Tap a champion to open the **Stats & Pick** modal</div>
    </div>
  </div>
</header>

<main class="mx-auto max-w-6xl px-3 sm:px-4 py-4 md:py-8">
  <!-- =================== SELECT (with sticky toolbar) =================== -->
  <section id="selectScreen" class="space-y-3">
    <div class="rounded-xl border border-white/10 bg-gradient-to-b from-slate-900 to-slate-950 p-3 md:p-4">
      <div class="flex items-center justify-between gap-2">
        <h2 class="text-sm font-semibold">Pick Teams (tap a tile → modal)</h2>
        <div class="text-xs flex items-center gap-2">
          <button id="clearPicks" class="rounded-md px-3 py-1.5 bg-white/10 hover:bg-white/15">Clear</button>
        </div>
      </div>

      <!-- Selected rows -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
        <div class="rounded-lg border border-white/10 bg-white/5 p-2">
          <div class="text-xs font-semibold mb-2">Player 1</div>
          <div id="leftPicks" class="flex gap-2"></div>
        </div>
        <div class="rounded-lg border border-white/10 bg-white/5 p-2">
          <div class="text-xs font-semibold mb-2">Player 2 / CPU</div>
          <div id="rightPicks" class="flex gap-2 justify-end"></div>
        </div>
      </div>

      <!-- Search + Roster -->
      <div class="mt-3">
        <input id="rosterSearch" class="w-full rounded-lg bg-slate-900/70 border border-white/10 px-3 py-2 text-sm" placeholder="Search champions…">
        <div id="roster" class="mt-2 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2"></div>
      </div>

      <!-- (Secondary) start at bottom for desktop / fallback -->
      <div class="mt-3 flex items-center gap-2">
        <button id="startBattleBottom" class="rounded-lg px-4 py-2 bg-indigo-600 hover:bg-indigo-500 font-semibold text-sm disabled:opacity-40 disabled:cursor-not-allowed" disabled>Start Battle</button>
        <button id="randomBothBottom" class="rounded-lg px-4 py-2 bg-white/10 hover:bg-white/15">Randomize</button>
      </div>
    </div>
  </section>

  <!-- =================== BATTLE =================== -->
  <section id="battleScreen" class="hidden">
    <div class="rounded-lg border border-white/10 bg-white/5 px-3 py-2 text-xs flex items-center gap-2 mb-3">
      <span class="opacity-70">Field:</span><span id="fieldName">Calm</span>
      <span class="opacity-70">⏳</span><span id="fieldTurns">5</span>
      <span class="ml-auto opacity-70" id="turnBadge">Turn: P1</span>
      <button id="backToSelect" class="ml-2 rounded-md px-2 py-1 bg-white/10 hover:bg-white/15">Change Teams</button>
    </div>

    <!-- Arena (non-overlapping HUD) -->
    <div id="arenaWrap" class="rounded-2xl border border-white/10 overflow-hidden bg-slate-900">
      <div class="p-3 sm:p-4 bg-[radial-gradient(ellipse_at_center,_rgba(22,22,32,.6),_rgba(2,6,23,.95))] relative">
        <div id="arenaFlash" class="pointer-events-none absolute inset-0"></div>

        <!-- Enemy -->
        <div class="flex justify-end mb-6">
          <div class="flex items-center gap-3 max-w-xl">
            <img id="rightIcon" class="size-20 sm:size-24 rounded-full ring-2 ring-white/20 object-cover" alt="">
            <div class="flex-1 rounded-xl border border-white/10 bg-white/5 p-2">
              <div class="flex items-center gap-2">
                <div class="min-w-0">
                  <div id="rightName" class="text-sm font-semibold truncate">—</div>
                  <div id="rightTags" class="text-[10px] text-slate-300 truncate">—</div>
                </div>
                <div id="rightBadges" class="ml-auto text-[10px] flex gap-1"></div>
              </div>
              <div class="mt-1 h-2 bg-slate-800 rounded overflow-hidden"><div id="rightHpBar" class="h-full bg-rose-500 transition-all"></div></div>
              <div class="mt-1 text-[11px] text-slate-300"><span id="rightHpText">HP —/—</span> · <span id="rightResMini"></span></div>
            </div>
          </div>
        </div>

        <!-- Player -->
        <div class="flex justify-start">
          <div class="flex items-center gap-3 max-w-xl">
            <img id="leftIcon" class="size-20 sm:size-24 rounded-full ring-2 ring-white/20 object-cover" alt="">
            <div class="flex-1 rounded-xl border border-white/10 bg-white/5 p-2">
              <div class="flex items-center gap-2">
                <div class="min-w-0">
                  <div id="leftName" class="text-sm font-semibold truncate">—</div>
                  <div id="leftTags" class="text-[10px] text-slate-300 truncate">—</div>
                </div>
                <div id="leftBadges" class="ml-auto text-[10px] flex gap-1"></div>
              </div>
              <div class="mt-1 h-2 bg-slate-800 rounded overflow-hidden"><div id="leftHpBar" class="h-full bg-green-500 transition-all"></div></div>
              <div class="mt-1 text-[11px] text-slate-300"><span id="leftHpText">HP —/—</span> · <span id="leftResMini"></span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Controls -->
      <div class="p-3 sm:p-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div id="leftPanel" class="rounded-xl bg-white/5 border border-white/10 p-2">
          <div class="flex items-center justify-between mb-1">
            <div class="text-xs font-semibold">Abilities (hold to inspect)</div>
            <div id="p2ModeBadge" class="text-[11px]">CPU</div>
          </div>
          <div id="leftAbilities" class="grid grid-cols-5 gap-1.5 sm:gap-2"></div>
          <div class="mt-3 flex items-center gap-2">
            <div class="text-xs font-semibold">Items</div>
            <button id="itemPotion" class="rounded-md px-2 py-1.5 text-xs bg-emerald-600/70 hover:bg-emerald-600">Potion (x<span id="potionLeftL">2</span>)</button>
            <button id="itemEther"  class="rounded-md px-2 py-1.5 text-xs bg-sky-600/70 hover:bg-sky-600">Ether (x<span id="etherLeftL">2</span>)</button>
            <button id="btnSwap" class="ml-auto rounded-md px-2 py-1.5 text-xs bg-white/10 hover:bg-white/15">Switch</button>
          </div>
          <div id="leftBench" class="mt-2 flex gap-2"></div>
        </div>

        <div id="rightPanel" class="rounded-xl bg-white/5 border border-white/10 p-2 opacity-60">
          <div class="flex items-center justify-between mb-1">
            <div class="text-xs font-semibold">Opponent</div>
            <div id="oppItemsInfo" class="text-[11px]">Items: Potion x<span id="potionLeftR">2</span>, Ether x<span id="etherLeftR">2</span></div>
          </div>
          <details id="rightAbilitiesWrap" class="group">
            <summary class="cursor-pointer text-xs text-slate-300 flex items-center gap-2 select-none">
              <span id="rightAbilitiesLabel">Enemy Skills (CPU)</span>
              <span class="ml-auto text-slate-500 transition group-open:rotate-90">▸</span>
            </summary>
            <div id="rightAbilities" class="mt-2 grid grid-cols-5 gap-1.5 sm:gap-2 opacity-70"></div>
          </details>
          <div id="rightBench" class="mt-2 flex gap-2 justify-end"></div>
        </div>
      </div>

      <!-- Live feed -->
      <div class="bg-slate-900/90 border-t border-white/10">
        <div class="px-3 sm:px-4 py-3 font-mono text-sm flex items-center gap-2">
          <span class="animate-blink">▶</span>
          <div id="liveMsg" class="truncate" aria-live="polite">Welcome to Jimmy’s LoL Duel!</div>
          <div class="ml-auto">
            <button id="resetBtn" class="rounded-lg px-2.5 py-1.5 text-xs bg-white/10 hover:bg-white/15">Reset</button>
          </div>
        </div>
        <details class="px-3 sm:px-4 pb-4">
          <summary class="cursor-pointer text-xs text-slate-300">Battle Log</summary>
          <div id="log" class="mt-2 space-y-2 max-h-56 overflow-auto text-sm"></div>
        </details>
      </div>
    </div>
  </section>
</main>

<!-- Ability Inspect -->
<div id="inspectOverlay" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden z-[60]">
  <div class="absolute inset-0 grid place-items-center p-4">
    <div class="max-w-md w-full rounded-xl border border-white/10 bg-slate-900 p-4">
      <div class="text-sm font-semibold" id="insName">Ability</div>
      <div class="text-xs text-slate-300 mt-1" id="insChamp">Champion</div>
      <div class="mt-2 h-px bg-white/10"></div>
      <div class="mt-2 text-sm" id="insDesc"></div>
      <div class="mt-3 grid grid-cols-2 gap-2 text-xs">
        <div><span class="text-slate-400">Element:</span> <span id="insElem"></span></div>
        <div><span class="text-slate-400">Type:</span> <span id="insDmgType"></span></div>
        <div><span class="text-slate-400">Cost:</span> <span id="insCost"></span></div>
        <div><span class="text-slate-400">Cooldown:</span> <span id="insCD"></span></div>
      </div>
      <div class="mt-4 text-right"><button id="insClose" class="rounded-md px-3 py-1.5 bg-white/10 hover:bg-white/15 text-sm">Close</button></div>
    </div>
  </div>
</div>

<!-- Pick Modal (mobile-first) -->
<div id="pickModal" class="fixed inset-0 hidden z-[70]">
  <div class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
  <div class="absolute inset-0 p-4 grid place-items-center">
    <div class="w-full max-w-lg rounded-xl border border-white/10 bg-slate-900 p-3 sm:p-4">
      <div class="flex items-center gap-3">
        <img id="pmIcon" class="size-14 rounded-md ring-1 ring-white/10 object-cover" alt="">
        <div class="min-w-0">
          <div id="pmName" class="text-base font-semibold truncate"></div>
          <div id="pmTags" class="text-xs text-slate-300 truncate"></div>
        </div>
        <div id="pmElem" class="ml-auto text-xs px-2 py-1 rounded bg-white/10"></div>
      </div>
      <canvas id="pmRadar" width="360" height="220" class="mt-3 w-full rounded-lg bg-slate-950 border border-white/10"></canvas>
      <div id="pmSpells" class="mt-3 grid grid-cols-2 gap-2 text-sm"></div>
      <div class="mt-4 flex items-center gap-2">
        <button id="pmAddL" class="rounded-lg px-3 py-2 bg-indigo-600 hover:bg-indigo-500 font-semibold text-sm">Add to P1</button>
        <button id="pmAddR" class="rounded-lg px-3 py-2 bg-rose-600 hover:bg-rose-500 font-semibold text-sm">Add to P2</button>
        <button id="pmClose" class="ml-auto rounded-lg px-3 py-2 bg-white/10 hover:bg-white/15 text-sm">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- End screen -->
<div id="endOverlay" class="fixed inset-0 hidden z-[80]">
  <div id="endArt" class="absolute inset-0 opacity-20 md:opacity-30 bg-cover bg-center"></div>
  <div class="absolute inset-0 bg-gradient-to-b from-slate-900/90 to-black/95 backdrop-blur-sm"></div>
  <div class="relative h-full flex flex-col items-center justify-center p-6">
    <div id="endTitle" class="text-5xl sm:text-6xl font-extrabold"></div>
    <div id="endSubtitle" class="mt-2 text-slate-300"></div>
    <div class="mt-8 flex gap-3">
      <button id="btnTryAgain" class="rounded-lg px-5 py-3 bg-indigo-600 hover:bg-indigo-500 font-semibold">Try Again</button>
      <button id="btnResetBattle" class="rounded-lg px-5 py-3 bg-white/10 hover:bg-white/15">Back to Select</button>
    </div>
  </div>
</div>

<script>
;(()=>{
const $=(s,e=document)=>e.querySelector(s);
const $$=(s,e=document)=>[...e.querySelectorAll(s)];
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
const live=(m)=>{$('#liveMsg').textContent=m;};
const flashArena=()=>{$('#arenaFlash').className='pointer-events-none absolute inset-0 bg-white/50 animate-flash'; setTimeout(()=>$('#arenaFlash').className='pointer-events-none absolute inset-0',520);};

const TURN_DELAY_MS=900;
const BAL={BASE_HP:240,ROLE_HP_BONUS:{Tank:80,Fighter:40},BASE_DMG:[70,90,80,130],BASIC_ATK:55,AOE:.75,SHIELD:.30,WEAKEN:.80,BURN:.10,CRIT:.1,CRITM:1.75,MISS:.07,RES:{Mana:{max:100,regen:15,costs:[20,25,25,45]},Energy:{max:100,regen:22,costs:[20,25,25,40]},None:{max:0,regen:0,costs:[0,0,0,0]}}};
const EFF={Fire:{Wind:1.2,Earth:.5,Water:.5},Water:{Fire:2,Earth:1.2,Electric:.5},Electric:{Water:2,Wind:1.5,Earth:.5},Wind:{Earth:2,Fire:.8},Earth:{Electric:2,Wind:.5,Fire:1.2},Arcane:{Dark:1.2,Light:.8},Dark:{Light:2,Arcane:.8},Light:{Dark:2,Arcane:1.2},Physical:{}};
const DDRAGON='https://ddragon.leagueoflegends.com';
const ddata=(v,p)=>`${DDRAGON}/cdn/${v}/data/en_US/${p}`;
const imgChamp=(v,f)=>`${DDRAGON}/cdn/${v}/img/champion/${f}`;
const imgSpell=(v,f)=>`${DDRAGON}/cdn/${v}/img/spell/${f}`;
const splash=(id)=>`${DDRAGON}/cdn/img/champion/splash/${id}_0.jpg`;
async function j(u){const r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw new Error(r.status); return r.json();}

const RE_MAGIC=/(magic damage|magical|ap)/i, RE_PHYS=/(physical damage|ad|attack damage)/i, RE_DEF=/(shield|barrier)/i, RE_AOE=/(area|nearby|all enemies|cone|around)/i, RE_HEAL=/(heal|restore)/i;
function dmgType(sp,ch){const t=((sp.tooltip||'')+' '+(sp.description||'')).toLowerCase(); if(RE_MAGIC.test(t))return'magic'; if(RE_PHYS.test(t))return'physical'; return ch.tags?.includes('Mage')?'magic':'physical'}
function classify(sp){const t=(sp.tooltip||'')+' '+(sp.description||''); return{heal:RE_HEAL.test(t),aoe:RE_AOE.test(t),shield:RE_DEF.test(t)}}
function champElem(f){const t=f.tags||[]; if(t.includes('Mage'))return'Arcane'; if(t.includes('Marksman'))return'Wind'; if(t.includes('Tank'))return'Earth'; if(t.includes('Fighter'))return'Earth'; if(t.includes('Assassin'))return'Dark'; if(t.includes('Support'))return'Light'; return'Physical'}
function spellElem(sp,fb){const s=((sp.tooltip||'')+' '+(sp.description||'')).toLowerCase(); if(/\b(fire|ignite|flame)\b/.test(s))return'Fire'; if(/\b(water|ice|frost|tide)\b/.test(s))return'Water'; if(/\b(lightning|electric|storm|thunder)\b/.test(s))return'Electric'; if(/\b(wind|gale|gust)\b/.test(s))return'Wind'; if(/\b(earth|stone|rock|quake)\b/.test(s))return'Earth'; if(/\b(holy|light)\b/.test(s))return'Light'; if(/\b(shadow|dark)\b/.test(s))return'Dark'; return fb||'Physical'}
function tt(sp){return String(sp.tooltip||'').replace(/<\/?br\s*\/?>/gi,'<br>').replace(/\{\{[^}]+\}\}/g,'').trim()}
function resType(f){const p=(f.partype||'').toLowerCase(); if(p.includes('mana'))return'Mana'; if(p.includes('energy'))return'Energy'; return'None'}
function buildChamp(full){const base=BAL.BASE_HP+(full.tags||[]).reduce((a,t)=>a+(BAL.ROLE_HP_BONUS[t]||0),0); const rt=resType(full), R=BAL.RES[rt]; return{data:full, elem:champElem(full), tags:full.tags||[], hp:base, max:base, cds:[0,0,0,0], resType:rt, res:R.max, resMax:R.max, statuses:{shield:0,weaken:0,burn:0,slow:0, roleMods:{magic:(full.tags||[]).includes('Mage')?1.05:1, physical:(full.tags||[]).some(x=>['Marksman','Fighter','Assassin'].includes(x))?1.05:1}}}}

const S={version:null, champs:{}, list:[], left:[null,null,null], right:[null,null,null], li:0, ri:0, turn:'left', p2:'cpu', items:{left:{potion:2,ether:2}, right:{potion:2,ether:2}} };
const els={leftPicks:'#leftPicks', rightPicks:'#rightPicks', roster:'#roster'};

function drawRadar(cv,labels,vals){const ctx=cv.getContext('2d');const W=cv.width,H=cv.height,cx=W/2,cy=H/2+8,r=Math.min(W,H)*.36,steps=5;ctx.clearRect(0,0,W,H);ctx.strokeStyle='rgba(148,163,184,.35)';ctx.lineWidth=1;
  for(let s=1;s<=steps;s++){ctx.beginPath();for(let i=0;i<labels.length;i++){const a=(Math.PI*2/labels.length)*i-Math.PI/2,rr=r*s/steps,x=cx+rr*Math.cos(a),y=cy+rr*Math.sin(a);i?ctx.lineTo(x,y):ctx.moveTo(x,y);}ctx.closePath();ctx.stroke();}
  for(let i=0;i<labels.length;i++){const a=(Math.PI*2/labels.length)*i-Math.PI/2,x=cx+r*Math.cos(a),y=cy+r*Math.sin(a);ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(x,y);ctx.stroke();}
  ctx.fillStyle='rgba(99,102,241,.28)';ctx.strokeStyle='rgba(99,102,241,.85)';ctx.beginPath();
  for(let i=0;i<labels.length;i++){const a=(Math.PI*2/labels.length)*i-Math.PI/2,rr=r*(vals[i]/10),x=cx+rr*Math.cos(a),y=cy+rr*Math.sin(a);i?ctx.lineTo(x,y):ctx.moveTo(x,y);}ctx.closePath();ctx.fill();ctx.stroke();
  ctx.fillStyle='rgba(203,213,225,.9)';ctx.font='12px system-ui';labels.forEach((lb,i)=>{const a=(Math.PI*2/labels.length)*i-Math.PI/2,x=cx+(r+14)*Math.cos(a),y=cy+(r+14)*Math.sin(a);ctx.textAlign=Math.cos(a)>0.2?'left':(Math.cos(a)<-0.2?'right':'center');ctx.fillText(lb,x,y);});
}

function renderPicks(){
  const pill=(c,side,idx)=>c?`<div class="relative">
    <img class="size-14 rounded ring-2 ${side==='left'?'ring-indigo-500':'ring-rose-500'} object-cover" src="${imgChamp(S.version,c.data.image.full)}" alt="">
    <div class="absolute -top-1 -left-1 bg-black/70 rounded text-[10px] px-1">${idx+1}</div>
  </div>`:`<div class="size-14 rounded border border-dashed border-white/15"></div>`;
  $(els.leftPicks).innerHTML=S.left.map((x,i)=>pill(x,'left',i)).join('');
  $(els.rightPicks).innerHTML=S.right.map((x,i)=>pill(x,'right',i)).join('');
  const ready = S.left.every(Boolean) && S.right.every(Boolean);
  $('#startBattleTop').disabled=!ready; $('#startBattleBottom').disabled=!ready;
}

function openPickModal(c){
  $('#pmIcon').src=imgChamp(S.version,c.image.full);
  $('#pmName').textContent=c.name; $('#pmTags').textContent=(c.tags||[]).join(' • '); $('#pmElem').textContent=champElem(c);
  const info=c.info||{attack:5,defense:5,magic:5,difficulty:5}; const speed=(c.tags||[]).some(t=>['Assassin','Marksman'].includes(t))?8:(c.tags||[]).includes('Tank')?4:6;
  drawRadar($('#pmRadar'),['Attack','Defense','Magic','Speed','Control'],[info.attack||5,info.defense||5,info.magic||5,speed,info.difficulty||5]);
  $('#pmSpells').innerHTML='Loading…';
  fetch(`${DDRAGON}/cdn/${S.version}/data/en_US/champion/${c.id}.json`).then(r=>r.json()).then(js=>{
    const full=js.data[c.id]; $('#pmSpells').innerHTML=(full.spells||[]).map(s=>`<div class="flex items-center gap-2"><img class="size-6" src="${imgSpell(S.version,s.image.full)}" alt=""><div class="truncate">${s.name}</div></div>`).join('');
    // wire add buttons to load full champ state
    const add=async(side)=>{const st=buildChamp(full); const list=side==='left'?S.left:S.right; const slot=list.findIndex(x=>!x); if(slot===-1) return; list[slot]=st; renderPicks(); closePickModal();};
    $('#pmAddL').onclick=()=>add('left'); $('#pmAddR').onclick=()=>add('right');
  }).catch(()=>$('#pmSpells').textContent='—');
  $('#pickModal').classList.remove('hidden');
}
function closePickModal(){ $('#pickModal').classList.add('hidden'); }
$('#pmClose').onclick=closePickModal;
$('#pickModal').addEventListener('click',e=>{ if(e.target.id==='pickModal') closePickModal(); });

function renderRoster(filter=''){
  const R=$(els.roster); R.innerHTML='';
  const q=filter.trim().toLowerCase();
  S.list.filter(c=>!q||c.name.toLowerCase().includes(q)||c.id.toLowerCase().includes(q)).forEach(c=>{
    const el=champElem(c);
    const card=document.createElement('button');
    card.className='group relative text-left rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 p-2';
    card.innerHTML=`
      <img class="w-full aspect-square object-cover rounded-md ring-1 ring-white/10 mb-2" src="${imgChamp(S.version,c.image.full)}" alt="">
      <div class="font-medium text-sm truncate">${c.name}</div>
      <div class="text-[10px] text-slate-400 truncate">${(c.tags||[]).join(' • ')}</div>
      <div class="absolute top-2 right-2 text-[10px] bg-black/50 px-1.5 py-0.5 rounded">${el}</div>`;
    card.addEventListener('click',()=>openPickModal(c));
    R.appendChild(card);
  });
}

/* ---------- battle bits (from previous good build) ---------- */
function active(s){return (s==='left'?S.left:S.right)[s==='left'?S.li:S.ri]}
function team(s){return s==='left'?S.left:S.right}
function enemy(s){return s==='left'?'right':'left'}
function floatText(side,txt,kind='d'){const host=side==='left'?$('#leftIcon'):$('#rightIcon'); const n=document.createElement('div'); const r=host.getBoundingClientRect(); n.style.position='fixed'; n.style.left=(r.left+r.width/2-16)+'px'; n.style.top=(r.top-8)+'px'; n.innerHTML=`<span class="px-2 py-0.5 rounded ${kind==='h'?'bg-emerald-600/80':'bg-black/70'} text-white text-lg font-extrabold">${txt}</span>`; document.body.appendChild(n); n.classList.add('animate-float'); setTimeout(()=>n.remove(),760);}
function eff(a,b){return (EFF[a]&&EFF[a][b])||1}
function abBase(i){return BAL.BASE_DMG[i]||80}
function scost(sp,i,rt){const C=BAL.RES[rt||'None']; let c=0; if(Array.isArray(sp.cost)&&sp.cost.length)c=+sp.cost[0]; if(!c&&sp.costBurn){const m=sp.costBurn.match(/\d+/); if(m)c=+m[0];} if(!c)c=C.costs[i]||0; return c}
function compute(att,tar,idx,sp){const f=classify(sp), t=dmgType(sp,att.data), el=spellElem(sp,att.elem); if(f.heal) return{heal:true,el}; if(Math.random()<BAL.MISS) return{miss:true,el}; let base=abBase(idx); if(idx===3) base*=1.4; base*=(t==='magic'?att.statuses.roleMods.magic:att.statuses.roleMods.physical); let mult=eff(el,tar.elem); let crit=false; if(Math.random()<BAL.CRIT){crit=true;base*=BAL.CRITM;} const dmg=Math.max(20,Math.round(base*mult)); return{dmg,crit,mult,el,aoe:f.aoe}}
function renderHUD(side){
  const cur=active(side), isL=side==='left';
  const icon=$(isL?'#leftIcon':'#rightIcon'), name=$(isL?'#leftName':'#rightName'), tags=$(isL?'#leftTags':'#rightTags'), hpbar=$(isL?'#leftHpBar':'#rightHpBar'), hptext=$(isL?'#leftHpText':'#rightHpText'), resmini=$(isL?'#leftResMini':'#rightResMini'), abil=$(isL?'#leftAbilities':'#rightAbilities'), bench=$(isL?'#leftBench':'#rightBench');
  if(!cur){icon.src=''; name.textContent='—'; tags.textContent=''; hpbar.style.width='0%'; hptext.textContent='HP —/—'; resmini.textContent=''; abil.innerHTML=''; bench.innerHTML=''; return;}
  icon.src=imgChamp(S.version,cur.data.image.full);
  name.textContent=`${cur.data.name} (${cur.elem})`; tags.textContent=(cur.data.tags||[]).join(' / ');
  hpbar.style.width=Math.max(0,Math.min(100,(cur.hp/cur.max)*100))+'%'; hptext.textContent=`HP ${Math.max(0,Math.round(cur.hp))}/${cur.max}`;
  resmini.textContent=cur.resType!=='None'?`${cur.resType} ${Math.round(cur.res)}/${cur.resMax}`:'';
  // abilities
  abil.innerHTML='';
  const myTurn=(S.turn===side)&&!(side==='right'&&S.p2==='cpu');
  (isL?$('#leftPanel'):$('#rightPanel')).style.opacity=myTurn?'1':'0.6';
  const disable=myTurn?'':'pointer-events-none opacity-60';
  // basic
  const bA=document.createElement('button');
  bA.className=`relative aspect-square rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 ${disable}`;
  bA.innerHTML=`<div class="absolute top-1 left-1 text-[10px] px-1.5 py-0.5 rounded ${isL?'bg-indigo-600':'bg-rose-600'}">A</div><div class="grid place-items-center h-full"><svg viewBox="0 0 24 24" class="w-8 h-8" fill="currentColor"><path d="M7 14l-4.5 4.5a2 2 0 102.8 2.8L9.8 16.8 7 14zm6.1-1.7l2.6 2.6L22 6.6 17.4 2l-7.3 6.3 3 3zM3.7 21.4a.99.99 0 11-1.4-1.4l2.3-2.3 1.4 1.4-2.3 2.3z"/></svg></div>`;
  bA.onclick=()=>basic('left'===side?'left':'right');
  abil.appendChild(bA);
  (cur.data.spells||[]).slice(0,4).forEach((sp,i)=>{
    const cd=cur.cds[i]||0, cost=scost(sp,i,cur.resType);
    const d=(!myTurn||cd>0||(cur.resType!=='None'&&cur.res<cost));
    const btn=document.createElement('button');
    btn.className=`relative aspect-square rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 overflow-hidden ${d?'pointer-events-none opacity-50':''}`;
    btn.dataset.idx=i; btn.dataset.side=side;
    btn.innerHTML=`<div class="absolute top-1 left-1 text-[10px] px-1.5 py-0.5 rounded ${isL?'bg-indigo-600':'bg-rose-600'}">${['Q','W','E','R'][i]}</div>${cost?`<div class="absolute top-1 right-1 text-[10px] px-1 py-0.5 rounded bg-black/60">${cost}</div>`:''}<img class="w-full h-full object-cover" src="${imgSpell(S.version,sp.image.full)}" alt="${sp.name}">${cd>0?`<div class="absolute inset-0 bg-black/60 grid place-items-center text-sm font-semibold">${cd}</div>`:''}`;
    btn.onclick=onAbility;
    holdInspect(btn,sp,cur);
    abil.appendChild(btn);
  });
  // bench
  const pill=(ch,isActive,side,idx)=> ch?`<button class="bench w-20 rounded-md border ${isActive?'border-indigo-500':'border-white/10'} bg-white/5 p-1 ${disable}" data-side="${side}" data-slot="${idx}">
    <img class="w-full h-10 object-cover rounded" src="${imgChamp(S.version,ch.data.image.full)}" alt="">
    <div class="mt-1 h-1.5 bg-slate-800 rounded overflow-hidden"><div style="width:${Math.max(0,Math.min(100,(ch.hp/ch.max)*100))}%;" class="h-full ${ch.hp/ch.max>.5?'bg-green-500':ch.hp/ch.max>.2?'bg-yellow-400':'bg-rose-500'}"></div></div>
  </button>`:'';
  bench.innerHTML=team(side).map((c,i)=>pill(c,i===(side==='left'?S.li:S.ri),side,i)).join('');
  bench.querySelectorAll('.bench').forEach(b=>b.addEventListener('click',()=>trySwitch(side,+b.dataset.slot)));
}
function renderAll(){renderHUD('left');renderHUD('right');$('#turnBadge').textContent=`Turn: ${S.turn==='left'?'P1':(S.p2==='cpu'?'CPU':'P2')}`; $('#potionLeftL').textContent=S.items.left.potion; $('#etherLeftL').textContent=S.items.left.ether; $('#potionLeftR').textContent=S.items.right.potion; $('#etherLeftR').textContent=S.items.right.ether;}
function logLine(m){const d=document.createElement('div'); d.className='rounded-lg border border-white/10 bg-white/5 px-3 py-2'; d.textContent=m; $('#log').prepend(d); while($('#log').children.length>150)$('#log').lastChild.remove(); live(m);}
function winner(){const L=S.left.filter(Boolean).every(s=>s.hp<=0), R=S.right.filter(Boolean).every(s=>s.hp<=0); if(L) return 'right'; if(R) return 'left'; return null;}
function onAbility(e){const side=e.currentTarget.dataset.side, idx=+e.currentTarget.dataset.idx; if(S.turn!==side) return; if(side==='right'&&S.p2==='cpu') return; actAbility(side,idx);}
function actAbility(side,idx){const me=active(side), foe=active(enemy(side)); if(!me||!foe) return; const sp=(me.data.spells||[])[idx], cost=scost(sp,idx,me.resType); if(me.resType!=='None'&&me.res<cost){logLine(`${me.data.name} lacks ${me.resType}!`); return;} if(me.resType!=='None') me.res=Math.max(0,me.res-cost); const r=compute(me,foe,idx,sp); flashArena(); $('#arenaWrap').classList.add('animate-hit'); setTimeout(()=>$('#arenaWrap').classList.remove('animate-hit'),320); if(r.heal){const heal=Math.round(me.max*.22); me.hp=Math.min(me.max,me.hp+heal); floatText(side,'+'+heal,'h'); logLine(`${me.data.name} used ${sp.name}. +${heal} HP`);} else if(r.miss){logLine(`${me.data.name} used ${sp.name}… missed!`);} else { if(r.aoe){team(enemy(side)).forEach(t=>{if(!t||t.hp<=0)return; const dd=Math.round(r.dmg*BAL.AOE); t.hp=Math.max(0,t.hp-dd);}); logLine(`${me.data.name} used ${sp.name} — AOE!`);} else {foe.hp=Math.max(0,foe.hp-r.dmg); let tag=''; if(r.mult>1.01)tag=' Super effective!'; else if(r.mult<0.99)tag=' Not very effective…'; if(r.crit)tag+=' Crit!'; floatText(enemy(side),`-${r.dmg}${r.crit?'★':''}`); logLine(`${me.data.name} used ${sp.name}!${tag}`);} if(foe.hp<=0){logLine(`${foe.data.name} fainted!`); if(!switchIfDead(enemy(side))){renderAll(); endTurn(); const w=winner(); if(w) return endScreen(w);}} } me.cds[idx]=[2,3,3,4][idx]||3; renderAll(); endTurn();}
function basic(side){const me=active(side), foe=active(enemy(side)); if(!me||!foe) return; flashArena(); $('#arenaWrap').classList.add('animate-hit'); setTimeout(()=>$('#arenaWrap').classList.remove('animate-hit'),320); let base=BAL.BASIC_ATK; const t=me.tags||[]; if(t.includes('Marksman')||t.includes('Fighter')||t.includes('Assassin')) base*=1.1; if(t.includes('Mage')) base*=.9; if(t.includes('Tank')) base*=.95; if(Math.random()<BAL.MISS){logLine(`${me.data.name} attacked… missed!`);} else { let mult=eff('Physical',foe.elem); const dmg=Math.max(18,Math.round(base*mult)); foe.hp=Math.max(0,foe.hp-dmg); floatText(enemy(side),`-${dmg}`); logLine(`${me.data.name} used a basic attack!${mult>1.01?' Super effective!':(mult<0.99?' Not very effective…':'')}`); if(foe.hp<=0){logLine(`${foe.data.name} fainted!`); if(!switchIfDead(enemy(side))){renderAll(); endTurn(); const w=winner(); if(w) return endScreen(w);}} } renderAll(); endTurn();}
function endTurn(){const w=winner(); if(w) return endScreen(w); const next=S.turn==='left'?'right':'left'; const a=active(next); if(a){const C=BAL.RES[a.resType]||{regen:0}; a.res=clamp(a.res+(C.regen||0),0,a.resMax); a.cds=a.cds.map(c=>Math.max(0,c-1));} S.turn=next; renderAll(); if(S.turn==='right'&&S.p2==='cpu') setTimeout(cpuAct,TURN_DELAY_MS);}
function switchIfDead(side){const t=team(side); for(let i=0;i<3;i++){if(t[i]&&t[i].hp>0){if(side==='left')S.li=i; else S.ri=i; return true;}} return false;}
function trySwitch(side,slot){const t=team(side); const cur=(side==='left'?S.li:S.ri); if(slot===cur) return; if(!t[slot]||t[slot].hp<=0) return; if(S.turn!==side) return; if(side==='left')S.li=slot; else S.ri=slot; logLine(`${side==='left'?'P1':'P2'} switched to ${t[slot].data.name}!`); renderAll(); endTurn();}
function usePotion(side){if(S.turn!==side) return; const bag=S.items[side]; if(bag.potion<=0) return logLine('No potions left.'); const me=active(side); const heal=Math.round(me.max*.4); me.hp=Math.min(me.max,me.hp+heal); bag.potion--; logLine(`${side==='left'?'P1':'P2'} used Potion! +${heal} HP.`); renderAll(); endTurn();}
function useEther(side){if(S.turn!==side) return; const bag=S.items[side]; if(bag.ether<=0) return logLine('No ethers left.'); const me=active(side); if(me.resType==='None') return logLine('No resource.'); const gain=Math.round(me.resMax*.4); me.res=Math.min(me.resMax,me.res+gain); bag.ether--; logLine(`${side==='left'?'P1':'P2'} used Ether! +${gain} ${me.resType}.`); renderAll(); endTurn();}
function cpuAct(){if(S.turn!=='right'||S.p2!=='cpu')return; const me=active('right'); if(!me){endTurn();return;} if(me.hp<me.max*.35&&S.items.right.potion>0){S.items.right.potion--; const heal=Math.round(me.max*.4); me.hp=Math.min(me.max,me.hp+heal); logLine('CPU used Potion!'); renderAll(); return endTurn();} const ready=[0,1,2,3].filter(i=>me.cds[i]===0 && (me.resType==='None'||me.res>=scost(me.data.spells[i],i,me.resType))); if(ready.length===0) return basic('right'); actAbility('right',ready[0]);}
function endScreen(win){$('#endOverlay').classList.remove('hidden'); const p1=win==='left'; $('#endTitle').textContent=p1?'VICTORY':'DEFEAT'; $('#endTitle').className='text-5xl sm:text-6xl font-extrabold '+(p1?'text-emerald-400':'text-rose-400'); const id=active(win)?.data?.id; if(id) $('#endArt').style.backgroundImage=`url('${splash(id)}')`; $('#endSubtitle').textContent=p1?'You defeated the opponent!':'Your team has fallen.';}
function holdInspect(btn,sp,ch){let t=null,open=false; const start=()=>{t=setTimeout(()=>{open=true; openInspect(sp,ch);},420)}; const clear=()=>{if(t)clearTimeout(t)}; btn.addEventListener('mousedown',start); btn.addEventListener('touchstart',start,{passive:true}); ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=>btn.addEventListener(ev,()=>{if(!open)clear();},{passive:true}));}
function openInspect(sp,ch){$('#insName').textContent=sp.name; $('#insChamp').textContent=ch.data.name; $('#insDesc').innerHTML=tt(sp)||'—'; $('#insElem').textContent=spellElem(sp,ch.elem); $('#insDmgType').textContent=dmgType(sp,ch.data); const cd=Array.isArray(sp.cooldown)&&sp.cooldown.length?sp.cooldown[0]:2; $('#insCD').textContent=cd; const cost=scost(sp,0,ch.resType)||0; $('#insCost').textContent=(cost?cost:0)+(ch.resType!=='None'?' '+ch.resType:''); $('#inspectOverlay').classList.remove('hidden');}
$('#insClose').onclick=()=>$('#inspectOverlay').classList.add('hidden'); $('#inspectOverlay').addEventListener('click',e=>{if(e.target.id==='inspectOverlay')$('#inspectOverlay').classList.add('hidden')});

/* ---------- flow / wiring ---------- */
function showSelect(){ $('#selectScreen').classList.remove('hidden'); $('#selectToolbar').classList.remove('hidden'); $('#battleScreen').classList.add('hidden'); }
function showBattle(){ $('#selectScreen').classList.add('hidden'); $('#selectToolbar').classList.add('hidden'); $('#battleScreen').classList.remove('hidden'); }
$('#backToSelect').onclick=showSelect;
$('#btnTryAgain').onclick=()=>{ $('#endOverlay').classList.add('hidden'); showSelect(); };
$('#btnResetBattle').onclick=()=>{ $('#endOverlay').classList.add('hidden'); showSelect(); };

function startBattle(){ S.li=0; S.ri=0; S.turn='left'; S.items.left={potion:2,ether:2}; S.items.right={potion:2,ether:2}; renderAll(); showBattle(); logLine('Battle start! P1 to move.'); }
$('#startBattleTop').onclick=startBattle; $('#startBattleBottom').onclick=startBattle;
$('#itemPotion').onclick=()=>usePotion('left'); $('#itemEther').onclick=()=>useEther('left'); $('#btnSwap').onclick=()=>{const t=team('left'); const cur=S.li; const alt=[0,1,2].find(i=>i!==cur && t[i] && t[i].hp>0); if(alt!=null) trySwitch('left',alt);};
$('#resetBtn').onclick=()=>{showSelect();};
$('#p2ModeTop').onchange=e=>{S.p2=e.target.value; $('#p2ModeBadge').textContent=S.p2.toUpperCase();};
$('#shareBtn')?.addEventListener('click',async()=>{const l=S.left.map(c=>c?.data?.id||''); const r=S.right.map(c=>c?.data?.id||''); const u=new URL(location.href); u.search=new URLSearchParams({l:l.join(','),r:r.join(','),mode:S.p2}).toString(); try{await navigator.clipboard.writeText(u.toString()); alert('Link copied!');}catch{prompt('Copy link',u.toString());}});
['#randomBothTop','#randomBothBottom'].forEach(sel=>$(sel).onclick=()=>{randFill('left'); randFill('right');});
$('#clearPicks').onclick=()=>{S.left=[null,null,null]; S.right=[null,null,null]; renderPicks();};
$('#rosterSearch').oninput=(e)=>renderRoster(e.target.value);

function randFill(side){const arr=S.list.slice().sort(()=>Math.random()-.5).slice(0,3); Promise.all(arr.map(async c=>{const full=(await j(`${DDRAGON}/cdn/${S.version}/data/en_US/champion/${c.id}.json`)).data[c.id]; const st=buildChamp(full); const list=side==='left'?S.left:S.right; for(let i=0;i<3;i++){if(!list[i]){list[i]=st; break;}} })).then(renderPicks);}

(async function init(){
  try{
    S.version=(await j(`${DDRAGON}/api/versions.json`))[0];
    const short=await j(ddata(S.version,'champion.json')); S.champs=short.data; S.list=Object.values(S.champs).sort((a,b)=>a.name.localeCompare(b.name));
    renderRoster(); renderPicks(); showSelect(); // ensure toolbar visible initially
  }catch(err){console.error(err); alert('Failed to load LoL data.');}
})();
})();
</script>
</body>
</html>