<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jimmy‚Äôs LoL Duel</title>
  <!-- Tailwind CSS via CDN (mobile-first utilities) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Include Chart.js for radar charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <style>
    /* Custom CSS for animations (screen shake, hit flash, etc.) */
    @keyframes shake {
      0% { transform: translate(0, 0); }
      20% { transform: translate(-5px, 0); }
      40% { transform: translate(5px, 0); }
      60% { transform: translate(-5px, 0); }
      80% { transform: translate(5px, 0); }
      100% { transform: translate(0, 0); }
    }
    .shake {
      animation: shake 0.5s ease-in-out;
    }
    @keyframes hitflash {
      0%   { opacity: 0.8; }
      50%  { opacity: 0.0; }
      100% { opacity: 0.8; }
    }
    .hit-flash::after {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255, 0, 0, 0.5);
      animation: hitflash 0.3s 2;
      pointer-events: none;
    }
    .modal-bg {
      /* Modal background overlay */
      background: rgba(0, 0, 0, 0.8);
    }
    /* Victory/Defeat text style */
    .end-text {
      font-family: serif;
      text-shadow: 0 0 10px rgba(0,0,0,0.7);
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans">
  <!-- Main container -->
  <div id="app" class="min-h-screen flex flex-col">
    <!-- Selection Screen -->
    <div id="selection-screen" class="flex-1 flex flex-col p-4">
      <!-- Header with title and Start button -->
      <div class="flex items-center justify-between sticky top-0 bg-gray-900 py-2 z-10 border-b border-gray-700">
        <h1 class="text-lg font-bold">Pick Your Team (3 Champions)</h1>
        <button id="start-btn" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold py-1 px-3 rounded disabled:opacity-50 disabled:pointer-events-none">
          Start Battle
        </button>
      </div>
      <!-- Filter bar -->
      <div class="mt-2 flex flex-wrap gap-2 text-sm">
        <div class="flex items-center gap-1">
          <span>Role:</span>
          <select id="role-filter" class="bg-gray-800 text-gray-100 py-1 px-2 rounded">
            <option value="All">All</option>
            <option value="Fighter">Fighter</option>
            <option value="Assassin">Assassin</option>
            <option value="Mage">Mage</option>
            <option value="Marksman">Marksman</option>
            <option value="Tank">Tank</option>
            <option value="Support">Support</option>
          </select>
        </div>
        <div class="flex items-center gap-1">
          <span>Element:</span>
          <select id="element-filter" class="bg-gray-800 text-gray-100 py-1 px-2 rounded">
            <option value="All">All</option>
            <option value="Arcane">Arcane</option>
            <option value="Earth">Earth</option>
            <option value="Radiant">Radiant</option>
            <option value="Shadow">Shadow</option>
          </select>
        </div>
      </div>
      <!-- Champions Roster Grid -->
      <div id="champion-grid" class="mt-3 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3 overflow-y-auto">
        <!-- Champion cards will be injected here by JS -->
      </div>
    </div>

    <!-- Battle Screen (hidden until battle starts) -->
    <div id="battle-screen" class="flex-1 flex flex-col p-4 hidden">
      <!-- Top info bar: Field and Turn -->
      <div id="field-info" class="text-center mb-2">
        <!-- Field name and turns left -->
        <div id="field-text" class="text-sm"></div>
        <!-- Turn indicator -->
        <div id="turn-text" class="font-semibold"></div>
      </div>
      <!-- Battle arena (champion status panels) -->
      <div class="flex-1 relative">
        <!-- Opponent (CPU) champion panel - positioned at top -->
        <div id="cpu-panel" class="flex items-center mb-4">
          <img id="cpu-portrait" src="" alt="CPU Champ" class="w-12 h-12 rounded-full border-2 border-gray-500">
          <div class="ml-3 relative">
            <div id="cpu-name" class="font-bold text-base"></div>
            <div id="cpu-role" class="text-xs text-gray-300"></div>
            <div class="w-40 bg-gray-700 rounded h-3 mt-1">
              <div id="cpu-hp-bar" class="bg-red-600 h-3 rounded"></div>
            </div>
            <div class="w-40 bg-gray-700 rounded h-2 mt-1">
              <div id="cpu-mana-bar" class="bg-blue-600 h-2 rounded"></div>
            </div>
            <div id="cpu-hp-mp" class="text-xs mt-1"></div>
          </div>
        </div>
        <!-- Player (P1) champion panel - positioned at bottom -->
        <div id="player-panel" class="flex items-center absolute bottom-0">
          <img id="player-portrait" src="" alt="Player Champ" class="w-16 h-16 rounded-full border-2 border-gray-500">
          <div class="ml-3 relative">
            <div id="player-name" class="font-bold text-lg"></div>
            <div id="player-role" class="text-sm text-gray-300"></div>
            <div class="w-48 bg-gray-700 rounded h-4 mt-2">
              <div id="player-hp-bar" class="bg-red-600 h-4 rounded"></div>
            </div>
            <div class="w-48 bg-gray-700 rounded h-3 mt-1">
              <div id="player-mana-bar" class="bg-blue-600 h-3 rounded"></div>
            </div>
            <div id="player-hp-mp" class="text-sm mt-1"></div>
          </div>
        </div>
      </div>
      <!-- Abilities and Items bar -->
      <div id="controls" class="mt-3">
        <!-- Abilities -->
        <div id="ability-buttons" class="flex justify-center items-center gap-2">
          <!-- Buttons will be generated via JS -->
        </div>
        <!-- Items -->
        <div id="item-buttons" class="flex justify-center items-center gap-4 mt-2">
          <button id="use-potion" class="bg-green-700 hover:bg-green-800 text-white text-xs font-semibold py-1 px-2 rounded flex items-center gap-1 disabled:opacity-50">
            <span>üçµ Potion</span> <span id="potion-count"></span>
          </button>
          <button id="use-ether" class="bg-purple-700 hover:bg-purple-800 text-white text-xs font-semibold py-1 px-2 rounded flex items-center gap-1 disabled:opacity-50">
            <span>üîπ Ether</span> <span id="ether-count"></span>
          </button>
          <button id="switch-btn" class="bg-gray-600 hover:bg-gray-500 text-white text-xs font-semibold py-1 px-2 rounded">Switch</button>
        </div>
      </div>
      <!-- Battle log -->
      <div id="log" role="log" aria-label="Battle Log" class="mt-4 p-2 h-24 overflow-y-auto text-xs bg-gray-800 bg-opacity-50 rounded"></div>
    </div>

    <!-- Victory/Defeat End Screen Modal -->
    <div id="end-screen" class="fixed inset-0 hidden flex flex-col items-center justify-center modal-bg text-center p-4">
      <div id="end-message" class="text-5xl font-extrabold end-text mb-4"></div>
      <div class="flex gap-4">
        <button id="try-again-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Try Again</button>
        <button id="reset-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Reset Game</button>
      </div>
    </div>

    <!-- Champion Detail Modal (for info on long-press in selection) -->
    <div id="champion-modal" class="fixed inset-0 hidden modal-bg items-center justify-center p-4">
      <div class="relative bg-gray-900 bg-opacity-90 max-w-md w-full max-h-full overflow-y-auto rounded-lg p-4">
        <button id="modal-close" class="absolute top-2 right-2 text-gray-400 hover:text-gray-200">&times;</button>
        <div id="modal-content">
          <!-- Champion details (filled by JS when opened) -->
          <h2 id="modal-champ-name" class="text-2xl font-bold mb-2"></h2>
          <div id="modal-role-element" class="mb-2 text-gray-300"></div>
          <canvas id="stat-radar" width="300" height="300" class="mx-auto mb-4"></canvas>
          <div id="modal-skills" class="text-sm space-y-2"></div>
        </div>
      </div>
    </div>

    <!-- Sound and Music Toggle Buttons -->
    <div class="absolute top-2 right-2 flex flex-col gap-2">
      <button id="music-toggle" aria-pressed="false" aria-label="Toggle Music" class="bg-gray-800 bg-opacity-50 text-xl p-2 rounded">
        üéµ
      </button>
      <button id="sound-toggle" aria-pressed="false" aria-label="Toggle Sound Effects" class="bg-gray-800 bg-opacity-50 text-xl p-2 rounded">
        üîà
      </button>
    </div>
  </div>

  <!-- Audio elements -->
  <audio id="bg-music" src="" loop></audio>
  <audio id="sound-effect" src=""></audio>

<script>
/***** Game Data Setup *****/
// Define champion data (name, roles, element, base stats, skills)
const champions = [
  {
    name: "Annie",
    roles: ["Mage"],
    element: "Arcane",
    stats: { attack: 30, defense: 20, magic: 90, speed: 40, control: 70 },
    skills: {
      A: { name: "Basic Attack", desc: "Annie attacks with a fireball from her teddy bear Tibbers.", cost: 0 },
      Q: { name: "Disintegrate", desc: "Annie hurls a fireball that deals moderate damage.", cost: 50 },
      W: { name: "Incinerate", desc: "Annie scorches enemies in a cone (single target here).", cost: 70 },
      E: { name: "Molten Shield", desc: "Annie shields herself (in duel, minor damage move).", cost: 40 },
      R: { name: "Summon Tibbers", desc: "Annie releases Tibbers for a massive attack.", cost: 100 }
    }
  },
  {
    name: "Rell",
    roles: ["Tank","Support"],
    element: "Earth",
    stats: { attack: 50, defense: 90, magic: 30, speed: 20, control: 80 },
    skills: {
      A: { name: "Basic Attack", desc: "Rell strikes with her lance.", cost: 0 },
      Q: { name: "Shattering Strike", desc: "Rell pierces through magic, dealing damage.", cost: 50 },
      W: { name: "Ferromancy", desc: "Rell slams down, creating shockwaves.", cost: 60 },
      E: { name: "Attract and Repel", desc: "Rell binds and stuns an enemy (damage here).", cost: 40 },
      R: { name: "Magnet Storm", desc: "Rell pulls enemies in with a magnetic burst.", cost: 100 }
    }
  },
  {
    name: "Renata Glasc",
    roles: ["Support","Mage"],
    element: "Arcane",
    stats: { attack: 40, defense: 40, magic: 80, speed: 30, control: 60 },
    skills: {
      A: { name: "Basic Attack", desc: "Renata fires a basic chemshot.", cost: 0 },
      Q: { name: "Handshake", desc: "Renata launches a missile that damages and can throw an enemy.", cost: 60 },
      W: { name: "Bailout", desc: "Renata grants an ally (herself) attack speed (damage move in duel).", cost: 70 },
      E: { name: "Loyalty Program", desc: "Renata sends out chemtech waves damaging enemies.", cost: 50 },
      R: { name: "Hostile Takeover", desc: "Renata releases a cloud that enrages enemies (heavy damage here).", cost: 100 }
    }
  },
  {
    name: "Aatrox",
    roles: ["Fighter","Tank"],
    element: "Shadow",
    stats: { attack: 85, defense: 70, magic: 20, speed: 50, control: 40 },
    skills: {
      A: { name: "Basic Attack", desc: "Aatrox swings his greatsword.", cost: 0 },
      Q: { name: "Darkin Blade", desc: "Aatrox slams down his sword, dealing damage.", cost: 30 },
      W: { name: "Infernal Chains", desc: "Aatrox smashes chains, damaging the foe.", cost: 40 },
      E: { name: "Umbral Dash", desc: "Aatrox dashes (in duel, a quick strike).", cost: 25 },
      R: { name: "World Ender", desc: "Aatrox unleashes his full power (big damage).", cost: 100 }
    }
  },
  {
    name: "Aurelion Sol",
    roles: ["Mage"],
    element: "Arcane",
    stats: { attack: 20, defense: 30, magic: 95, speed: 35, control: 50 },
    skills: {
      A: { name: "Basic Attack", desc: "Aurelion Sol fires a star fragment.", cost: 0 },
      Q: { name: "Starsurge", desc: "Aurelion creates an expanding star that explodes.", cost: 60 },
      W: { name: "Celestial Expansion", desc: "A.Sol expands his stars (damage).", cost: 70 },
      E: { name: "Comet of Legend", desc: "A.Sol takes flight (no effect in duel).", cost: 30 },
      R: { name: "Voice of Light", desc: "Aurelion Sol breathes starfire in a line (heavy damage).", cost: 100 }
    }
  },
  {
    name: "Xin Zhao",
    roles: ["Fighter","Assassin"],
    element: "Earth",
    stats: { attack: 75, defense: 60, magic: 25, speed: 60, control: 30 },
    skills: {
      A: { name: "Basic Attack", desc: "Xin Zhao thrusts his spear.", cost: 0 },
      Q: { name: "Three Talon Strike", desc: "Three swift strikes with increased damage.", cost: 40 },
      W: { name: "Wind Becomes Lightning", desc: "Xin slashes then thrusts, damaging foes.", cost: 50 },
      E: { name: "Audacious Charge", desc: "Xin Zhao leaps and deals damage (single target).", cost: 50 },
      R: { name: "Crescent Guard", desc: "Xin Zhao sweeps enemies around him (big hit here).", cost: 100 }
    }
  },
  {
    name: "Cassiopeia",
    roles: ["Mage"],
    element: "Shadow",
    stats: { attack: 35, defense: 30, magic: 85, speed: 55, control: 75 },
    skills: {
      A: { name: "Basic Attack", desc: "Cassiopeia bites with venom (basic).", cost: 0 },
      Q: { name: "Noxious Blast", desc: "Cassiopeia erupts a poison blast under the enemy.", cost: 50 },
      W: { name: "Miasma", desc: "Cassiopeia spreads poison in an area (single target damage).", cost: 70 },
      E: { name: "Twin Fang", desc: "Cassiopeia rapidly strikes with fangs (low cooldown).", cost: 30 },
      R: { name: "Petrifying Gaze", desc: "Cassiopeia‚Äôs glare deals massive damage (no stun in duel).", cost: 100 }
    }
  },
  {
    name: "Fiora",
    roles: ["Fighter","Assassin"],
    element: "Earth",
    stats: { attack: 90, defense: 50, magic: 20, speed: 80, control: 40 },
    skills: {
      A: { name: "Basic Attack", desc: "Fiora strikes with her sword.", cost: 0 },
      Q: { name: "Lunge", desc: "Fiora lunges to strike the opponent quickly.", cost: 50 },
      W: { name: "Riposte", desc: "Fiora parries and hits back (damage in duel).", cost: 60 },
      E: { name: "Bladework", desc: "Fiora slashes in quick succession.", cost: 40 },
      R: { name: "Grand Challenge", desc: "Fiora marks vital points and strikes (heavy dmg).", cost: 100 }
    }
  },
  {
    name: "Camille",
    roles: ["Fighter","Assassin"],
    element: "Earth",
    stats: { attack: 80, defense: 55, magic: 25, speed: 70, control: 50 },
    skills: {
      A: { name: "Basic Attack", desc: "Camille slashes with her leg blades.", cost: 0 },
      Q: { name: "Precision Protocol", desc: "Camille‚Äôs next attack deals bonus damage.", cost: 30 },
      W: { name: "Tactical Sweep", desc: "Camille sweeps a leg dealing damage.", cost: 50 },
      E: { name: "Hookshot", desc: "Camille dashes in (damage in duel).", cost: 40 },
      R: { name: "The Hextech Ultimatum", desc: "Camille leaps and deals massive damage.", cost: 100 }
    }
  },
  {
    name: "Katarina",
    roles: ["Assassin","Mage"],
    element: "Arcane",
    stats: { attack: 60, defense: 40, magic: 70, speed: 75, control: 20 },
    skills: {
      A: { name: "Basic Attack", desc: "Katarina throws a dagger on basic attack.", cost: 0 },
      Q: { name: "Bouncing Blade", desc: "Kat throws a blade that ricochets (single target here).", cost: 50 },
      W: { name: "Preparation", desc: "Katarina gains speed (minor damage effect).", cost: 40 },
      E: { name: "Shunpo", desc: "Katarina blinks to the enemy and strikes.", cost: 30 },
      R: { name: "Death Lotus", desc: "Katarina spins, throwing daggers (big damage to one).", cost: 100 }
    }
  },
  {
    name: "Cho'Gath",
    roles: ["Tank","Mage"],
    element: "Arcane",
    stats: { attack: 70, defense: 80, magic: 50, speed: 25, control: 60 },
    skills: {
      A: { name: "Basic Attack", desc: "Cho'Gath claws the enemy.", cost: 0 },
      Q: { name: "Rupture", desc: "Cho'Gath ruptures the ground under the foe.", cost: 60 },
      W: { name: "Feral Scream", desc: "Cho'Gath unleashes a scream (single target damage).", cost: 70 },
      E: { name: "Vorpal Spikes", desc: "Cho'Gath‚Äôs attacks launch spikes (damage).", cost: 0 },
      R: { name: "Feast", desc: "Cho'Gath attempts to devour the enemy (huge damage).", cost: 100 }
    }
  }
];
// Some default CPU team selection (optional, if we want a fixed CPU lineup or random)
let cpuTeam = [];

/***** Game State Variables *****/
let playerTeam = [];        // array of selected champions for player
let playerActiveIndex = 0;  // index of current active champion in playerTeam
let cpuActiveIndex = 0;     // index for CPU active champ
let turn = 'P1';            // 'P1' or 'P2' to indicate whose turn
let fieldElement = null;    // current field element (string)
let fieldTurnsLeft = 0;
let potionCount = 2;
let etherCount = 2;
let battleActive = false;
let gameOver = false;

/***** UI Element References *****/
const selectionScreen = document.getElementById('selection-screen');
const battleScreen = document.getElementById('battle-screen');
const startBtn = document.getElementById('start-btn');
const championGrid = document.getElementById('champion-grid');
const roleFilter = document.getElementById('role-filter');
const elementFilter = document.getElementById('element-filter');

const fieldText = document.getElementById('field-text');
const turnText = document.getElementById('turn-text');
const cpuPanel = document.getElementById('cpu-panel');
const playerPanel = document.getElementById('player-panel');
const cpuPortrait = document.getElementById('cpu-portrait');
const playerPortrait = document.getElementById('player-portrait');
const cpuNameEl = document.getElementById('cpu-name');
const playerNameEl = document.getElementById('player-name');
const cpuRoleEl = document.getElementById('cpu-role');
const playerRoleEl = document.getElementById('player-role');
const cpuHPBar = document.getElementById('cpu-hp-bar');
const playerHPBar = document.getElementById('player-hp-bar');
const cpuManaBar = document.getElementById('cpu-mana-bar');
const playerManaBar = document.getElementById('player-mana-bar');
const cpuHPMPText = document.getElementById('cpu-hp-mp');
const playerHPMPText = document.getElementById('player-hp-mp');

const abilityButtonsDiv = document.getElementById('ability-buttons');
const usePotionBtn = document.getElementById('use-potion');
const useEtherBtn = document.getElementById('use-ether');
const potionCountSpan = document.getElementById('potion-count');
const etherCountSpan = document.getElementById('ether-count');
const switchBtn = document.getElementById('switch-btn');
const logDiv = document.getElementById('log');

const endScreen = document.getElementById('end-screen');
const endMessage = document.getElementById('end-message');
const tryAgainBtn = document.getElementById('try-again-btn');
const resetBtn = document.getElementById('reset-btn');

const championModal = document.getElementById('champion-modal');
const modalContent = document.getElementById('modal-content');
const modalChampName = document.getElementById('modal-champ-name');
const modalRoleElem = document.getElementById('modal-role-element');
const statRadarCanvas = document.getElementById('stat-radar');
const modalSkillsDiv = document.getElementById('modal-skills');
const modalCloseBtn = document.getElementById('modal-close');

const musicToggle = document.getElementById('music-toggle');
const soundToggle = document.getElementById('sound-toggle');
const bgMusic = document.getElementById('bg-music');
const soundEffect = document.getElementById('sound-effect');

/***** Helper Functions *****/
function updateStartButton() {
  // Enable start when 3 champions selected
  startBtn.disabled = (playerTeam.length !== 3);
}
function renderChampionGrid() {
  // Clear existing
  championGrid.innerHTML = '';
  // Get filter criteria
  const roleVal = roleFilter.value;
  const elemVal = elementFilter.value;
  champions.forEach(champ => {
    // Check filters:
    if ((roleVal === 'All' || champ.roles.includes(roleVal)) &&
        (elemVal === 'All' || champ.element === elemVal)) {
      // Create card
      const card = document.createElement('div');
      card.className = 'champ-card relative cursor-pointer text-center p-2 bg-gray-800 bg-opacity-50 rounded hover:bg-opacity-75';
      // Champion icon (using Data Dragon if available)
      const imgName = champ.name.replace(/[^a-zA-Z0-9]/g, ""); // remove apostrophes/spaces for URL
      const img = document.createElement('img');
      img.src = `https://ddragon.leagueoflegends.com/cdn/15.16.1/img/champion/${imgName}.png`;
      img.alt = champ.name;
      img.className = 'mx-auto mb-1 w-16 h-16 object-cover rounded-full';
      card.appendChild(img);
      // Name label
      const nameLbl = document.createElement('div');
      nameLbl.textContent = champ.name;
      nameLbl.className = 'text-sm';
      card.appendChild(nameLbl);
      // Selection number badge (if selected)
      const badge = document.createElement('div');
      badge.className = 'selection-badge absolute top-1 right-1 bg-blue-600 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center';
      badge.style.display = 'none';
      card.appendChild(badge);
      // Click event: select or open modal if already selected 3?
      card.addEventListener('click', () => {
        if (playerTeam.length < 3 && !playerTeam.includes(champ)) {
          // Select champion for team
          playerTeam.push(champ);
          badge.textContent = playerTeam.length; // assign number
          badge.style.display = 'flex';
          updateStartButton();
        } else if (playerTeam.includes(champ)) {
          // If already selected (maybe allow deselect on second tap)
          const idx = playerTeam.indexOf(champ);
          if (idx !== -1) {
            playerTeam.splice(idx, 1);
            badge.style.display = 'none';
            // Update other badges numbering
            document.querySelectorAll('.selection-badge').forEach(b=> {
              if(b.textContent) {
                const num = parseInt(b.textContent);
                if(num > idx+1) { // idx+1 because team length was one less
                  b.textContent = num-1;
                }
              }
            });
            updateStartButton();
          }
        } else {
          // If team is full and champ not selected, maybe ignore or show modal
          openChampionModal(champ);
        }
      });
      // Long press (touch) or right-click for info modal
      card.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        openChampionModal(champ);
      });
      card.addEventListener('touchstart', function(e) {
        this._touchStart = Date.now();
      });
      card.addEventListener('touchend', function(e) {
        if (Date.now() - this._touchStart > 500) {
          openChampionModal(champ);
        }
      });
      championGrid.appendChild(card);
    }
  });
}
function openChampionModal(champ) {
  // Populate champ info in modal and show it
  modalChampName.textContent = champ.name;
  modalRoleElem.textContent = `${champ.roles.join('/')} ‚Äì ${champ.element}`;
  // Radar chart:
  const statData = champ.stats;
  if(window.modalChart) {
    window.modalChart.destroy();
  }
  window.modalChart = new Chart(statRadarCanvas.getContext('2d'), {
    type: 'radar',
    data: {
      labels: ['Attack','Defense','Magic','Speed','Control'],
      datasets: [{
        label: champ.name + " Stats",
        data: [statData.attack, statData.defense, statData.magic, statData.speed, statData.control],
        backgroundColor: 'rgba(255, 255, 255, 0.2)',
        borderColor: '#ffffff',
        borderWidth: 1,
        pointBackgroundColor: '#ffffff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { r: { beginAtZero: true, max: 100, ticks: { display: false } } },
      plugins: { legend: { display: false } }
    }
  });
  // Skills list
  modalSkillsDiv.innerHTML = '';
  for(let key in champ.skills) {
    const skill = champ.skills[key];
    const skillEl = document.createElement('div');
    skillEl.innerHTML = `<strong>${key} ‚Äì ${skill.name}</strong> (${skill.cost} mana): ${skill.desc}`;
    modalSkillsDiv.appendChild(skillEl);
  }
  championModal.classList.remove('hidden');
  championModal.classList.add('flex');
}
function closeChampionModal() {
  championModal.classList.add('hidden');
  championModal.classList.remove('flex');
}
// Utility to log messages to the battle log
function log(msg) {
  const entry = document.createElement('div');
  entry.textContent = "‚û§ " + msg;
  logDiv.appendChild(entry);
  logDiv.scrollTop = logDiv.scrollHeight;
}
/***** Battle Logic Functions *****/
function startBattle() {
  // Prepare teams and UI for battle
  if (playerTeam.length !== 3) return;
  // If CPU team not pre-chosen, choose 3 random distinct champs for CPU
  if (cpuTeam.length !== 3) {
    cpuTeam = [];
    // simple random pick distinct
    const available = champions.slice();
    // remove player's picks from available to avoid duplicates (optional)
    // available = available.filter(champ => !playerTeam.includes(champ));
    while(cpuTeam.length < 3 && available.length > 0) {
      const randIndex = Math.floor(Math.random() * available.length);
      const pick = available.splice(randIndex, 1)[0];
      // avoid picking same as player's maybe:
      // if (!playerTeam.includes(pick)) {
        cpuTeam.push(pick);
      // }
    }
  }
  playerActiveIndex = 0;
  cpuActiveIndex = 0;
  turn = 'P1';  // player starts (could incorporate speed check)
  gameOver = false;
  potionCount = 2;
  etherCount = 2;
  // Determine field element at start
  const elements = ["Arcane","Earth","Radiant","Shadow"];
  fieldElement = elements[Math.floor(Math.random()*elements.length)];
  fieldTurnsLeft = 5;
  // Update UI initial state
  selectionScreen.classList.add('hidden');
  battleScreen.classList.remove('hidden');
  // load initial champs
  loadChampionData();
  updateFieldTurnUI();
  updateAbilityButtons();
  updateItemsUI();
  logDiv.innerHTML = "";  // clear log
  log("Battle start! Field is " + fieldElement + ".");
  // Possibly auto-play background music if provided
  if(bgMusic.src) { bgMusic.play().catch(()=>{}); }
  battleActive = true;
}
function loadChampionData() {
  // Load current active champion info into UI for both player and cpu
  const playerChamp = playerTeam[playerActiveIndex];
  const cpuChamp = cpuTeam[cpuActiveIndex];
  // Portraits
  const pImgName = playerChamp.name.replace(/[^a-zA-Z0-9]/g,"");
  const cImgName = cpuChamp.name.replace(/[^a-zA-Z0-9]/g,"");
  playerPortrait.src = `https://ddragon.leagueoflegends.com/cdn/15.16.1/img/champion/${pImgName}.png`;
  cpuPortrait.src = `https://ddragon.leagueoflegends.com/cdn/15.16.1/img/champion/${cImgName}.png`;
  playerNameEl.textContent = playerChamp.name;
  cpuNameEl.textContent = cpuChamp.name;
  playerRoleEl.textContent = `${playerChamp.roles.join('/')} ¬∑ ${playerChamp.element}`;
  cpuRoleEl.textContent = `${cpuChamp.roles.join('/')} ¬∑ ${cpuChamp.element}`;
  // Initialize HP and Mana
  playerChamp.currentHP = playerChamp.currentHP ?? (200 + playerChamp.stats.defense); // base HP perhaps derived from defense
  playerChamp.maxHP = playerChamp.currentHP;
  playerChamp.currentMP = playerChamp.currentMP ?? 100;
  playerChamp.maxMP = playerChamp.currentMP;
  cpuChamp.currentHP = cpuChamp.currentHP ?? (200 + cpuChamp.stats.defense);
  cpuChamp.maxHP = cpuChamp.currentHP;
  cpuChamp.currentMP = cpuChamp.currentMP ?? 100;
  cpuChamp.maxMP = cpuChamp.currentMP;
  updateHPMPUI();
}
function updateHPMPUI() {
  // Update health/mana bars and text for current active champs
  const pChamp = playerTeam[playerActiveIndex];
  const cChamp = cpuTeam[cpuActiveIndex];
  // Clamp values (just in case)
  if(pChamp.currentHP < 0) pChamp.currentHP = 0;
  if(cChamp.currentHP < 0) cChamp.currentHP = 0;
  if(pChamp.currentMP < 0) pChamp.currentMP = 0;
  if(cChamp.currentMP < 0) cChamp.currentMP = 0;
  playerHPBar.style.width = (pChamp.currentHP / pChamp.maxHP * 100) + "%";
  cpuHPBar.style.width = (cChamp.currentHP / cChamp.maxHP * 100) + "%";
  playerManaBar.style.width = (pChamp.currentMP / pChamp.maxMP * 100) + "%";
  cpuManaBar.style.width = (cChamp.currentMP / cChamp.maxMP * 100) + "%";
  playerHPMPText.textContent = `HP ${pChamp.currentHP}/${pChamp.maxHP}  MP ${pChamp.currentMP}/${pChamp.maxMP}`;
  cpuHPMPText.textContent = `HP ${cChamp.currentHP}/${cChamp.maxHP}  MP ${cChamp.currentMP}/${cChamp.maxMP}`;
}
function updateFieldTurnUI() {
  fieldText.textContent = `Field: ${fieldElement} (${fieldTurnsLeft} turns left)`;
  turnText.textContent = turn === 'P1' ? "Your Turn" : "Enemy Turn";
}
function updateAbilityButtons() {
  // Create or update ability buttons for player's current champ
  const champ = playerTeam[playerActiveIndex];
  abilityButtonsDiv.innerHTML = '';
  const abilities = champ.skills;
  for(let key of ["A","Q","W","E","R"]) {
    const skill = abilities[key];
    const btn = document.createElement('button');
    btn.className = `ability-btn relative w-12 h-12 text-xs rounded-full border-2 ${key==='A'?'border-gray-500':'border-blue-500'} flex items-center justify-center`;
    btn.title = `${skill.name} (${skill.cost} MP): ${skill.desc}`;
    btn.textContent = key;
    // Show mana cost as tiny text in corner
    if(skill.cost > 0) {
      const costLabel = document.createElement('span');
      costLabel.textContent = skill.cost;
      costLabel.className = "absolute bottom-0 right-0 text-[10px] text-blue-200";
      btn.appendChild(costLabel);
    }
    // Click event for ability
    btn.addEventListener('click', () => {
      if(turn !== 'P1' || gameOver) return;
      // Check mana
      if(skill.cost > champ.currentMP) {
        log("Not enough mana for " + skill.name + "!");
        return;
      }
      executePlayerAction(key);
    });
    abilityButtonsDiv.appendChild(btn);
  }
}
function updateItemsUI() {
  // Update item counts and disable if none or if conditions
  potionCountSpan.textContent = `x${potionCount}`;
  etherCountSpan.textContent = `x${etherCount}`;
  usePotionBtn.disabled = (potionCount <= 0 || turn !== 'P1' || gameOver);
  useEtherBtn.disabled = (etherCount <= 0 || turn !== 'P1' || gameOver);
  switchBtn.disabled = (turn !== 'P1' || gameOver);
}
function executePlayerAction(actionKey) {
  const champ = playerTeam[playerActiveIndex];
  const enemy = cpuTeam[cpuActiveIndex];
  if(gameOver) return;
  // Determine action type
  if(actionKey === 'usePotion') {
    // Use potion on player champ
    potionCount--;
    const healAmt = Math.min(champ.maxHP - champ.currentHP, 100);
    champ.currentHP += healAmt;
    log(`${champ.name} used a Potion and healed ${healAmt} HP.`);
    updateHPMPUI();
    // Play healing sound perhaps
  } else if(actionKey === 'useEther') {
    etherCount--;
    const restoreAmt = Math.min(champ.maxMP - champ.currentMP, 50);
    champ.currentMP += restoreAmt;
    log(`${champ.name} used an Ether and restored ${restoreAmt} MP.`);
    updateHPMPUI();
  } else if(actionKey === 'switch') {
    // Switch to next champion in team (if available)
    playerActiveIndex = (playerActiveIndex + 1) % playerTeam.length;
    const newChamp = playerTeam[playerActiveIndex];
    log(`You switched to ${newChamp.name}!`);
    // Reload UI with new champion
    loadChampionData();
    updateAbilityButtons();
  } else {
    // It is a skill use (attack)
    const skill = champ.skills[actionKey];
    // Deduct mana
    if(skill.cost > 0) {
      champ.currentMP -= skill.cost;
    }
    // Calculate base damage
    let baseDmg;
    if(actionKey === 'A') {
      baseDmg = 20 + champ.stats.attack * 0.5; // some base for basic attack
    } else {
      baseDmg = 30 + champ.stats.magic * 0.4; // base for spells
      if(actionKey === 'R') baseDmg += 20; // ult slightly stronger
    }
    // Elemental multiplier
    let dmgMultiplier = 1;
    // Simple type chart: Arcane > Earth, Earth > Radiant, Radiant > Shadow, Shadow > Arcane
    const strongAgainst = {
      "Arcane": "Earth",
      "Earth": "Radiant",
      "Radiant": "Shadow",
      "Shadow": "Arcane"
    };
    if(strongAgainst[champ.element] === enemy.element) {
      dmgMultiplier = 2.0;
    } else if(strongAgainst[enemy.element] === champ.element) {
      dmgMultiplier = 0.5;
    }
    // Field effect: if field matches champ element, maybe boost damage
    if(champ.element === fieldElement) {
      dmgMultiplier *= 1.2; // slight boost
    }
    // Final damage calc with defense factored
    const offenseStat = (actionKey === 'A') ? champ.stats.attack : champ.stats.magic;
    const defenseStat = enemy.stats.defense;
    let damage = baseDmg * (offenseStat / (defenseStat || 50)) * dmgMultiplier;
    damage = Math.round(damage);
    enemy.currentHP -= damage;
    log(`${champ.name} used ${skill.name} on ${enemy.name}, dealing ${damage} damage!`);
    // Visual feedback: shake enemy panel and flash
    cpuPanel.classList.add('shake');
    setTimeout(() => cpuPanel.classList.remove('shake'), 500);
    cpuPanel.classList.add('hit-flash');
    setTimeout(() => cpuPanel.classList.remove('hit-flash'), 300);
    // Play attack sound via soundEffect if enabled (if we had different sounds per ability, we'd assign source accordingly)
    if(soundToggle.getAttribute('aria-pressed') === 'false') {
      soundEffect.src = ""; // could set to specific sound file
      // soundEffect.play(); (assuming a sound file is set)
    }
    updateHPMPUI();
    // Check if enemy died
    if(enemy.currentHP <= 0) {
      log(`${enemy.name} is defeated!`);
      // if CPU champ dies, maybe switch to next if available
      if(cpuActiveIndex < cpuTeam.length - 1) {
        cpuActiveIndex++;
        const nextChamp = cpuTeam[cpuActiveIndex];
        log(`Enemy sends out ${nextChamp.name}!`);
        loadChampionData(); // load new CPU champ
      } else {
        // All enemy champs defeated
        endBattle(true);
        return;
      }
    }
  }
  // After player's action, update UI
  updateHPMPUI();
  updateItemsUI();
  // End player turn, now CPU turn
  turn = 'P2';
  updateFieldTurnUI();
  // If field duration ends, rotate field element
  fieldTurnsLeft--;
  if(fieldTurnsLeft <= 0) {
    // rotate field to next element for fun
    const order = ["Arcane","Earth","Radiant","Shadow"];
    fieldElement = order[(order.indexOf(fieldElement)+1) % order.length];
    fieldTurnsLeft = 5;
    log(`The field changes to ${fieldElement}!`);
  }
  // Disable player controls during CPU turn
  abilityButtonsDiv.classList.add('opacity-50', 'pointer-events-none');
  // Execute CPU action after a short delay for pacing
  setTimeout(cpuAction, 800);
}
function cpuAction() {
  if(gameOver) return;
  const enemyChamp = cpuTeam[cpuActiveIndex];
  const playerChamp = playerTeam[playerActiveIndex];
  // Simple AI: if low HP and has potion, 1/2 chance to use it, else if enough mana for R then sometimes use R, else random ability
  if(enemyChamp.currentHP < 50 && potionCount > 0 && Math.random() < 0.5) {
    // CPU uses potion on itself if it had (we could track CPU potions too; assume CPU has 2 of each as well)
    // For simplicity, mirror player's count for CPU
    potionCount--;
    const healAmt = Math.min(enemyChamp.maxHP - enemyChamp.currentHP, 100);
    enemyChamp.currentHP += healAmt;
    log(`${enemyChamp.name} (CPU) used a Potion and healed ${healAmt} HP.`);
  } else {
    // Choose an ability to use
    let possibleMoves = ["A","Q","W","E","R"];
    // Filter moves CPU can pay mana for
    possibleMoves = possibleMoves.filter(m => enemyChamp.skills[m] && enemyChamp.skills[m].cost <= enemyChamp.currentMP);
    if(possibleMoves.length === 0) {
      possibleMoves = ["A"]; // if out of mana, will basic attack
    }
    // Prefer R if available (burst), else random
    let move = "A";
    if(possibleMoves.includes("R") && Math.random() < 0.7) {
      move = "R";
    } else {
      move = possibleMoves[Math.floor(Math.random()*possibleMoves.length)];
    }
    const skill = enemyChamp.skills[move];
    // Deduct mana for CPU
    if(skill.cost > 0) {
      enemyChamp.currentMP -= skill.cost;
    }
    // Calculate damage similar to player
    let baseDmg;
    if(move === 'A') {
      baseDmg = 20 + enemyChamp.stats.attack * 0.5;
    } else {
      baseDmg = 30 + enemyChamp.stats.magic * 0.4;
      if(move === 'R') baseDmg += 20;
    }
    let dmgMultiplier = 1;
    const strongAgainst = {
      "Arcane": "Earth",
      "Earth": "Radiant",
      "Radiant": "Shadow",
      "Shadow": "Arcane"
    };
    if(strongAgainst[enemyChamp.element] === playerChamp.element) {
      dmgMultiplier = 2.0;
    } else if(strongAgainst[playerChamp.element] === enemyChamp.element) {
      dmgMultiplier = 0.5;
    }
    if(enemyChamp.element === fieldElement) {
      dmgMultiplier *= 1.2;
    }
    const offenseStat = (move === 'A') ? enemyChamp.stats.attack : enemyChamp.stats.magic;
    const defenseStat = playerChamp.stats.defense;
    let damage = baseDmg * (offenseStat / (defenseStat||50)) * dmgMultiplier;
    damage = Math.round(damage);
    playerChamp.currentHP -= damage;
    log(`${enemyChamp.name} used ${skill.name} on ${playerChamp.name}, dealing ${damage} damage!`);
    // Visual feedback: shake player panel
    playerPanel.classList.add('shake');
    setTimeout(() => playerPanel.classList.remove('shake'), 500);
    playerPanel.classList.add('hit-flash');
    setTimeout(() => playerPanel.classList.remove('hit-flash'), 300);
    // Play sound effect if on
    if(soundToggle.getAttribute('aria-pressed') === 'false') {
      soundEffect.src = ""; // set CPU attack sound if any
      // soundEffect.play();
    }
  }
  // Update UI after CPU action
  updateHPMPUI();
  // Check if player champ died
  if(playerTeam[playerActiveIndex].currentHP <= 0) {
    const defeatedChamp = playerTeam[playerActiveIndex];
    log(`${defeatedChamp.name} has been defeated!`);
    if(playerActiveIndex < playerTeam.length - 1) {
      // switch to next alive champion automatically
      playerActiveIndex++;
      const nextChamp = playerTeam[playerActiveIndex];
      log(`${nextChamp.name} enters the battle!`);
      loadChampionData();
      updateAbilityButtons();
    } else {
      // All player champs defeated
      endBattle(false);
      return;
    }
  }
  // Switch back to player turn
  turn = 'P1';
  // Possibly decrement field turns, and update field if needed (we did in player action to avoid double decrement per round).
  updateFieldTurnUI();
  updateItemsUI();
  // Re-enable player controls
  abilityButtonsDiv.classList.remove('opacity-50', 'pointer-events-none');
}
function endBattle(playerWon) {
  gameOver = true;
  battleActive = false;
  // Stop background music if any
  if(bgMusic.src) { bgMusic.pause(); bgMusic.currentTime = 0; }
  // Show end screen overlay
  endMessage.textContent = playerWon ? "Victory" : "Defeat";
  endMessage.style.color = playerWon ? "#ffd700" : "#ff4f4f"; // gold for victory, red for defeat
  endScreen.classList.remove('hidden');
  // Optionally, set a background image for end screen (using winner champ's splash art)
  let splashChampion = playerWon ? playerTeam[playerActiveIndex] : cpuTeam[cpuActiveIndex];
  if(splashChampion) {
    let splashName = splashChampion.name.replace(/[^a-zA-Z0-9]/g,"");
    endScreen.style.background = `rgba(0,0,0,0.8) url('https://ddragon.leagueoflegends.com/cdn/img/champion/splash/${splashName}_0.jpg') center/cover`;
  }
}
function resetGame() {
  // Reset to selection screen for a new game
  battleScreen.classList.add('hidden');
  selectionScreen.classList.remove('hidden');
  endScreen.classList.add('hidden');
  playerTeam = [];
  cpuTeam = [];
  updateStartButton();
  renderChampionGrid();
  // Reset any persistent data
  logDiv.innerHTML = "";
}

/***** Event Listeners *****/
// Start battle button
startBtn.addEventListener('click', startBattle);
// Filters
roleFilter.addEventListener('change', renderChampionGrid);
elementFilter.addEventListener('change', renderChampionGrid);
// Ability usage and item usage
usePotionBtn.addEventListener('click', () => {
  if(turn === 'P1') {
    executePlayerAction('usePotion');
    endTurnAndContinue();
  }
});
useEtherBtn.addEventListener('click', () => {
  if(turn === 'P1') {
    executePlayerAction('useEther');
    endTurnAndContinue();
  }
});
switchBtn.addEventListener('click', () => {
  if(turn === 'P1') {
    executePlayerAction('switch');
    endTurnAndContinue();
  }
});
// End screen buttons
tryAgainBtn.addEventListener('click', () => {
  // Hide end screen and restart battle with same teams
  endScreen.classList.add('hidden');
  // Reset health/mana for another round with same champs
  playerTeam.forEach(ch => { ch.currentHP = ch.maxHP; ch.currentMP = ch.maxMP; });
  cpuTeam.forEach(ch => { ch.currentHP = ch.maxHP; ch.currentMP = ch.maxMP; });
  playerActiveIndex = 0;
  cpuActiveIndex = 0;
  gameOver = false;
  fieldTurnsLeft = 5;
  // Possibly randomize field again
  const elements = ["Arcane","Earth","Radiant","Shadow"];
  fieldElement = elements[Math.floor(Math.random()*elements.length)];
  selectionScreen.classList.add('hidden');
  battleScreen.classList.remove('hidden');
  loadChampionData();
  updateAbilityButtons();
  updateItemsUI();
  turn = 'P1';
  updateFieldTurnUI();
  logDiv.innerHTML = "";
  log("Battle restarted! Field is " + fieldElement + ".");
  if(bgMusic.src) { bgMusic.play().catch(()=>{}); }
});
resetBtn.addEventListener('click', () => {
  endScreen.classList.add('hidden');
  resetGame();
});
// Champion modal close
modalCloseBtn.addEventListener('click', closeChampionModal);
championModal.addEventListener('click', (e) => {
  if(e.target === championModal) { // clicking outside content
    closeChampionModal();
  }
});
// Sound toggles
musicToggle.addEventListener('click', () => {
  const isOn = musicToggle.getAttribute('aria-pressed') === 'false';
  // Toggle state
  musicToggle.setAttribute('aria-pressed', isOn ? 'true' : 'false');
  musicToggle.textContent = isOn ? 'üîá' : 'üéµ';
  if(isOn) {
    // Turn music off
    bgMusic.pause();
  } else {
    // Turn music on (if src is set, play it)
    bgMusic.play().catch(()=>{});
  }
});
soundToggle.addEventListener('click', () => {
  const isOn = soundToggle.getAttribute('aria-pressed') === 'false';
  soundToggle.setAttribute('aria-pressed', isOn ? 'true' : 'false');
  soundToggle.textContent = isOn ? 'üîá' : 'üîà';
  // We interpret aria-pressed true as "muted" for SFX
  // If turning sound off, just mute the soundEffect element
  soundEffect.muted = isOn;
});
// Start by rendering champion grid
renderChampionGrid();
// Initially, background music and sound effect src can be set if available
// Example: bgMusic.src = "path/to/music.mp3"; 
</script>
</body>
</html>
